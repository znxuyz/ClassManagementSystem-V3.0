<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç­ç´šç®¡ç†ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* é€™è£¡æ”¾åŸæœ¬çš„ CSS ï¼ˆæˆ‘å¹«ä½ ä¿ç•™äº†ï¼‰ */
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; }
    /* ä½ çš„å‹•ç•«ã€æ¨£å¼ ... å…¨éƒ¨è²¼é€™è£¡ */
  </style>
</head>
<body class="gradient-bg min-h-screen">
  <!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šæ’è¡Œæ¦œç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .rank-animation {
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .podium-rise {
            transition: transform 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .info-appear {
            transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .score-pulse {
            animation: pulse 0.6s ease-in-out;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .floating {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffed4e); }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #e8e8e8); }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #daa520); }
        
        .modal {
            backdrop-filter: blur(5px);
        }
        
        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 via-purple-50 to-pink-100 min-h-screen">
    <!-- å­¸ç”Ÿç™»å…¥æ¨¡æ…‹æ¡† -->
    <div id="studentLoginModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 card-shadow">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">ğŸ‘¨â€ğŸ“</div>
                <h2 class="text-2xl font-bold text-gray-800">å­¸ç”Ÿç™»å…¥</h2>
                <p class="text-gray-600 mt-2">è«‹é¸æ“‡æ‚¨çš„å§“å</p>
            </div>
            
            <div class="space-y-4">
                <input type="text" id="studentNameInput" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="loginAsStudent()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl transition-colors">
                    ç™»å…¥
                </button>
                <button onclick="closeLoginModal()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-xl transition-colors">
                    å–æ¶ˆ
                </button>
                <div id="studentLoginError" class="hidden mt-2 text-red-500 text-sm text-center"></div>
            </div>
        </div>
    </div>

    <!-- æ•™å¸«ç™»å…¥æ¨¡æ…‹æ¡† -->
    <div id="teacherLoginModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 card-shadow">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">ğŸ‘©â€ğŸ«</div>
                <h2 class="text-2xl font-bold text-gray-800">æ•™å¸«ç™»å…¥</h2>
                <p class="text-gray-600 mt-2">è«‹è¼¸å…¥æ•™å¸«å¯†ç¢¼</p>
            </div>
            
            <div class="space-y-4">
                <input type="password" id="teacherPassword" placeholder="è«‹è¼¸å…¥æ•™å¸«å¯†ç¢¼" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500">
                <button onclick="loginAsTeacher()" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-xl transition-colors">
                    ç™»å…¥
                </button>
                <button onclick="closeLoginModal()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-xl transition-colors">
                    å–æ¶ˆ
                </button>
                <div id="loginError" class="hidden mt-2 text-red-500 text-sm text-center"></div>
                <div id="lockoutMessage" class="hidden mt-2 text-red-600 text-sm text-center font-semibold"></div>
            </div>
        </div>
    </div>

    <!-- å­¸ç”Ÿåˆ†æ•¸æŸ¥è©¢æ¨¡æ…‹æ¡† -->
    <div id="scoreQueryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 card-shadow max-h-[90vh] overflow-y-auto">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">ğŸ“Š</div>
                <h2 class="text-2xl font-bold text-gray-800">æŸ¥è©¢æˆ‘çš„åˆ†æ•¸</h2>
                <p class="text-gray-600 mt-2">è¼¸å…¥æ‚¨çš„å§“åæŸ¥çœ‹åˆ†æ•¸èˆ‡æ’å</p>
            </div>
            
            <div class="space-y-4">
                <input type="text" id="scoreQueryName" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500">
                <button onclick="queryScore()" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-xl transition-colors">
                    æŸ¥è©¢åˆ†æ•¸
                </button>
                <button onclick="closeScoreQueryModal()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-xl transition-colors">
                    é—œé–‰
                </button>
                
                <!-- æŸ¥è©¢çµæœé¡¯ç¤ºå€ -->
                <div id="scoreQueryResult" class="hidden mt-6 p-4 bg-gray-50 rounded-xl">
                    <div class="text-center">
                        <div id="studentAvatar" class="text-4xl mb-2">ğŸ‘¨â€ğŸ“</div>
                        <div id="studentNameDisplay" class="text-xl font-bold text-gray-800 mb-2"></div>
                        <div id="studentGroupDisplay" class="text-sm text-gray-600 mb-4"></div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-white rounded-lg p-3 text-center">
                                <div class="text-2xl font-bold text-blue-600" id="studentScoreDisplay">0</div>
                                <div class="text-xs text-gray-500">å€‹äººåˆ†æ•¸</div>
                            </div>
                            <div class="bg-white rounded-lg p-3 text-center">
                                <div class="text-2xl font-bold text-purple-600" id="studentRankDisplay">-</div>
                                <div class="text-xs text-gray-500">å€‹äººæ’å</div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg p-3 text-center">
                            <div class="text-lg font-bold text-green-600" id="groupScoreDisplay">0</div>
                            <div class="text-xs text-gray-500">å°çµ„ç¸½åˆ†</div>
                        </div>
                    </div>
                </div>
                
                <!-- åˆ†æ•¸è®ŠåŒ–è¨˜éŒ„å€åŸŸ -->
                <div id="studentScoreHistory" class="mt-6">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-semibold text-gray-800">ğŸ“ˆ æˆ‘çš„åˆ†æ•¸è®ŠåŒ–è¨˜éŒ„</h4>
                    </div>
                    
                    <div id="studentHistoryList" class="space-y-2 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-3 bg-gray-50 custom-scrollbar" style="scrollbar-width: thin; scrollbar-color: #cbd5e0 #f7fafc;">
                        <!-- åˆ†æ•¸è¨˜éŒ„å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                    </div>
                </div>
                
                <div id="scoreQueryError" class="hidden mt-2 text-red-500 text-sm text-center"></div>
            </div>
        </div>
    </div>

    <!-- å­¸ç”Ÿç•™è¨€æ¿æ¨¡æ…‹æ¡† -->
    <div id="messageboardModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-4xl w-full mx-4 card-shadow max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center space-x-3">
                    <div class="text-4xl">ğŸ’¬</div>
                    <h2 class="text-2xl font-bold text-gray-800">å­¸ç”Ÿç•™è¨€æ¿</h2>
                </div>
                <button onclick="closeMessageboardModal()" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
            </div>
            
            <!-- å­¸ç”Ÿç™¼è¡¨ç•™è¨€å€ -->
            <div id="studentMessageForm" class="hidden mb-6 p-4 bg-blue-50 rounded-xl">
                <h3 class="font-semibold text-gray-800 mb-3">ç™¼è¡¨æ–°ç•™è¨€</h3>
                <textarea id="messageContent" placeholder="è«‹è¼¸å…¥æ‚¨çš„ç•™è¨€..." rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="messageVisibility" value="private" checked class="text-blue-500">
                            <span class="text-sm text-gray-700">ğŸ”’ åƒ…è€å¸«å¯è¦‹</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="messageVisibility" value="public" class="text-blue-500">
                            <span class="text-sm text-gray-700">ğŸŒ å…¬é–‹çµ¦å…¨ç­</span>
                        </label>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="postMessage()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">ç™¼å¸ƒç•™è¨€</button>
                        <button onclick="clearMessageForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">æ¸…ç©º</button>
                    </div>
                </div>
            </div>

            <!-- ç•™è¨€åˆ—è¡¨ -->
            <div id="messagesList" class="space-y-4">
                <div class="text-center text-gray-500 py-8">
                    <div class="text-4xl mb-2">ğŸ“</div>
                    <p>å°šç„¡ç•™è¨€</p>
                </div>
            </div>
        </div>
    </div>

    <!-- å­¸ç”Ÿçå“å…Œæ›æ¨¡æ…‹æ¡† -->
    <div id="rewardExchangeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-4xl w-full mx-4 card-shadow max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center space-x-3">
                    <div class="text-4xl">ğŸ</div>
                    <h2 class="text-2xl font-bold text-gray-800">çå“å…Œæ›</h2>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="showExchangeHistory()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                        ğŸ“‹ å…Œæ›è¨˜éŒ„
                    </button>
                    <button onclick="closeRewardExchangeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
                </div>
            </div>
            
            <!-- å­¸ç”Ÿåˆ†æ•¸é¡¯ç¤º -->
            <div id="studentPointsDisplay" class="mb-6 p-4 bg-blue-50 rounded-xl text-center">
                <div class="text-lg font-semibold text-gray-800 mb-2">æˆ‘çš„é»æ•¸</div>
                <div class="text-3xl font-bold text-blue-600" id="currentStudentPoints">0</div>
            </div>
            
            <!-- çå“åˆ—è¡¨ -->
            <div id="rewardsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="text-center text-gray-500 py-8 col-span-full">
                    <div class="text-4xl mb-2">ğŸ</div>
                    <p>å°šç„¡å¯å…Œæ›çå“</p>
                </div>
            </div>
            
            <!-- å…Œæ›è¨˜éŒ„å€åŸŸ -->
            <div id="exchangeHistorySection" class="hidden">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">æˆ‘çš„å…Œæ›è¨˜éŒ„</h3>
                    <button onclick="hideExchangeHistory()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                        â† è¿”å›çå“åˆ—è¡¨
                    </button>
                </div>
                
                <div id="studentExchangeHistory" class="space-y-3">
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">ğŸ“‹</div>
                        <p>å°šç„¡å…Œæ›è¨˜éŒ„</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å­¸ç”Ÿæ¶åˆ†æ¨¡æ…‹æ¡† -->
    <div id="studentQuizModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-4xl w-full mx-4 card-shadow max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center space-x-3">
                    <div class="text-4xl">âš¡</div>
                    <h2 class="text-2xl font-bold text-gray-800">æ¶åˆ†æ´»å‹•</h2>
                </div>
                <button onclick="closeStudentQuizModal()" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
            </div>
            
            <!-- å€’æ•¸è¨ˆæ™‚å€ -->
            <div id="quizCountdownSection" class="hidden mb-6 p-6 bg-gradient-to-r from-red-100 to-orange-100 rounded-xl text-center">
                <div class="text-lg font-semibold text-gray-800 mb-2">æ¶åˆ†æ´»å‹•å³å°‡é–‹å§‹</div>
                <div id="countdownDisplay" class="text-4xl font-bold text-red-600 mb-2">00:00:00</div>
                <div id="countdownQuizTitle" class="text-gray-600"></div>
            </div>
            
            <!-- æ¶åˆ†æ´»å‹•åˆ—è¡¨ -->
            <div id="studentQuizList" class="space-y-4">
                <div class="text-center text-gray-500 py-8">
                    <div class="text-4xl mb-2">âš¡</div>
                    <p>ç›®å‰æ²’æœ‰æ¶åˆ†æ´»å‹•</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹å¯†ç¢¼æ¨¡æ…‹æ¡† -->
    <div id="changePasswordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 card-shadow">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">ğŸ”‘</div>
                <h2 class="text-2xl font-bold text-gray-800">ä¿®æ”¹æ•™å¸«å¯†ç¢¼</h2>
                <p class="text-gray-600 mt-2">è«‹è¼¸å…¥èˆŠå¯†ç¢¼å’Œæ–°å¯†ç¢¼</p>
            </div>
            
            <div class="space-y-4">
                <input type="password" id="oldPassword" placeholder="è«‹è¼¸å…¥èˆŠå¯†ç¢¼" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500">
                <input type="password" id="newPassword" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500">
                <input type="password" id="confirmPassword" placeholder="è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500">
                <button onclick="changePassword()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 px-6 rounded-xl transition-colors">
                    ä¿®æ”¹å¯†ç¢¼
                </button>
                <button onclick="closeChangePasswordModal()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-xl transition-colors">
                    å–æ¶ˆ
                </button>
                <div id="changePasswordError" class="hidden mt-2 text-red-500 text-sm text-center"></div>
                <div id="changePasswordSuccess" class="hidden mt-2 text-green-500 text-sm text-center"></div>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦å…§å®¹ -->
    <div id="mainContent" class="hidden">
        <!-- å·¦ä¸Šè§’ä¸»ç•«é¢æŒ‰éˆ• -->
        <div class="fixed left-4 top-4 z-40">
            <button id="homeBtn" onclick="showHomeTab()" class="bg-gray-500 hover:bg-gray-600 w-16 h-16 rounded-full transition-colors flex items-center justify-center text-2xl shadow-lg" title="ä¸»ç•«é¢">
                ğŸ 
            </button>
        </div>
        
        <!-- å·¦å´ä¸­é–“åŠŸèƒ½æŒ‰éˆ• -->
        <div class="fixed left-4 top-1/2 transform -translate-y-1/2 z-40 flex flex-col space-y-4">
            <!-- å­¸ç”ŸåŠŸèƒ½æŒ‰éˆ• -->
            <button id="messageboardBtn" onclick="showMessageboard()" class="hidden bg-purple-500 hover:bg-purple-600 w-16 h-16 rounded-full transition-colors flex items-center justify-center text-2xl shadow-lg" title="å­¸ç”Ÿç•™è¨€æ¿">
                ğŸ’¬
            </button>
            
            <button id="scoreQueryBtn" onclick="showScoreQuery()" class="hidden bg-green-500 hover:bg-green-600 w-16 h-16 rounded-full transition-colors flex items-center justify-center text-2xl shadow-lg" title="æŸ¥è©¢æˆ‘çš„åˆ†æ•¸">
                ğŸ“Š
            </button>
            
            <button id="rewardExchangeBtn" onclick="showRewardExchange()" class="hidden bg-yellow-500 hover:bg-yellow-600 w-16 h-16 rounded-full transition-colors flex items-center justify-center text-2xl shadow-lg" title="çå“å…Œæ›">
                ğŸ
            </button>
            
            <button id="studentQuizBtn" onclick="showStudentQuiz()" class="hidden bg-red-500 hover:bg-red-600 w-16 h-16 rounded-full transition-colors flex items-center justify-center text-2xl shadow-lg" title="æ¶åˆ†æ´»å‹•">
                âš¡
            </button>
            
            <!-- æ•™å¸«åŠŸèƒ½æŒ‰éˆ• -->
            <button id="manageBtn" onclick="showManageTab()" class="hidden bg-blue-500 hover:bg-blue-600 w-16 h-16 rounded-full transition-colors flex items-center justify-center text-2xl shadow-lg" title="ç­ç´šåˆ†çµ„å»ºç«‹">
                ğŸ“
            </button>
            
            <button id="messagesBtn" onclick="showMessagesTab()" class="hidden bg-indigo-500 hover:bg-indigo-600 w-16 h-16 rounded-full transition-colors flex items-center justify-center text-2xl shadow-lg" title="å­¸ç”Ÿç•™è¨€ç®¡ç†">
                ğŸ’¬
            </button>
            
            <button id="scoreHistoryBtn" onclick="showScoreHistoryTab()" class="hidden bg-purple-500 hover:bg-purple-600 w-16 h-16 rounded-full transition-colors flex items-center justify-center text-2xl shadow-lg" title="åˆ†æ•¸è®ŠåŒ–è¨˜éŒ„">
                ğŸ“ˆ
            </button>
            
            <button id="rewardManageBtn" onclick="showRewardManageTab()" class="hidden bg-yellow-500 hover:bg-yellow-600 w-16 h-16 rounded-full transition-colors flex items-center justify-center text-2xl shadow-lg" title="çå“ç®¡ç†">
                ğŸ
            </button>
            
            <button id="quizManageBtn" onclick="showQuizManageTab()" class="hidden bg-red-500 hover:bg-red-600 w-16 h-16 rounded-full transition-colors flex items-center justify-center text-2xl shadow-lg" title="æ¶åˆ†ç®¡ç†">
                âš¡
            </button>
        </div>
        
        <!-- å·¦ä¸‹è§’ä¿®æ”¹å¯†ç¢¼æŒ‰éˆ• -->
        <div class="fixed left-4 bottom-4 z-40">
            <button id="changePasswordBtn" onclick="showChangePasswordModal()" class="hidden bg-orange-500 hover:bg-orange-600 w-16 h-16 rounded-full transition-colors flex items-center justify-center text-2xl shadow-lg" title="ä¿®æ”¹æ•™å¸«å¯†ç¢¼">
                ğŸ”‘
            </button>
        </div>
        
        <!-- å³ä¸Šè§’ç™»å…¥æŒ‰éˆ• -->
        <div class="fixed top-4 right-4 z-40">
            <!-- æœªç™»å…¥ç‹€æ…‹ -->
            <div id="loginButtons" class="flex flex-col space-y-2">
                <button onclick="showStudentLogin()" class="bg-blue-500 hover:bg-blue-600 w-12 h-12 rounded-full transition-colors flex items-center justify-center text-xl shadow-lg" title="å­¸ç”Ÿç™»å…¥">
                    ğŸ‘¨â€ğŸ“
                </button>
                <button onclick="showTeacherLogin()" class="bg-green-500 hover:bg-green-600 w-12 h-12 rounded-full transition-colors flex items-center justify-center text-xl shadow-lg" title="æ•™å¸«ç™»å…¥">
                    ğŸ‘©â€ğŸ«
                </button>
            </div>
            
            <!-- å·²ç™»å…¥ç‹€æ…‹ -->
            <div id="userInfo" class="hidden flex flex-col items-end space-y-2">
                <div class="bg-white rounded-full px-4 py-2 shadow-lg">
                    <span id="userMode" class="text-sm font-semibold text-gray-800"></span>
                </div>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 w-12 h-12 rounded-full transition-colors flex items-center justify-center text-xl shadow-lg text-white" title="ç™»å‡º">
                    ğŸšª
                </button>
            </div>
        </div>
        
        <!-- æ¨™é¡Œå€ -->
        <div class="text-center py-6">
            <div class="flex items-center justify-center space-x-4 mb-4">
                <div class="text-4xl floating">ğŸ†</div>
                <h1 id="classTitle" class="text-4xl font-bold text-gray-800 cursor-pointer hover:text-blue-600 transition-colors" onclick="editTitle()">ç­ç´šç®¡ç†ç³»çµ±</h1>
            </div>
        </div>

        <!-- ä¸»è¦å…§å®¹å€ -->
        <div class="max-w-6xl mx-auto px-4 pb-8">
            <!-- æ’è¡Œæ¦œå€åŸŸ -->
            <div id="homeContent" class="max-w-6xl mx-auto">
                <!-- åˆä½µæ’è¡Œæ¦œ -->
                <div class="bg-white rounded-2xl p-6 card-shadow mb-8">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                            ğŸ† æ’è¡Œæ¦œ
                        </h2>
                        <div class="flex space-x-2">
                            <button id="groupRankBtn" onclick="switchRankingMode('group')" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">
                                ğŸ‘¥ å°çµ„æ’è¡Œ
                            </button>
                            <button id="individualRankBtn" onclick="switchRankingMode('individual')" class="px-4 py-2 rounded-lg bg-blue-500 text-white transition-colors">
                                ğŸŒŸ å€‹äººæ’è¡Œ
                            </button>
                        </div>
                    </div>
                    
                    <!-- é ’çå°å€åŸŸ -->
                    <div id="podiumContainer" class="mb-8">
                        <div class="flex justify-center items-end space-x-4 h-64">
                            <!-- ç¬¬äºŒå -->
                            <div class="flex flex-col items-center">
                                <div id="rank2Info" class="info-appear text-center mb-2 opacity-0 transform translate-y-4">
                                    <div class="text-4xl mb-1">ğŸ¥ˆ</div>
                                    <div class="font-bold text-gray-800 text-sm"></div>
                                    <div class="text-xs text-gray-600"></div>
                                    <div class="text-lg font-bold text-gray-800"></div>
                                </div>
                                <div id="podium2" class="podium-rise w-20 bg-gradient-to-t from-gray-400 to-gray-300 rounded-t-lg transform scale-y-0 origin-bottom" style="height: 0px;">
                                    <div class="text-white font-bold text-center py-2 text-sm">2</div>
                                </div>
                            </div>
                            
                            <!-- ç¬¬ä¸€å -->
                            <div class="flex flex-col items-center">
                                <div id="rank1Info" class="info-appear text-center mb-2 opacity-0 transform translate-y-4">
                                    <div class="text-5xl mb-1">ğŸ¥‡</div>
                                    <div class="font-bold text-gray-800"></div>
                                    <div class="text-xs text-gray-600"></div>
                                    <div class="text-xl font-bold text-gray-800"></div>
                                </div>
                                <div id="podium1" class="podium-rise w-24 bg-gradient-to-t from-yellow-500 to-yellow-300 rounded-t-lg transform scale-y-0 origin-bottom" style="height: 0px;">
                                    <div class="text-white font-bold text-center py-2">1</div>
                                </div>
                            </div>
                            
                            <!-- ç¬¬ä¸‰å -->
                            <div class="flex flex-col items-center">
                                <div id="rank3Info" class="info-appear text-center mb-2 opacity-0 transform translate-y-4">
                                    <div class="text-3xl mb-1">ğŸ¥‰</div>
                                    <div class="font-bold text-gray-800 text-sm"></div>
                                    <div class="text-xs text-gray-600"></div>
                                    <div class="text-md font-bold text-gray-800"></div>
                                </div>
                                <div id="podium3" class="podium-rise w-16 bg-gradient-to-t from-orange-600 to-orange-400 rounded-t-lg transform scale-y-0 origin-bottom" style="height: 0px;">
                                    <div class="text-white font-bold text-center py-1 text-sm">3</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç¬¬å››ç¬¬äº”å -->
                    <div id="otherRankings" class="space-y-3">
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-2">ğŸ“Š</div>
                            <p id="emptyMessage">å°šæœªå»ºç«‹å­¸ç”Ÿ</p>
                        </div>
                    </div>
                </div>

                <!-- å¿«é€ŸåŠ åˆ†å€ (æ•™å¸«å°ˆç”¨) -->
                <div id="quickScoreSection" class="hidden bg-white rounded-2xl p-6 card-shadow mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                        âš¡ å¿«é€ŸåŠ æ¸›åˆ†
                    </h3>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- å°çµ„åŠ åˆ† -->
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-3">ğŸ‘¥ å°çµ„åŠ æ¸›åˆ†</h4>
                            <div class="space-y-3">
                                <select id="groupSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">é¸æ“‡å°çµ„</option>
                                </select>
                                <div class="flex space-x-2">
                                    <input type="number" id="groupScore" placeholder="åˆ†æ•¸" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <button onclick="addGroupScore()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                                        â•
                                    </button>
                                    <button onclick="subtractGroupScore()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                                        â–
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- å€‹äººåŠ åˆ† -->
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-3">ğŸŒŸ å€‹äººåŠ æ¸›åˆ†</h4>
                            <div class="space-y-3">
                                <select id="studentSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">é¸æ“‡å­¸ç”Ÿ</option>
                                </select>
                                <div class="flex space-x-2">
                                    <input type="number" id="studentScore" placeholder="åˆ†æ•¸" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <button onclick="addStudentScore()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                                        â•
                                    </button>
                                    <button onclick="subtractStudentScore()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                                        â–
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- èª²ç¨‹å…¬å‘Šå€ -->
                <div class="bg-white rounded-2xl p-6 card-shadow">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                            ğŸ“¢ èª²ç¨‹å…¬å‘Š
                        </h2>
                        <button id="addAnnouncementBtn" onclick="showAnnouncementForm()" class="hidden bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            â• æ–°å¢å…¬å‘Š
                        </button>
                    </div>

                    <!-- å…¬å‘Šè¡¨å–® -->
                    <div id="announcementForm" class="hidden mb-6 p-4 bg-gray-50 rounded-xl">
                        <input type="text" id="announcementTitle" placeholder="å…¬å‘Šæ¨™é¡Œ" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <textarea id="announcementContent" placeholder="å…¬å‘Šå…§å®¹" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        <input type="url" id="announcementLink" placeholder="ç›¸é—œé€£çµ (é¸å¡«)" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="flex space-x-2">
                            <button onclick="addAnnouncement()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">ç™¼å¸ƒ</button>
                            <button onclick="hideAnnouncementForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">å–æ¶ˆ</button>
                        </div>
                    </div>

                    <!-- å…¬å‘Šåˆ—è¡¨ -->
                    <div id="announcements" class="space-y-4">
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-2">ğŸ“</div>
                            <p>å°šç„¡èª²ç¨‹å…¬å‘Š</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ•™å¸«ç•™è¨€ç®¡ç†é é¢ -->
        <div id="messagesContent" class="hidden max-w-6xl mx-auto px-4 pb-8">
            <div class="bg-white rounded-2xl p-6 card-shadow">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        ğŸ’¬ å­¸ç”Ÿç•™è¨€ç®¡ç†
                    </h2>
                    <div class="flex items-center space-x-2">
                        <div class="flex space-x-2">
                            <button id="filterAll" onclick="filterMessages('all')" class="px-4 py-2 rounded-lg bg-blue-500 text-white transition-colors">å…¨éƒ¨</button>
                            <button id="filterPublic" onclick="filterMessages('public')" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">å…¬é–‹</button>
                            <button id="filterPrivate" onclick="filterMessages('private')" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">ç§äºº</button>
                        </div>
                        <button onclick="showHomeTab()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                            â† è¿”å›é¦–é 
                        </button>
                    </div>
                </div>
                
                <div id="teacherMessagesList" class="space-y-4">
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">ğŸ“</div>
                        <p>å°šç„¡å­¸ç”Ÿç•™è¨€</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- åˆ†æ•¸è®ŠåŒ–è¨˜éŒ„é é¢ -->
        <div id="scoreHistoryContent" class="hidden max-w-6xl mx-auto px-4 pb-8">
            <div class="bg-white rounded-2xl p-6 card-shadow">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        ğŸ“ˆ åˆ†æ•¸è®ŠåŒ–è¨˜éŒ„
                    </h2>
                    <div class="flex items-center space-x-2">
                        <div class="flex space-x-2">
                            <button id="historyFilterAll" onclick="filterScoreHistory('all')" class="px-4 py-2 rounded-lg bg-blue-500 text-white transition-colors">å…¨éƒ¨è¨˜éŒ„</button>
                            <button id="historyFilterGroup" onclick="filterScoreHistory('group')" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">å°çµ„åŠ åˆ†</button>
                            <button id="historyFilterIndividual" onclick="filterScoreHistory('individual')" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">å€‹äººåŠ åˆ†</button>
                        </div>
                        <select id="studentHistoryFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">é¸æ“‡å­¸ç”Ÿç¯©é¸</option>
                        </select>

                        <button onclick="showHomeTab()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                            â† è¿”å›é¦–é 
                        </button>
                    </div>
                </div>
                
                <!-- çµ±è¨ˆè³‡è¨Š -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-blue-600" id="totalRecords">0</div>
                        <div class="text-sm text-gray-600">ç¸½è¨˜éŒ„æ•¸</div>
                    </div>
                    <div class="bg-green-50 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-green-600" id="totalPositive">0</div>
                        <div class="text-sm text-gray-600">åŠ åˆ†æ¬¡æ•¸</div>
                    </div>
                    <div class="bg-red-50 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-red-600" id="totalNegative">0</div>
                        <div class="text-sm text-gray-600">æ‰£åˆ†æ¬¡æ•¸</div>
                    </div>
                    <div class="bg-purple-50 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-purple-600" id="todayRecords">0</div>
                        <div class="text-sm text-gray-600">ä»Šæ—¥è¨˜éŒ„</div>
                    </div>
                </div>
                
                <div id="scoreHistoryList" class="space-y-3">
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">ğŸ“Š</div>
                        <p>å°šç„¡åˆ†æ•¸è®ŠåŒ–è¨˜éŒ„</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ•™å¸«æ¶åˆ†ç®¡ç†é é¢ -->
        <div id="quizManageContent" class="hidden max-w-6xl mx-auto px-4 pb-8">
            <div class="bg-white rounded-2xl p-6 card-shadow">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        âš¡ æ¶åˆ†ç®¡ç†
                    </h2>
                    <div class="flex items-center space-x-2">
                        <button onclick="showCreateQuizForm()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                            â• å»ºç«‹æ¶åˆ†æ´»å‹•
                        </button>
                        <button onclick="showQuizHistory()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors">
                            ğŸ“Š æ´»å‹•è¨˜éŒ„
                        </button>
                        <button onclick="showHomeTab()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                            â† è¿”å›é¦–é 
                        </button>
                    </div>
                </div>
                
                <!-- å»ºç«‹æ¶åˆ†æ´»å‹•è¡¨å–® -->
                <div id="createQuizForm" class="hidden mb-6 p-4 bg-gray-50 rounded-xl">
                    <h3 class="font-semibold text-gray-800 mb-4">å»ºç«‹æ–°çš„æ¶åˆ†æ´»å‹•</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">é¡Œå‹</label>
                            <select id="quizType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="choice">é¸æ“‡é¡Œ</option>
                                <option value="text">å•ç­”é¡Œ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å‰å¹¾åå¾—åˆ†</label>
                            <input type="number" id="quizWinners" placeholder="ä¾‹å¦‚ï¼š3" min="1" max="10" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">é¡Œç›®</label>
                            <textarea id="quizQuestion" placeholder="è«‹è¼¸å…¥é¡Œç›®å…§å®¹" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                        </div>
                    </div>
                    
                    <!-- é¸æ“‡é¡Œé¸é … -->
                    <div id="choiceOptions" class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">é¸é …è¨­å®š</label>
                        <div class="space-y-2">
                            <div class="flex items-center space-x-2">
                                <input type="radio" name="correctChoice" value="A" id="choiceA_radio" class="text-green-500">
                                <label for="choiceA_radio" class="text-sm text-gray-600">æ­£ç¢ºç­”æ¡ˆ</label>
                                <input type="text" id="choiceA" placeholder="é¸é … A" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="radio" name="correctChoice" value="B" id="choiceB_radio" class="text-green-500">
                                <label for="choiceB_radio" class="text-sm text-gray-600">æ­£ç¢ºç­”æ¡ˆ</label>
                                <input type="text" id="choiceB" placeholder="é¸é … B" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="radio" name="correctChoice" value="C" id="choiceC_radio" class="text-green-500">
                                <label for="choiceC_radio" class="text-sm text-gray-600">æ­£ç¢ºç­”æ¡ˆ</label>
                                <input type="text" id="choiceC" placeholder="é¸é … C" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="radio" name="correctChoice" value="D" id="choiceD_radio" class="text-green-500">
                                <label for="choiceD_radio" class="text-sm text-gray-600">æ­£ç¢ºç­”æ¡ˆ</label>
                                <input type="text" id="choiceD" placeholder="é¸é … D" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                    </div>
                    
                    <!-- å•ç­”é¡Œç­”æ¡ˆ -->
                    <div id="textAnswer" class="hidden mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ¨™æº–ç­”æ¡ˆ</label>
                        <textarea id="quizAnswer" placeholder="è«‹è¼¸å…¥æ¨™æº–ç­”æ¡ˆ" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                    </div>
                    
                    <!-- å¾—åˆ†è¨­å®š -->
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">å¾—åˆ†è¨­å®š</label>
                        <div id="scoreSettings" class="space-y-2">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-600 w-16">ç¬¬1åï¼š</span>
                                <input type="number" id="score1" placeholder="åˆ†æ•¸" min="1" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                    </div>
                    
                    <!-- é–‹å§‹æ™‚é–“è¨­å®š -->
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">é–‹å§‹æ™‚é–“</label>
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="startType" value="immediate" checked class="text-green-500">
                                <span class="text-sm text-gray-700">ç«‹å³é–‹å§‹</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="startType" value="scheduled" class="text-green-500">
                                <span class="text-sm text-gray-700">é ç´„é–‹å§‹</span>
                            </label>
                        </div>
                        <div id="scheduledTime" class="hidden mt-3 grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">é–‹å§‹æ—¥æœŸ</label>
                                <input type="date" id="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">é–‹å§‹æ™‚é–“</label>
                                <input type="time" id="startTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2 mt-6">
                        <button onclick="createQuiz()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">å»ºç«‹æ´»å‹•</button>
                        <button onclick="hideCreateQuizForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">å–æ¶ˆ</button>
                    </div>
                </div>
                
                <!-- æ´»å‹•è¨˜éŒ„å€åŸŸ -->
                <div id="quizHistorySection" class="hidden mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">æ´»å‹•è¨˜éŒ„</h3>
                        <button onclick="hideQuizHistory()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                            â† è¿”å›æ´»å‹•åˆ—è¡¨
                        </button>
                    </div>
                    
                    <div id="quizHistoryList" class="space-y-3">
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-2">ğŸ“Š</div>
                            <p>å°šç„¡æ´»å‹•è¨˜éŒ„</p>
                        </div>
                    </div>
                </div>
                
                <!-- ç›®å‰æ´»å‹•åˆ—è¡¨ -->
                <div id="currentQuizList" class="space-y-4">
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">âš¡</div>
                        <p>å°šç„¡æ¶åˆ†æ´»å‹•</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ•™å¸«çå“ç®¡ç†é é¢ -->
        <div id="rewardManageContent" class="hidden max-w-6xl mx-auto px-4 pb-8">
            <div class="bg-white rounded-2xl p-6 card-shadow">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        ğŸ çå“ç®¡ç†
                    </h2>
                    <div class="flex items-center space-x-2">
                        <button onclick="showAddRewardForm()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                            â• æ–°å¢çå“
                        </button>
                        <button onclick="showExchangeRequests()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            ğŸ“‹ å…Œæ›ç”³è«‹
                        </button>
                        <button onclick="showTeacherExchangeHistory()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors">
                            ğŸ“Š å…Œæ›è¨˜éŒ„
                        </button>
                        <button onclick="showHomeTab()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                            â† è¿”å›é¦–é 
                        </button>
                    </div>
                </div>
                
                <!-- æ–°å¢çå“è¡¨å–® -->
                <div id="addRewardForm" class="hidden mb-6 p-4 bg-gray-50 rounded-xl">
                    <h3 class="font-semibold text-gray-800 mb-4">æ–°å¢çå“</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">çå“åç¨±</label>
                            <input type="text" id="rewardName" placeholder="è«‹è¼¸å…¥çå“åç¨±" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ‰€éœ€é»æ•¸</label>
                            <input type="number" id="rewardPoints" placeholder="è«‹è¼¸å…¥æ‰€éœ€é»æ•¸" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">çå“æ•¸é‡</label>
                            <input type="number" id="rewardQuantity" placeholder="è«‹è¼¸å…¥çå“æ•¸é‡" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">çå“åœ–ç‰‡</label>
                            <input type="file" id="rewardImage" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">çå“æè¿°</label>
                        <textarea id="rewardDescription" placeholder="è«‹è¼¸å…¥çå“æè¿°" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                    </div>
                    <div class="flex space-x-2 mt-4">
                        <button onclick="addReward()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">æ–°å¢çå“</button>
                        <button onclick="hideAddRewardForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">å–æ¶ˆ</button>
                    </div>
                </div>
                
                <!-- ç·¨è¼¯çå“è¡¨å–® -->
                <div id="editRewardForm" class="hidden mb-6 p-4 bg-blue-50 rounded-xl">
                    <h3 class="font-semibold text-gray-800 mb-4">ç·¨è¼¯çå“</h3>
                    <input type="hidden" id="editRewardId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">çå“åç¨±</label>
                            <input type="text" id="editRewardName" placeholder="è«‹è¼¸å…¥çå“åç¨±" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ‰€éœ€é»æ•¸</label>
                            <input type="number" id="editRewardPoints" placeholder="è«‹è¼¸å…¥æ‰€éœ€é»æ•¸" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">çå“æ•¸é‡</label>
                            <input type="number" id="editRewardQuantity" placeholder="è«‹è¼¸å…¥çå“æ•¸é‡" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ›´æ›çå“åœ–ç‰‡</label>
                            <input type="file" id="editRewardImage" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">çå“æè¿°</label>
                        <textarea id="editRewardDescription" placeholder="è«‹è¼¸å…¥çå“æè¿°" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div class="flex space-x-2 mt-4">
                        <button onclick="updateReward()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">æ›´æ–°çå“</button>
                        <button onclick="hideEditRewardForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">å–æ¶ˆ</button>
                    </div>
                </div>
                
                <!-- å…Œæ›ç”³è«‹åˆ—è¡¨ -->
                <div id="exchangeRequestsSection" class="hidden mb-6">
                    <h3 class="font-semibold text-gray-800 mb-4">å¾…è™•ç†å…Œæ›ç”³è«‹</h3>
                    <div id="exchangeRequestsList" class="space-y-3">
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-2">ğŸ“‹</div>
                            <p>å°šç„¡å¾…è™•ç†ç”³è«‹</p>
                        </div>
                    </div>
                </div>
                
                <!-- è€å¸«å…Œæ›è¨˜éŒ„åˆ—è¡¨ -->
                <div id="teacherExchangeHistorySection" class="hidden mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-800">æ‰€æœ‰å…Œæ›è¨˜éŒ„</h3>
                        <div class="flex items-center space-x-2">
                            <select id="exchangeStatusFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                                <option value="pending">å¯©æ ¸ä¸­</option>
                                <option value="approved">å·²åŒæ„</option>
                                <option value="rejected">å·²æ‹’çµ•</option>
                            </select>
                            <select id="exchangeStudentFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">æ‰€æœ‰å­¸ç”Ÿ</option>
                            </select>
                        </div>
                    </div>
                    <div id="teacherExchangeHistoryList" class="space-y-3">
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-2">ğŸ“Š</div>
                            <p>å°šç„¡å…Œæ›è¨˜éŒ„</p>
                        </div>
                    </div>
                </div>
                
                <!-- çå“åˆ—è¡¨ -->
                <div id="rewardManageList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="text-center text-gray-500 py-8 col-span-full">
                        <div class="text-4xl mb-2">ğŸ</div>
                        <p>å°šç„¡çå“</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç®¡ç†é é¢å…§å®¹ -->
        <div id="manageContent" class="hidden max-w-6xl mx-auto px-4 pb-8">
            <!-- ç­ç´šåˆ†çµ„å»ºç«‹å€ -->
            <div class="bg-white rounded-2xl p-6 card-shadow mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center">
                        ğŸ« ç­ç´šåˆ†çµ„å»ºç«‹
                    </h3>
                    <button onclick="showHomeTab()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                        â† è¿”å›é¦–é 
                    </button>
                </div>
                
                <div class="space-y-6">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">ä¸€æ¬¡å»ºç«‹æ•´ç­åˆ†çµ„</h4>
                        <p class="text-sm text-gray-600 mb-3">ä½¿ç”¨è¡¨æ ¼æ–¹å¼è¼¸å…¥åˆ†çµ„è³‡æ–™ï¼Œæ¯è¡Œä¸€å€‹å°çµ„ï¼Œå¯è¼¸å…¥å¤šå€‹å­¸ç”Ÿï¼ˆç©ºç™½æ¬„ä½æœƒè‡ªå‹•å¿½ç•¥ï¼‰</p>
                        
                        <!-- å‹•æ…‹è¡¨æ ¼ -->
                        <div class="border border-gray-300 rounded-lg mb-4">
                            <table class="w-full table-auto" id="groupTable">
                                <thead class="bg-gray-50">
                                    <tr id="tableHeader">
                                        <th class="px-2 py-2 text-left font-semibold text-gray-700">å°çµ„åç¨±</th>
                                        <th class="px-2 py-2 text-left font-semibold text-gray-700">å­¸ç”Ÿ1</th>
                                        <th class="px-2 py-2 text-left font-semibold text-gray-700">å­¸ç”Ÿ2</th>
                                        <th class="px-2 py-2 text-left font-semibold text-gray-700">å­¸ç”Ÿ3</th>
                                        <th class="px-2 py-2 text-left font-semibold text-gray-700">å­¸ç”Ÿ4</th>
                                        <th class="px-2 py-2 text-left font-semibold text-gray-700">å­¸ç”Ÿ5</th>
                                        <th class="px-2 py-2 text-center font-semibold text-gray-700">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="groupTableBody">
                                    <tr>
                                        <td class="px-2 py-2 border-t">
                                            <input type="text" placeholder="ç¬¬ä¸€çµ„" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                                        </td>
                                        <td class="px-2 py-2 border-t">
                                            <input type="text" placeholder="ç‹å°æ˜" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                                        </td>
                                        <td class="px-2 py-2 border-t">
                                            <input type="text" placeholder="æå°è¯" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                                        </td>
                                        <td class="px-2 py-2 border-t">
                                            <input type="text" placeholder="å¼µå°ç¾" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                                        </td>
                                        <td class="px-2 py-2 border-t">
                                            <input type="text" placeholder="é™³å°å¼·" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                                        </td>
                                        <td class="px-2 py-2 border-t">
                                            <input type="text" placeholder="æ—å°é›…" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                                        </td>
                                        <td class="px-2 py-2 border-t text-center">
                                            <button onclick="removeTableRow(this)" class="text-red-500 hover:text-red-700">ğŸ—‘ï¸</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="flex space-x-2 mb-4">
                            <button onclick="addTableRow()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                                â• å¢åŠ å°çµ„æ¬„ä½
                            </button>
                            <button onclick="removeTableRow()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                                â– æ¸›å°‘å°çµ„æ¬„ä½
                            </button>
                            <button onclick="addStudentColumn()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                                ğŸ‘¥ å¢åŠ å­¸ç”Ÿæ¬„ä½
                            </button>
                            <button onclick="removeStudentColumn()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-colors">
                                ğŸ‘¤ æ¸›å°‘å­¸ç”Ÿæ¬„ä½
                            </button>
                        </div>
                        
                        <button onclick="createClassGroupsFromTable()" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-2 rounded-lg transition-colors">
                            ğŸš€ å»ºç«‹æ•´ç­åˆ†çµ„
                        </button>
                    </div>
                    

                    
                    <!-- ç›®å‰åˆ†çµ„ç‹€æ³ -->
                    <div class="border-t pt-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-semibold text-gray-700">ğŸ“‹ ç›®å‰åˆ†çµ„ç‹€æ³</h4>
                            <button onclick="refreshGroupStatus()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                ğŸ”„ é‡æ–°æ•´ç†
                            </button>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">æŸ¥çœ‹å’Œèª¿æ•´ç›®å‰çš„å­¸ç”Ÿåˆ†çµ„ç‹€æ³</p>
                        
                        <div id="currentGroupStatus" class="space-y-4">
                            <div class="text-center text-gray-500 py-8">
                                <div class="text-4xl mb-2">ğŸ‘¥</div>
                                <p>å°šæœªå»ºç«‹åˆ†çµ„</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentUser = null;
        let currentStudent = null;
        let groups = [];
        let students = [];
        let announcements = [];
        let classTitle = 'ç­ç´šç®¡ç†ç³»çµ±';
        let loginAttempts = 0;
        let lockoutTime = 0;
        let teacherPassword = 'hres';
        let studentMessages = [];
        let currentMessageFilter = 'all';
        let currentRankingMode = 'individual';
        let scoreHistory = [];
        let currentHistoryFilter = 'all';
        let currentStudentFilter = '';
        let rewards = [];
        let exchangeRequests = [];
        let quizzes = [];
        let quizAnswers = [];
        let currentQuiz = null;
        let quizCountdown = null;


        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('classTitle').textContent = classTitle;
            document.getElementById('mainContent').classList.remove('hidden');
            checkLockout();
            loadData();
            
            // æ¯30ç§’æª¢æŸ¥ä¸€æ¬¡æ¶åˆ†æ´»å‹•ç‹€æ…‹
            setInterval(() => {
                if (currentUser === 'student') {
                    checkQuizCountdown();
                }
            }, 30000);
        });

        // æª¢æŸ¥æ˜¯å¦è¢«é–å®š
        function checkLockout() {
            const now = Date.now();
            if (lockoutTime > now) {
                const remainingTime = Math.ceil((lockoutTime - now) / 60000);
                document.getElementById('lockoutMessage').textContent = `ç™»å…¥å¤±æ•—æ¬¡æ•¸éå¤šï¼Œè«‹ç­‰å¾… ${remainingTime} åˆ†é˜å¾Œå†è©¦`;
                document.getElementById('lockoutMessage').classList.remove('hidden');
                document.getElementById('teacherPassword').disabled = true;
                
                setTimeout(checkLockout, 60000);
            } else {
                document.getElementById('lockoutMessage').classList.add('hidden');
                document.getElementById('teacherPassword').disabled = false;
                if (lockoutTime > 0) {
                    loginAttempts = 0;
                    lockoutTime = 0;
                    google.script.run.setStorage('loginAttempts', '0');
                    google.script.run.setStorage('lockoutTime', '0');
                }
            }
        }

        // ç™»å…¥ç›¸é—œå‡½æ•¸
        function showStudentLogin() {
            document.getElementById('studentLoginModal').classList.remove('hidden');
        }

        function showTeacherLogin() {
            if (lockoutTime > Date.now()) {
                return;
            }
            document.getElementById('teacherLoginModal').classList.remove('hidden');
        }

        function closeLoginModal() {
            document.getElementById('studentLoginModal').classList.add('hidden');
            document.getElementById('teacherLoginModal').classList.add('hidden');
            document.getElementById('teacherPassword').value = '';
            document.getElementById('studentNameInput').value = '';
            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('studentLoginError').classList.add('hidden');
        }

        // ä¿®æ”¹å¯†ç¢¼ç›¸é—œå‡½æ•¸
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('hidden');
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('hidden');
            document.getElementById('oldPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('changePasswordError').classList.add('hidden');
            document.getElementById('changePasswordSuccess').classList.add('hidden');
        }

        function changePassword() {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // æ¸…é™¤ä¹‹å‰çš„è¨Šæ¯
            document.getElementById('changePasswordError').classList.add('hidden');
            document.getElementById('changePasswordSuccess').classList.add('hidden');

            // é©—è­‰èˆŠå¯†ç¢¼
            if (oldPassword !== teacherPassword) {
                document.getElementById('changePasswordError').textContent = 'èˆŠå¯†ç¢¼éŒ¯èª¤';
                document.getElementById('changePasswordError').classList.remove('hidden');
                return;
            }

            // é©—è­‰æ–°å¯†ç¢¼
            if (!newPassword || newPassword.length < 3) {
                document.getElementById('changePasswordError').textContent = 'æ–°å¯†ç¢¼è‡³å°‘éœ€è¦3å€‹å­—å…ƒ';
                document.getElementById('changePasswordError').classList.remove('hidden');
                return;
            }

            // é©—è­‰å¯†ç¢¼ç¢ºèª
            if (newPassword !== confirmPassword) {
                document.getElementById('changePasswordError').textContent = 'æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ä¸€è‡´';
                document.getElementById('changePasswordError').classList.remove('hidden');
                return;
            }

            // æ›´æ–°å¯†ç¢¼
            teacherPassword = newPassword;
            google.script.run.setStorage('teacherPassword', teacherPassword);

            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            document.getElementById('changePasswordSuccess').textContent = 'å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼';
            document.getElementById('changePasswordSuccess').classList.remove('hidden');

            // 2ç§’å¾Œé—œé–‰è¦–çª—
            setTimeout(() => {
                closeChangePasswordModal();
            }, 2000);
        }

        function loginAsStudent() {
            const studentName = document.getElementById('studentNameInput').value.trim();
            if (!studentName) {
                document.getElementById('studentLoginError').textContent = 'è«‹è¼¸å…¥æ‚¨çš„å§“å';
                document.getElementById('studentLoginError').classList.remove('hidden');
                return;
            }

            const student = students.find(s => s.name === studentName);
            if (!student) {
                document.getElementById('studentLoginError').textContent = 'æ‰¾ä¸åˆ°æ­¤å­¸ç”Ÿï¼Œè«‹ç¢ºèªå§“åæ˜¯å¦æ­£ç¢º';
                document.getElementById('studentLoginError').classList.remove('hidden');
                return;
            }

            currentUser = 'student';
            currentStudent = student;
            document.getElementById('userMode').textContent = `ğŸ‘¨â€ğŸ“ ${student.name}`;
            closeLoginModal();
            updateUI();
        }

        function loginAsTeacher() {
            if (lockoutTime > Date.now()) {
                return;
            }

            const password = document.getElementById('teacherPassword').value;
            if (password === teacherPassword) {
                currentUser = 'teacher';
                currentStudent = null;
                document.getElementById('userMode').textContent = 'ğŸ‘©â€ğŸ« æ•™å¸«';
                loginAttempts = 0;
                google.script.run.setStorage('loginAttempts', '0');
                closeLoginModal();
                updateUI();
            } else {
                loginAttempts++;
                google.script.run.setStorage('loginAttempts', loginAttempts.toString());
                
                if (loginAttempts >= 3) {
                    lockoutTime = Date.now() + 10 * 60 * 1000; // 10åˆ†é˜
                    google.script.run.setStorage('lockoutTime', lockoutTime.toString());
                    checkLockout();
                } else {
                    document.getElementById('loginError').textContent = `å¯†ç¢¼éŒ¯èª¤ï¼Œé‚„æœ‰ ${3 - loginAttempts} æ¬¡æ©Ÿæœƒ`;
                    document.getElementById('loginError').classList.remove('hidden');
                }
                document.getElementById('teacherPassword').value = '';
            }
        }

        function logout() {
            currentUser = null;
            currentStudent = null;
            updateUI();
        }

        // æ›´æ–°UIæ¬Šé™
        function updateUI() {
            const isLoggedIn = currentUser !== null;
            const isTeacher = currentUser === 'teacher';
            const isStudent = currentUser === 'student';

            // é¡¯ç¤º/éš±è—ç™»å…¥æŒ‰éˆ•å’Œç”¨æˆ¶è³‡è¨Š
            document.getElementById('loginButtons').style.display = isLoggedIn ? 'none' : 'flex';
            document.getElementById('userInfo').style.display = isLoggedIn ? 'flex' : 'none';

            // é¡¯ç¤º/éš±è—æ•™å¸«åŠŸèƒ½æŒ‰éˆ•
            document.getElementById('manageBtn').style.display = isTeacher ? 'flex' : 'none';
            document.getElementById('messagesBtn').style.display = isTeacher ? 'flex' : 'none';
            document.getElementById('scoreHistoryBtn').style.display = isTeacher ? 'flex' : 'none';
            document.getElementById('rewardManageBtn').style.display = isTeacher ? 'flex' : 'none';
            document.getElementById('quizManageBtn').style.display = isTeacher ? 'flex' : 'none';
            document.getElementById('changePasswordBtn').style.display = isTeacher ? 'flex' : 'none';
            document.getElementById('addAnnouncementBtn').style.display = isTeacher ? 'block' : 'none';
            document.getElementById('quickScoreSection').style.display = isTeacher ? 'block' : 'none';
            
            // é¡¯ç¤º/éš±è—å­¸ç”ŸåŠŸèƒ½æŒ‰éˆ•
            document.getElementById('messageboardBtn').style.display = isStudent ? 'flex' : 'none';
            document.getElementById('scoreQueryBtn').style.display = isStudent ? 'flex' : 'none';
            document.getElementById('rewardExchangeBtn').style.display = isStudent ? 'flex' : 'none';
            document.getElementById('studentQuizBtn').style.display = isStudent ? 'flex' : 'none';

            // å¦‚æœä¸æ˜¯æ•™å¸«ä¸”åœ¨ç®¡ç†é é¢ï¼Œåˆ‡æ›åˆ°é¦–é 
            if (!isTeacher && (!document.getElementById('manageContent').classList.contains('hidden') || 
                              !document.getElementById('messagesContent').classList.contains('hidden') ||
                              !document.getElementById('scoreHistoryContent').classList.contains('hidden') ||
                              !document.getElementById('rewardManageContent').classList.contains('hidden') ||
                              !document.getElementById('quizManageContent').classList.contains('hidden'))) {
                showTab('home');
            }

            // æ›´æ–°æ¨™é¡Œç·¨è¼¯æ¬Šé™
            const titleElement = document.getElementById('classTitle');
            if (isTeacher) {
                titleElement.style.cursor = 'pointer';
                titleElement.title = 'é»æ“Šç·¨è¼¯ç­ç´šåç¨±';
            } else {
                titleElement.style.cursor = 'default';
                titleElement.title = '';
            }
        }

        // åˆ†é åˆ‡æ›å‡½æ•¸
        function showManageTab() {
            if (currentUser !== 'teacher') return;
            
            document.getElementById('homeContent').classList.add('hidden');
            document.getElementById('manageContent').classList.remove('hidden');
            document.getElementById('messagesContent').classList.add('hidden');
            document.getElementById('scoreHistoryContent').classList.add('hidden');
            document.getElementById('rewardManageContent').classList.add('hidden');
            document.getElementById('quizManageContent').classList.add('hidden');
            updateSelects();
            updateGroupStatus();
        }

        function showMessagesTab() {
            if (currentUser !== 'teacher') return;
            
            document.getElementById('homeContent').classList.add('hidden');
            document.getElementById('manageContent').classList.add('hidden');
            document.getElementById('messagesContent').classList.remove('hidden');
            document.getElementById('scoreHistoryContent').classList.add('hidden');
            document.getElementById('rewardManageContent').classList.add('hidden');
            document.getElementById('quizManageContent').classList.add('hidden');
            updateTeacherMessages();
        }

        function showScoreHistoryTab() {
            if (currentUser !== 'teacher') return;
            
            document.getElementById('homeContent').classList.add('hidden');
            document.getElementById('manageContent').classList.add('hidden');
            document.getElementById('messagesContent').classList.add('hidden');
            document.getElementById('scoreHistoryContent').classList.remove('hidden');
            document.getElementById('rewardManageContent').classList.add('hidden');
            document.getElementById('quizManageContent').classList.add('hidden');
            updateScoreHistoryFilter();
            updateScoreHistory();
        }

        function showRewardManageTab() {
            if (currentUser !== 'teacher') return;
            
            document.getElementById('homeContent').classList.add('hidden');
            document.getElementById('manageContent').classList.add('hidden');
            document.getElementById('messagesContent').classList.add('hidden');
            document.getElementById('scoreHistoryContent').classList.add('hidden');
            document.getElementById('rewardManageContent').classList.remove('hidden');
            document.getElementById('quizManageContent').classList.add('hidden');
            updateRewardManageList();
            updateExchangeRequests();
        }

        function showQuizManageTab() {
            if (currentUser !== 'teacher') return;
            
            document.getElementById('homeContent').classList.add('hidden');
            document.getElementById('manageContent').classList.add('hidden');
            document.getElementById('messagesContent').classList.add('hidden');
            document.getElementById('scoreHistoryContent').classList.add('hidden');
            document.getElementById('rewardManageContent').classList.add('hidden');
            document.getElementById('quizManageContent').classList.remove('hidden');
            updateCurrentQuizList();
        }

        function showHomeTab() {
            document.getElementById('homeContent').classList.remove('hidden');
            document.getElementById('manageContent').classList.add('hidden');
            document.getElementById('messagesContent').classList.add('hidden');
            document.getElementById('scoreHistoryContent').classList.add('hidden');
            document.getElementById('rewardManageContent').classList.add('hidden');
            document.getElementById('quizManageContent').classList.add('hidden');
        }

        // åˆ†é åˆ‡æ› (ä¿ç•™èˆŠå‡½æ•¸ä»¥é˜²å…¶ä»–åœ°æ–¹ä½¿ç”¨)
        function showTab(tab) {
            if (tab === 'home') {
                showHomeTab();
            } else if (tab === 'manage' && currentUser === 'teacher') {
                showManageTab();
            } else if (tab === 'messages' && currentUser === 'teacher') {
                showMessagesTab();
            }
        }

        // ç·¨è¼¯æ¨™é¡Œ
        function editTitle() {
            if (currentUser !== 'teacher') return;
            
            const newTitle = prompt('è«‹è¼¸å…¥æ–°çš„ç­ç´šåç¨±ï¼š', classTitle);
            if (newTitle && newTitle.trim()) {
                classTitle = newTitle.trim();
                document.getElementById('classTitle').textContent = classTitle;
                google.script.run.setStorage('classTitle', classTitle);
            }
        }

        // è¼‰å…¥è³‡æ–™
        function loadData() {
            const keys = ['groups','students','announcements','classTitle','loginAttempts','lockoutTime','teacherPassword','studentMessages','scoreHistory','rewards','exchangeRequests','quizzes','quizAnswers'];
            let loaded = 0;
            const expected = keys.length;
            // finalize function to run once all keys have been processed (success or failure)
            function finalizeLoad() {
                // ensure defaults
                groups = groups || [];
                students = students || [];
                announcements = announcements || [];
                studentMessages = studentMessages || [];
                scoreHistory = scoreHistory || [];
                rewards = rewards || [];
                exchangeRequests = exchangeRequests || [];
                quizzes = quizzes || [];
                quizAnswers = quizAnswers || [];
                classTitle = classTitle || 'ç­ç´šç®¡ç†ç³»çµ±';
                document.getElementById('classTitle').textContent = classTitle;
                // update UI
                updateRankings();
                updateAnnouncements();
                updateSelects();
                updateGroupStatus();
                updateTeacherMessages();
                updateCurrentQuizList();
                updateRewardManageList();
                updateQuizHistory();
                updateTeacherExchangeHistoryFilters();
                updateTeacherExchangeHistory();
            }
            keys.forEach(function(key){
                google.script.run
                    .withSuccessHandler(function(value){
                        try {
                            if (value !== null && value !== undefined) {
                                switch(key) {
                                    case 'groups': groups = value; break;
                                    case 'students': students = value; break;
                                    case 'announcements': announcements = value; break;
                                    case 'classTitle': classTitle = value; break;
                                    case 'loginAttempts': loginAttempts = parseInt(value) || 0; break;
                                    case 'lockoutTime': lockoutTime = parseInt(value) || 0; break;
                                    case 'teacherPassword': teacherPassword = value || teacherPassword; break;
                                    case 'studentMessages': studentMessages = value; break;
                                    case 'scoreHistory': scoreHistory = value; break;
                                    case 'rewards': rewards = value; break;
                                    case 'exchangeRequests': exchangeRequests = value; break;
                                    case 'quizzes': quizzes = value; break;
                                    case 'quizAnswers': quizAnswers = value; break;
                                }
                            }
                        } catch(e) {
                            console.error('loadData parse error for', key, e);
                        }
                        loaded++;
                        if (loaded === expected) {
                            finalizeLoad();
                        }
                    })
                    .withFailureHandler(function(err){
                        console.error('loadData failed for', key, err);
                        loaded++;
                        if (loaded === expected) {
                            finalizeLoad();
                        }
                    })
                    .getStorage(key);
            });
        }

        // è¡¨æ ¼æ“ä½œå‡½æ•¸
        function addTableRow() {
            const tbody = document.getElementById('groupTableBody');
            const header = document.getElementById('tableHeader');
            const rowCount = tbody.children.length;
            const columnCount = header.children.length - 2; // æ‰£é™¤å°çµ„åç¨±å’Œæ“ä½œæ¬„ä½
            
            const newRow = document.createElement('tr');
            let rowHTML = `
                <td class="px-2 py-2 border-t">
                    <input type="text" placeholder="ç¬¬${rowCount + 1}çµ„" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                </td>
            `;
            
            // æ ¹æ“šç›®å‰çš„æ¬„ä½æ•¸é‡å‹•æ…‹ç”Ÿæˆå­¸ç”Ÿæ¬„ä½
            for (let i = 1; i <= columnCount; i++) {
                rowHTML += `
                    <td class="px-2 py-2 border-t">
                        <input type="text" placeholder="å­¸ç”Ÿå§“å" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                    </td>
                `;
            }
            
            rowHTML += `
                <td class="px-2 py-2 border-t text-center">
                    <button onclick="removeTableRow(this)" class="text-red-500 hover:text-red-700">ğŸ—‘ï¸</button>
                </td>
            `;
            
            newRow.innerHTML = rowHTML;
            tbody.appendChild(newRow);
        }

        function addStudentColumn() {
            const header = document.getElementById('tableHeader');
            const tbody = document.getElementById('groupTableBody');
            const currentColumns = header.children.length - 2; // æ‰£é™¤å°çµ„åç¨±å’Œæ“ä½œæ¬„ä½
            const newColumnNumber = currentColumns + 1;
            
            // åœ¨è¡¨é ­æ–°å¢å­¸ç”Ÿæ¬„ä½ï¼ˆåœ¨æ“ä½œæ¬„ä½ä¹‹å‰ï¼‰
            const newHeaderCell = document.createElement('th');
            newHeaderCell.className = 'px-2 py-2 text-left font-semibold text-gray-700';
            newHeaderCell.textContent = `å­¸ç”Ÿ${newColumnNumber}`;
            header.insertBefore(newHeaderCell, header.lastElementChild);
            
            // ç‚ºæ¯ä¸€è¡Œæ–°å¢å­¸ç”Ÿæ¬„ä½
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                const newCell = document.createElement('td');
                newCell.className = 'px-2 py-2 border-t';
                newCell.innerHTML = `
                    <input type="text" placeholder="å­¸ç”Ÿå§“å" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                `;
                row.insertBefore(newCell, row.lastElementChild);
            });
        }

        function removeStudentColumn() {
            const header = document.getElementById('tableHeader');
            const tbody = document.getElementById('groupTableBody');
            const currentColumns = header.children.length - 2; // æ‰£é™¤å°çµ„åç¨±å’Œæ“ä½œæ¬„ä½
            
            // è‡³å°‘è¦ä¿ç•™ä¸€å€‹å­¸ç”Ÿæ¬„ä½
            if (currentColumns <= 1) {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹å­¸ç”Ÿæ¬„ä½');
                return;
            }
            
            // ç§»é™¤è¡¨é ­æœ€å¾Œä¸€å€‹å­¸ç”Ÿæ¬„ä½ï¼ˆæ“ä½œæ¬„ä½çš„å‰ä¸€å€‹ï¼‰
            const lastStudentHeader = header.children[header.children.length - 2];
            header.removeChild(lastStudentHeader);
            
            // ç§»é™¤æ¯ä¸€è¡Œçš„æœ€å¾Œä¸€å€‹å­¸ç”Ÿæ¬„ä½
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                const lastStudentCell = row.children[row.children.length - 2];
                row.removeChild(lastStudentCell);
            });
        }

        function removeTableRow(button) {
            // å¦‚æœæ˜¯æŒ‰éˆ•å‘¼å«ï¼ˆæ²’æœ‰åƒæ•¸ï¼‰ï¼Œç§»é™¤æœ€å¾Œä¸€è¡Œ
            if (!button) {
                const tbody = document.getElementById('groupTableBody');
                if (tbody.children.length > 1) {
                    tbody.removeChild(tbody.lastElementChild);
                } else {
                    alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€è¡Œ');
                }
                return;
            }
            
            // å¦‚æœæ˜¯å¾è¡Œå…§åˆªé™¤æŒ‰éˆ•å‘¼å«ï¼ˆæœ‰åƒæ•¸ï¼‰ï¼Œç§»é™¤è©²è¡Œ
            const tbody = document.getElementById('groupTableBody');
            if (tbody.children.length > 1) {
                button.closest('tr').remove();
            } else {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€è¡Œ');
            }
        }



        function createClassGroupsFromTable() {
            const tbody = document.getElementById('groupTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            let successCount = 0;
            let errorMessages = [];
            
            rows.forEach((row, index) => {
                const groupInput = row.querySelector('td:first-child input');
                const groupName = groupInput.value.trim();
                
                if (!groupName) {
                    return; // è·³éæ²’æœ‰å°çµ„åç¨±çš„è¡Œ
                }
                
                // æ”¶é›†è©²è¡Œæ‰€æœ‰å­¸ç”Ÿå§“å
                const studentInputs = row.querySelectorAll('td:not(:first-child):not(:last-child) input');
                const studentNames = [];
                
                studentInputs.forEach(input => {
                    const name = input.value.trim();
                    if (name) {
                        studentNames.push(name);
                    }
                });
                
                if (studentNames.length === 0) {
                    errorMessages.push(`ç¬¬ ${index + 1} è¡Œï¼šå°çµ„ ${groupName} æ²’æœ‰å­¸ç”Ÿ`);
                    return;
                }
                
                // æª¢æŸ¥æ˜¯å¦æœ‰é‡è¤‡çš„å­¸ç”Ÿ
                for (let studentName of studentNames) {
                    if (students.find(s => s.name === studentName)) {
                        errorMessages.push(`ç¬¬ ${index + 1} è¡Œï¼šå­¸ç”Ÿ ${studentName} å·²å­˜åœ¨`);
                        return;
                    }
                }
                
                // å»ºç«‹æˆ–æ‰¾åˆ°å°çµ„
                let group = groups.find(g => g.name === groupName);
                if (!group) {
                    group = {
                        id: Date.now() + Math.random(),
                        name: groupName,
                        score: 0
                    };
                    groups.push(group);
                }
                
                // å»ºç«‹è©²çµ„æ‰€æœ‰å­¸ç”Ÿ
                studentNames.forEach(studentName => {
                    students.push({
                        id: Date.now() + Math.random() + Math.random(),
                        name: studentName,
                        groupId: group.id,
                        groupName: groupName,
                        score: 0
                    });
                    successCount++;
                });
            });
            
            if (errorMessages.length > 0) {
                alert('å»ºç«‹éç¨‹ä¸­ç™¼ç¾éŒ¯èª¤ï¼š\n' + errorMessages.join('\n'));
            }
            
            if (successCount > 0) {
                google.script.run.setStorage('groups', groups);
                google.script.run.setStorage('students', students);
                
                // æ¸…ç©ºè¡¨æ ¼
                const tbody = document.getElementById('groupTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td class="px-2 py-2 border-t">
                            <input type="text" placeholder="ç¬¬ä¸€çµ„" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                        </td>
                        <td class="px-2 py-2 border-t">
                            <input type="text" placeholder="ç‹å°æ˜" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                        </td>
                        <td class="px-2 py-2 border-t">
                            <input type="text" placeholder="æå°è¯" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                        </td>
                        <td class="px-2 py-2 border-t">
                            <input type="text" placeholder="å¼µå°ç¾" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                        </td>
                        <td class="px-2 py-2 border-t">
                            <input type="text" placeholder="é™³å°å¼·" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                        </td>
                        <td class="px-2 py-2 border-t">
                            <input type="text" placeholder="æ—å°é›…" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                        </td>
                        <td class="px-2 py-2 border-t text-center">
                            <button onclick="removeTableRow(this)" class="text-red-500 hover:text-red-700">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `;
                
                updateRankings();
                updateSelects();
                updateGroupStatus();
                alert(`æˆåŠŸå»ºç«‹ ${successCount} ä½å­¸ç”Ÿï¼`);
            }
        }

        // æ›´æ–°åˆ†çµ„ç‹€æ³é¡¯ç¤º
        function updateGroupStatus() {
            const container = document.getElementById('currentGroupStatus');
            
            if (groups.length === 0 || students.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">ğŸ‘¥</div>
                        <p>å°šæœªå»ºç«‹åˆ†çµ„</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = groups.map(group => {
                // compare groupId as strings to avoid number/string mismatch
                const groupStudents = students.filter(s => String(s.groupId) === String(group.id));
                
                return `
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-3">
                                <h5 class="font-semibold text-gray-800 text-lg">${group.name}</h5>
                                <span class="text-sm text-gray-500">(${groupStudents.length} äºº)</span>
                                <span class="text-sm font-medium text-blue-600">${group.score} åˆ†</span>
                            </div>
                            <button onclick="deleteGroup('${group.id}')" class="text-red-500 hover:text-red-700 text-xl" title="åˆªé™¤å°çµ„">ğŸ—‘ï¸</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                            ${groupStudents.map(student => `
                                <div class="bg-white rounded-lg p-3 border border-gray-200 flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-gray-800">${student.name}</span>
                                        <span class="text-xs text-gray-500">${student.score} åˆ†</span>
                                    </div>
                                    <button onclick="deleteStudent('${student.id}')" class="text-red-500 hover:text-red-700 text-sm" title="åˆªé™¤å­¸ç”Ÿ">ğŸ—‘ï¸</button>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- æ–°å¢å­¸ç”Ÿåˆ°æ­¤çµ„ -->
                        <div class="mt-3 pt-3 border-t border-gray-300">
                            <div class="flex space-x-2">
                                <input type="text" id="newStudent-${group.id}" placeholder="æ–°å¢å­¸ç”Ÿåˆ° ${group.name}" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button onclick="addStudentToGroup('${group.id}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm transition-colors">
                                    â• æ–°å¢
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // é‡æ–°æ•´ç†åˆ†çµ„ç‹€æ³
        function refreshGroupStatus() {
            updateGroupStatus();
        }

        // ç·¨è¼¯å°çµ„åç¨±
        function editGroupName(groupId) {
            console.log('ç·¨è¼¯å°çµ„åç¨±ï¼ŒID:', groupId);
            const group = groups.find(g => g.id == groupId);
            if (!group) {
                console.log('æ‰¾ä¸åˆ°å°çµ„');
                return;
            }

            const newName = prompt('è«‹è¼¸å…¥æ–°çš„å°çµ„åç¨±ï¼š', group.name);
            if (newName && newName.trim() && newName.trim() !== group.name) {
                const trimmedName = newName.trim();
                
                // æª¢æŸ¥æ˜¯å¦æœ‰é‡è¤‡çš„å°çµ„åç¨±
                if (groups.some(g => g.id != groupId && g.name === trimmedName)) {
                    alert('å°çµ„åç¨±å·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨å…¶ä»–åç¨±');
                    return;
                }

                group.name = trimmedName;
                
                // åŒæ™‚æ›´æ–°è©²çµ„æ‰€æœ‰å­¸ç”Ÿçš„ groupName
                students.forEach(student => {
                    if (student.groupId == groupId) {
                        student.groupName = trimmedName;
                    }
                });

                google.script.run.setStorage('groups', groups);
                google.script.run.setStorage('students', students);
                
                updateGroupStatus();
                updateRankings();
                updateSelects();
                alert('å°çµ„åç¨±å·²æ›´æ–°ï¼');
            }
        }

        // åˆªé™¤å°çµ„
        function deleteGroup(groupId) {
            console.log('åˆªé™¤å°çµ„ï¼ŒID:', groupId);
            const group = groups.find(g => g.id.toString() === groupId.toString());
            if (!group) {
                console.log('æ‰¾ä¸åˆ°å°çµ„');
                return;
            }

            const groupStudents = students.filter(s => s.groupId.toString() === groupId.toString());
            
            if (groupStudents.length > 0) {
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤å°çµ„ã€Œ${group.name}ã€å—ï¼Ÿ\né€™å°‡åŒæ™‚åˆªé™¤è©²çµ„çš„ ${groupStudents.length} ä½å­¸ç”Ÿã€‚`)) {
                    return;
                }
            } else {
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤å°çµ„ã€Œ${group.name}ã€å—ï¼Ÿ`)) {
                    return;
                }
            }

            // åˆªé™¤å°çµ„å’Œè©²çµ„æ‰€æœ‰å­¸ç”Ÿ
            groups = groups.filter(g => g.id.toString() !== groupId.toString());
            try { google.script.run.deleteStorage('groups', groupId); } catch(e) { console.error(e); }
            students = students.filter(s => s.groupId.toString() !== groupId.toString());
            try { groupStudents.forEach(function(s){ google.script.run.deleteStorage('students', s.id); }); } catch(e) { console.error(e); }

            google.script.run.setStorage('groups', groups);
            google.script.run.setStorage('students', students);
            
            updateGroupStatus();
            updateRankings();
            updateSelects();
            alert('å°çµ„å·²åˆªé™¤ï¼');
        }

        // ç·¨è¼¯å­¸ç”Ÿå§“å
        function editStudentName(studentId) {
            console.log('ç·¨è¼¯å­¸ç”Ÿå§“åï¼ŒID:', studentId);
            const student = students.find(s => s.id == studentId);
            if (!student) {
                console.log('æ‰¾ä¸åˆ°å­¸ç”Ÿ');
                return;
            }

            const newName = prompt('è«‹è¼¸å…¥æ–°çš„å­¸ç”Ÿå§“åï¼š', student.name);
            if (newName && newName.trim() && newName.trim() !== student.name) {
                const trimmedName = newName.trim();
                
                // æª¢æŸ¥æ˜¯å¦æœ‰é‡è¤‡çš„å­¸ç”Ÿå§“å
                if (students.some(s => s.id != studentId && s.name === trimmedName)) {
                    alert('å­¸ç”Ÿå§“åå·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨å…¶ä»–å§“å');
                    return;
                }

                student.name = trimmedName;
                google.script.run.setStorage('students', students);
                
                updateGroupStatus();
                updateRankings();
                updateSelects();
                alert('å­¸ç”Ÿå§“åå·²æ›´æ–°ï¼');
            }
        }

        // ç§»å‹•å­¸ç”Ÿåˆ°å…¶ä»–çµ„
        function moveStudent(studentId) {
            console.log('ç§»å‹•å­¸ç”Ÿï¼ŒID:', studentId);
            const student = students.find(s => s.id == studentId);
            if (!student) {
                console.log('æ‰¾ä¸åˆ°å­¸ç”Ÿ');
                return;
            }

            // å»ºç«‹å…¶ä»–å°çµ„çš„é¸é …
            const otherGroups = groups.filter(g => g.id != student.groupId);
            if (otherGroups.length === 0) {
                alert('æ²’æœ‰å…¶ä»–å°çµ„å¯ä»¥ç§»å‹•');
                return;
            }

            let options = 'è«‹é¸æ“‡è¦ç§»å‹•åˆ°çš„å°çµ„ï¼š\n';
            otherGroups.forEach((group, index) => {
                options += `${index + 1}. ${group.name}\n`;
            });

            const choice = prompt(options + '\nè«‹è¼¸å…¥æ•¸å­—é¸æ“‡ï¼š');
            const choiceIndex = parseInt(choice) - 1;

            if (choiceIndex >= 0 && choiceIndex < otherGroups.length) {
                const targetGroup = otherGroups[choiceIndex];
                
                student.groupId = targetGroup.id;
                student.groupName = targetGroup.name;
                
                google.script.run.setStorage('students', students);
                
                updateGroupStatus();
                updateRankings();
                updateSelects();
                
                alert(`${student.name} å·²ç§»å‹•åˆ° ${targetGroup.name}`);
            } else {
                alert('é¸æ“‡ç„¡æ•ˆï¼Œè«‹é‡æ–°æ“ä½œ');
            }
        }

        // åˆªé™¤å­¸ç”Ÿ
        function deleteStudent(studentId) {
            console.log('åˆªé™¤å­¸ç”Ÿï¼ŒID:', studentId);
            const student = students.find(s => s.id.toString() === studentId.toString());
            if (!student) {
                console.log('æ‰¾ä¸åˆ°å­¸ç”Ÿ');
                return;
            }

            if (confirm(`ç¢ºå®šè¦åˆªé™¤å­¸ç”Ÿã€Œ${student.name}ã€å—ï¼Ÿ`)) {
                students = students.filter(s => s.id.toString() !== studentId.toString());
                try { google.script.run.deleteStorage('students', studentId); } catch(e) { console.error(e); }
                google.script.run.setStorage('students', students);
                
                updateGroupStatus();
                updateRankings();
                updateSelects();
                alert('å­¸ç”Ÿå·²åˆªé™¤ï¼');
            }
        }

        // æ–°å¢å­¸ç”Ÿåˆ°æŒ‡å®šå°çµ„
        function addStudentToGroup(groupId) {
            const input = document.getElementById(`newStudent-${groupId}`);
            const studentName = input.value.trim();
            
            if (!studentName) {
                alert('è«‹è¼¸å…¥å­¸ç”Ÿå§“å');
                return;
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰é‡è¤‡çš„å­¸ç”Ÿå§“å
            if (students.some(s => s.name === studentName)) {
                alert('å­¸ç”Ÿå§“åå·²å­˜åœ¨');
                input.value = '';
                return;
            }

            const group = groups.find(g => g.id.toString() === groupId.toString());
            if (!group) return;

            const newStudent = {
                id: Date.now() + Math.random(),
                name: studentName,
                groupId: group.id,
                groupName: group.name,
                score: 0
            };

            students.push(newStudent);
            google.script.run.setStorage('students', students);
            
            input.value = '';
            updateGroupStatus();
            updateRankings();
            updateSelects();
        }

        // æ¸…ç©ºæ‰€æœ‰è³‡æ–™
        function clearAllData() {
            if (confirm('âš ï¸ ç¢ºå®šè¦å®Œå…¨é‡ç½®ç­ç´šå—ï¼Ÿ\n\næ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤ï¼š\nâ€¢ æ‰€æœ‰å­¸ç”Ÿè³‡æ–™å’Œåˆ†æ•¸\nâ€¢ æ‰€æœ‰å°çµ„è³‡æ–™å’Œåˆ†æ•¸\nâ€¢ æ‰€æœ‰èª²ç¨‹å…¬å‘Šå’Œç•™è¨€\nâ€¢ æ‰€æœ‰å­¸ç”Ÿç•™è¨€è¨˜éŒ„\nâ€¢ ç­ç´šåç¨±å°‡é‡ç½®ç‚ºé è¨­å€¼\n\nâš ï¸ æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼è«‹ç¢ºèªå¾Œå†ç¹¼çºŒã€‚')) {
                
                // å¦‚æœæœ‰ç™»å…¥çš„å­¸ç”Ÿï¼Œå…ˆç™»å‡º
                if (currentUser === 'student') {
                    logout();
                }
                
                // å®Œå…¨æ¸…ç©ºæ‰€æœ‰è³‡æ–™
                groups = [];
                students = [];
                announcements = [];
                studentMessages = [];
                
                // é‡ç½®ç­ç´šåç¨±ç‚ºé è¨­å€¼
                classTitle = 'ç­ç´šç®¡ç†ç³»çµ±';
                document.getElementById('classTitle').textContent = classTitle;
                
                // æ¸…ç©ºæœ¬åœ°å­˜å„²ä¸­çš„æ‰€æœ‰ç›¸é—œè³‡æ–™
                google.script.run.setStorage('groups', []);
                google.script.run.setStorage('students', []);
                google.script.run.setStorage('announcements', []);
                google.script.run.setStorage('studentMessages', []);
                google.script.run.setStorage('classTitle', classTitle);
                
                // é‡ç½®æ‰€æœ‰å…¨åŸŸè®Šæ•¸
                currentMessageFilter = 'all';
                currentRankingMode = 'group';
                
                // æ›´æ–°æ‰€æœ‰UIé¡¯ç¤º
                updateRankings();
                updateSelects();
                updateGroupStatus();
                updateAnnouncements();
                updateTeacherMessages();
                
                // é‡ç½®æ’è¡Œæ¦œæ¨¡å¼æŒ‰éˆ•
                switchRankingMode('group');
                
                // é‡ç½®ç•™è¨€ç¯©é¸æŒ‰éˆ•
                filterMessages('all');
                
                // ç¢ºä¿å›åˆ°é¦–é 
                showHomeTab();
                
                alert('âœ… ç­ç´šè³‡æ–™å·²å®Œå…¨æ¸…ç©ºï¼\nç³»çµ±å·²é‡ç½®ç‚ºåˆå§‹ç‹€æ…‹ã€‚');
            }
        }

        // åˆªé™¤å–®ä¸€å°çµ„
        function deleteGroup(groupId) {
            const group = groups.find(g => g.id == groupId);
            if (!group) return;

            const groupStudents = students.filter(s => s.groupId == groupId);
            
            if (groupStudents.length > 0) {
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤å°çµ„ã€Œ${group.name}ã€å—ï¼Ÿ\né€™å°‡åŒæ™‚åˆªé™¤è©²çµ„çš„ ${groupStudents.length} ä½å­¸ç”Ÿã€‚`)) {
                    return;
                }
            } else {
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤å°çµ„ã€Œ${group.name}ã€å—ï¼Ÿ`)) {
                    return;
                }
            }

            // åˆªé™¤å°çµ„å’Œè©²çµ„æ‰€æœ‰å­¸ç”Ÿ
            groups = groups.filter(g => g.id != groupId);
            students = students.filter(s => s.groupId != groupId);

            google.script.run.setStorage('groups', groups);
            google.script.run.setStorage('students', students);
            
            updateGroupStatus();
            updateRankings();
            updateSelects();
            alert('å°çµ„å·²åˆªé™¤ï¼');
        }

        // æ›´æ–°é¸æ“‡å™¨
        function updateSelects() {
            const groupSelect = document.getElementById('groupSelect');
            const studentSelect = document.getElementById('studentSelect');

            groupSelect.innerHTML = '<option value="">é¸æ“‡å°çµ„</option>';
            groups.forEach(group => {
                groupSelect.innerHTML += `<option value="${group.id}">${group.name}</option>`;
            });

            studentSelect.innerHTML = '<option value="">é¸æ“‡å­¸ç”Ÿ</option>';
            students.forEach(student => {
                studentSelect.innerHTML += `<option value="${student.id}">${student.name} (${student.groupName})</option>`;
            });
        }

        // å°çµ„åŠ åˆ†
        function addGroupScore() {
            const groupId = document.getElementById('groupSelect').value;
            const score = parseInt(document.getElementById('groupScore').value);
            
            if (!groupId || !score) return;

            modifyGroupScore(groupId, score);
        }

        // å°çµ„æ‰£åˆ†
        function subtractGroupScore() {
            const groupId = document.getElementById('groupSelect').value;
            const score = parseInt(document.getElementById('groupScore').value);
            
            if (!groupId || !score) return;

            modifyGroupScore(groupId, -score);
        }

        // ä¿®æ”¹å°çµ„åˆ†æ•¸
        function modifyGroupScore(groupId, scoreChange) {
            const group = groups.find(g => g.id == groupId);
            if (!group) return;

            group.score += scoreChange;
            
            // è¨˜éŒ„åˆ†æ•¸è®ŠåŒ–
            const historyRecord = {
                id: Date.now(),
                type: 'group',
                targetId: groupId,
                targetName: group.name,
                scoreChange: scoreChange,
                reason: scoreChange > 0 ? 'å°çµ„åŠ åˆ†' : 'å°çµ„æ‰£åˆ†',
                date: new Date().toLocaleString('zh-TW'),
                affectedStudents: []
            };
            
            // åŒæ™‚æ›´æ–°è©²çµ„æ‰€æœ‰å­¸ç”Ÿåˆ†æ•¸
            students.forEach(student => {
                if (student.groupId == groupId) {
                    student.score += scoreChange;
                    historyRecord.affectedStudents.push({
                        id: student.id,
                        name: student.name,
                        scoreChange: scoreChange
                    });
                }
            });

            scoreHistory.unshift(historyRecord);
            google.script.run.setStorage('groups', groups);
            google.script.run.setStorage('students', students);
            google.script.run.setStorage('scoreHistory', scoreHistory);
            
            document.getElementById('groupScore').value = '';
            updateRankings();
        }

        // å€‹äººåŠ åˆ†
        function addStudentScore() {
            const studentId = document.getElementById('studentSelect').value;
            const score = parseInt(document.getElementById('studentScore').value);
            
            if (!studentId || !score) return;

            modifyStudentScore(studentId, score);
        }

        // å€‹äººæ‰£åˆ†
        function subtractStudentScore() {
            const studentId = document.getElementById('studentSelect').value;
            const score = parseInt(document.getElementById('studentScore').value);
            
            if (!studentId || !score) return;

            modifyStudentScore(studentId, -score);
        }

        // ä¿®æ”¹å€‹äººåˆ†æ•¸
        function modifyStudentScore(studentId, scoreChange) {
            const student = students.find(s => s.id == studentId);
            if (!student) return;

            student.score += scoreChange;
            
            // è¨˜éŒ„åˆ†æ•¸è®ŠåŒ–
            const historyRecord = {
                id: Date.now(),
                type: 'individual',
                targetId: studentId,
                targetName: student.name,
                groupName: student.groupName,
                scoreChange: scoreChange,
                reason: scoreChange > 0 ? 'å€‹äººåŠ åˆ†' : 'å€‹äººæ‰£åˆ†',
                date: new Date().toLocaleString('zh-TW'),
                affectedStudents: [{
                    id: student.id,
                    name: student.name,
                    scoreChange: scoreChange
                }]
            };

            scoreHistory.unshift(historyRecord);
            google.script.run.setStorage('students', students);
            google.script.run.setStorage('scoreHistory', scoreHistory);
            
            document.getElementById('studentScore').value = '';
            updateRankings();
        }

        // æ’è¡Œæ¦œæ¨¡å¼åˆ‡æ›
        function switchRankingMode(mode) {
            currentRankingMode = mode;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            const groupBtn = document.getElementById('groupRankBtn');
            const individualBtn = document.getElementById('individualRankBtn');
            
            // é‡ç½®æ‰€æœ‰æŒ‰éˆ•æ¨£å¼
            groupBtn.className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors';
            individualBtn.className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors';
            
            // è¨­ç½®é¸ä¸­çš„æŒ‰éˆ•æ¨£å¼
            if (mode === 'group') {
                groupBtn.className = 'px-4 py-2 rounded-lg bg-blue-500 text-white transition-colors';
            } else {
                individualBtn.className = 'px-4 py-2 rounded-lg bg-blue-500 text-white transition-colors';
            }
            
            // å…ˆé‡ç½®é ’çå°ï¼Œç„¶å¾Œæ›´æ–°æ’è¡Œæ¦œ
            resetPodium();
            setTimeout(() => {
                updateRankings();
            }, 100);
        }

        // æ›´æ–°æ’è¡Œæ¦œ
        function updateRankings() {
            if (currentRankingMode === 'group') {
                updateGroupRankings();
            } else {
                updateIndividualRankings();
            }
        }

        // æ›´æ–°å°çµ„æ’è¡Œæ¦œ
        function updateGroupRankings() {
            if (groups.length === 0) {
                resetPodium();
                return;
            }

            const sortedGroups = [...groups].sort((a, b) => b.score - a.score);
            updatePodiumDisplay(sortedGroups, 'group');
        }

        // æ›´æ–°å€‹äººæ’è¡Œæ¦œ
        function updateIndividualRankings() {
            if (students.length === 0) {
                resetPodium();
                return;
            }

            const sortedStudents = [...students].sort((a, b) => b.score - a.score);
            updatePodiumDisplay(sortedStudents, 'individual');
        }

        // é‡ç½®é ’çå°
        function resetPodium() {
            // éš±è—æ‰€æœ‰é ’çå°å…ƒç´ 
            for (let i = 1; i <= 3; i++) {
                const infoElement = document.getElementById(`rank${i}Info`);
                const podiumElement = document.getElementById(`podium${i}`);
                
                if (infoElement) {
                    infoElement.style.opacity = '0';
                    infoElement.style.transform = 'translateY(4px)';
                }
                
                if (podiumElement) {
                    podiumElement.style.transform = 'scaleY(0)';
                    podiumElement.style.height = '0px';
                }
            }
            
            // æ¸…ç©ºç¬¬å››ç¬¬äº”å
            const otherRankings = document.getElementById('otherRankings');
            if (otherRankings) {
                otherRankings.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">ğŸ“Š</div>
                        <p id="emptyMessage">${currentRankingMode === 'group' ? 'å°šæœªå»ºç«‹å°çµ„' : 'å°šæœªå»ºç«‹å­¸ç”Ÿ'}</p>
                    </div>
                `;
            }
        }

        // æ›´æ–°é ’çå°é¡¯ç¤º
        function updatePodiumDisplay(sortedData, type) {
            // å…ˆé‡ç½®
            resetPodium();
            
            if (sortedData.length === 0) return;
            
            // åªé¡¯ç¤ºå‰ä¸‰ååœ¨é ’çå°ä¸Š
            const topThree = sortedData.slice(0, 3);
            
            // è¨ˆç®—é«˜åº¦æ¯”ä¾‹ - åŸºæ–¼åˆ†æ•¸å·®è·
            const maxScore = topThree.length > 0 ? topThree[0].score : 0;
            const minScore = topThree.length > 0 ? Math.min(...topThree.map(item => item.score)) : 0;
            const scoreRange = maxScore - minScore;
            
            // è¨­å®šé«˜åº¦ç¯„åœ
            const baseHeight = 80;  // åŸºç¤é«˜åº¦
            const maxExtraHeight = 60; // æœ€å¤§é¡å¤–é«˜åº¦
            
            setTimeout(() => {
                // åŒæ™‚é–‹å§‹æ‰€æœ‰é ’çå°å‹•ç•«
                topThree.forEach((item, index) => {
                    const rank = index + 1;
                    
                    // è¨ˆç®—ç›¸å°é«˜åº¦
                    let height = baseHeight;
                    if (scoreRange > 0) {
                        const scoreRatio = (item.score - minScore) / scoreRange;
                        height = baseHeight + (maxExtraHeight * scoreRatio);
                    }
                    
                    // ç¬¬ä¸€åé¡å¤–åŠ é«˜
                    if (rank === 1) {
                        height += 20;
                    }
                    
                    // æ›´æ–°è³‡è¨Š
                    const infoElement = document.getElementById(`rank${rank}Info`);
                    const nameDiv = infoElement.children[1];
                    const detailDiv = infoElement.children[2];
                    const scoreDiv = infoElement.children[3];
                    
                    if (type === 'group') {
                        nameDiv.textContent = item.name;
                        detailDiv.textContent = ''; // å°çµ„æ’è¡Œä¸é¡¯ç¤ºäººæ•¸
                    } else {
                        nameDiv.textContent = item.name;
                        detailDiv.textContent = ''; // å€‹äººæ’è¡Œä¸é¡¯ç¤ºçµ„å
                    }
                    scoreDiv.textContent = `${item.score} åˆ†`;
                    
                    // è¨­ç½®æœ€çµ‚é«˜åº¦
                    const podiumElement = document.getElementById(`podium${rank}`);
                    podiumElement.style.height = `${height}px`;
                    
                    // åŒæ™‚è§¸ç™¼æ‰€æœ‰å‹•ç•«ï¼ˆç„¡å»¶é²å·®ï¼‰
                    setTimeout(() => {
                        podiumElement.style.transform = 'scaleY(1)';
                        infoElement.style.opacity = '1';
                        infoElement.style.transform = 'translateY(0)';
                    }, 300); // çµ±ä¸€å»¶é²
                });
            }, 200);
            
            // æ›´æ–°ç¬¬å››ç¬¬äº”åï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            setTimeout(() => {
                updateOtherRankings(sortedData, type);
            }, 1500);
        }

        // æ›´æ–°ç¬¬å››ç¬¬äº”åæ’è¡Œ
        function updateOtherRankings(sortedData, type) {
            const container = document.getElementById('otherRankings');
            const otherRanks = sortedData.slice(3, 5); // åªå–ç¬¬å››ç¬¬äº”å
            
            if (otherRanks.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = otherRanks.map((item, index) => {
                const rank = index + 4; // ç¬¬å››åé–‹å§‹
                
                return `
                    <div class="rank-animation bg-gray-50 rounded-xl p-4 flex items-center justify-between opacity-0 transform translate-y-4" style="animation: slideInUp 0.6s ease-out ${index * 0.2}s forwards;">
                        <div class="flex items-center space-x-4">
                            <div class="text-2xl font-bold text-gray-600">${rank}</div>
                            <div>
                                <div class="font-semibold text-gray-800">${item.name}</div>
                            </div>
                        </div>
                        <div class="text-2xl font-bold text-gray-800">${item.score} åˆ†</div>
                    </div>
                `;
            }).join('');
        }

        // å…¬å‘Šç›¸é—œå‡½æ•¸
        function showAnnouncementForm() {
            document.getElementById('announcementForm').classList.remove('hidden');
        }

        function hideAnnouncementForm() {
            document.getElementById('announcementForm').classList.add('hidden');
            document.getElementById('announcementTitle').value = '';
            document.getElementById('announcementContent').value = '';
            document.getElementById('announcementLink').value = '';
        }

        function addAnnouncement() {
            const title = document.getElementById('announcementTitle').value.trim();
            const content = document.getElementById('announcementContent').value.trim();
            const link = document.getElementById('announcementLink').value.trim();

            if (!title || !content) return;

            const announcement = {
                id: Date.now(),
                title: title,
                content: content,
                link: link,
                date: new Date().toLocaleDateString('zh-TW'),
                comments: []
            };

            announcements.unshift(announcement);
            google.script.run.setStorage('announcements', announcements);
            
            hideAnnouncementForm();
            updateAnnouncements();
        }

        function updateAnnouncements() {
            const container = document.getElementById('announcements');
            
            if (announcements.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">ğŸ“</div>
                        <p>å°šç„¡èª²ç¨‹å…¬å‘Š</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = announcements.map(announcement => `
                <div class="border border-gray-200 rounded-xl p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">${announcement.title}</h3>
                            <p class="text-sm text-gray-500">${announcement.date}</p>
                        </div>
                        ${currentUser === 'teacher' ? `<button onclick="deleteAnnouncement('${announcement.id}')" class="text-red-500 hover:text-red-700">ğŸ—‘ï¸</button>` : ''}
                    </div>
                    <p class="text-gray-700 mb-4 whitespace-pre-wrap">${announcement.content}</p>
                    ${announcement.link ? `<a href="${announcement.link}" target="_blank" class="text-blue-500 hover:text-blue-700 underline">ğŸ“ ç›¸é—œé€£çµ</a>` : ''}
                    
                    <!-- ç•™è¨€å€ -->
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <h4 class="font-semibold text-gray-700 mb-3">ğŸ’¬ ç•™è¨€å€</h4>
                        <div class="space-y-3 mb-4">
                            ${announcement.comments.map(comment => `
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="flex justify-between items-start">
                                        <div class="font-medium text-gray-800">${comment.author}</div>
                                        <div class="text-xs text-gray-500">${comment.date}</div>
                                    </div>
                                    <p class="text-gray-700 mt-1">${comment.content}</p>
                                </div>
                            `).join('')}
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" id="comment-${announcement.id}" placeholder="è¼¸å…¥ç•™è¨€..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button onclick="addComment('${announcement.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">ç™¼é€</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function addComment(announcementId) {
            const input = document.getElementById(`comment-${announcementId}`);
            const content = input.value.trim();
            
            if (!content) return;

            // ç”¨å­—ä¸²æ¯”è¼ƒä»¥é¿å…é¡å‹ä¸ä¸€è‡´
            const announcement = announcements.find(a => String(a.id) === String(announcementId));
            if (!announcement) return;

            const comment = {
                id: Date.now(),
                author: currentUser === 'teacher' ? 'è€å¸«' : 'å­¸ç”Ÿ',
                content: content,
                date: new Date().toLocaleString('zh-TW')
            };

            announcement.comments.push(comment);
            google.script.run.setStorage('announcements', announcements);
            
            input.value = '';
            updateAnnouncements();
        }

        function deleteAnnouncement(announcementId) {
            if (currentUser !== 'teacher') return;
            
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å…¬å‘Šå—ï¼Ÿ')) {
                // ç”¨å­—ä¸²æ¯”è¼ƒé¿å…é¡å‹ä¸ä¸€è‡´
                announcements = announcements.filter(a => String(a.id) !== String(announcementId));
                google.script.run.setStorage('announcements', announcements);
                updateAnnouncements();
            }
        }

        // å­¸ç”Ÿåˆ†æ•¸æŸ¥è©¢åŠŸèƒ½
        function showScoreQuery() {
            if (currentUser !== 'student') return;
            
            document.getElementById('scoreQueryModal').classList.remove('hidden');
            document.getElementById('scoreQueryResult').classList.add('hidden');
            document.getElementById('scoreQueryError').classList.add('hidden');
            document.getElementById('scoreQueryName').value = '';
            
            // å¦‚æœå·²ç¶“ç™»å…¥ï¼Œè‡ªå‹•å¡«å…¥å§“å
            if (currentStudent) {
                document.getElementById('scoreQueryName').value = currentStudent.name;
            }
        }

        function closeScoreQueryModal() {
            document.getElementById('scoreQueryModal').classList.add('hidden');
            document.getElementById('scoreQueryResult').classList.add('hidden');
            document.getElementById('scoreQueryError').classList.add('hidden');
            document.getElementById('scoreQueryName').value = '';
        }

        function queryScore() {
            const studentName = document.getElementById('scoreQueryName').value.trim();
            
            // æ¸…é™¤ä¹‹å‰çš„çµæœå’ŒéŒ¯èª¤è¨Šæ¯
            document.getElementById('scoreQueryResult').classList.add('hidden');
            document.getElementById('scoreQueryError').classList.add('hidden');
            
            if (!studentName) {
                document.getElementById('scoreQueryError').textContent = 'è«‹è¼¸å…¥å­¸ç”Ÿå§“å';
                document.getElementById('scoreQueryError').classList.remove('hidden');
                return;
            }

            // æŸ¥æ‰¾å­¸ç”Ÿ
            const student = students.find(s => s.name === studentName);
            if (!student) {
                document.getElementById('scoreQueryError').textContent = 'æ‰¾ä¸åˆ°æ­¤å­¸ç”Ÿï¼Œè«‹ç¢ºèªå§“åæ˜¯å¦æ­£ç¢º';
                document.getElementById('scoreQueryError').classList.remove('hidden');
                return;
            }

            // è¨ˆç®—å€‹äººæ’å
            const sortedStudents = [...students].sort((a, b) => b.score - a.score);
            // use string comparison for id to avoid type mismatch
            const studentRank = sortedStudents.findIndex(s => String(s.id) === String(student.id)) + 1;

            // ç²å–å°çµ„è³‡è¨Š
            const group = groups.find(g => String(g.id) === String(student.groupId));
            const groupScore = group ? group.score : 0;

            // é¡¯ç¤ºçµæœ
            document.getElementById('studentNameDisplay').textContent = student.name;
            document.getElementById('studentGroupDisplay').textContent = student.groupName;
            document.getElementById('studentScoreDisplay').textContent = student.score;
            document.getElementById('studentRankDisplay').textContent = `ç¬¬ ${studentRank} å`;
            document.getElementById('groupScoreDisplay').textContent = `${groupScore} åˆ†`;

            // æ ¹æ“šæ’åè¨­ç½®ä¸åŒçš„é ­åƒ
            const avatarElement = document.getElementById('studentAvatar');
            if (studentRank === 1) {
                avatarElement.textContent = 'ğŸ¥‡';
            } else if (studentRank === 2) {
                avatarElement.textContent = 'ğŸ¥ˆ';
            } else if (studentRank === 3) {
                avatarElement.textContent = 'ğŸ¥‰';
            } else {
                avatarElement.textContent = 'ğŸ‘¨â€ğŸ“';
            }

            // é¡¯ç¤ºçµæœå€åŸŸ
            document.getElementById('scoreQueryResult').classList.remove('hidden');
            
            // æ›´æ–°å­¸ç”Ÿåˆ†æ•¸è®ŠåŒ–è¨˜éŒ„
            updateStudentScoreHistory(student.id);
        }

        // å­¸ç”Ÿç•™è¨€æ¿åŠŸèƒ½
        function showMessageboard() {
            if (currentUser !== 'student') return;
            
            document.getElementById('messageboardModal').classList.remove('hidden');
            document.getElementById('studentMessageForm').classList.remove('hidden');
            updateStudentMessages();
        }

        function closeMessageboardModal() {
            document.getElementById('messageboardModal').classList.add('hidden');
            clearMessageForm();
        }

        function clearMessageForm() {
            document.getElementById('messageContent').value = '';
            document.querySelector('input[name="messageVisibility"][value="private"]').checked = true;
        }

        function postMessage() {
            if (currentUser !== 'student' || !currentStudent) return;
            
            const content = document.getElementById('messageContent').value.trim();
            const visibility = document.querySelector('input[name="messageVisibility"]:checked').value;
            
            if (!content) {
                alert('è«‹è¼¸å…¥ç•™è¨€å…§å®¹');
                return;
            }

            const message = {
                id: Date.now(),
                studentId: currentStudent.id,
                studentName: currentStudent.name,
                groupName: currentStudent.groupName,
                content: content,
                visibility: visibility,
                date: new Date().toLocaleString('zh-TW'),
                replies: []
            };

            studentMessages.unshift(message);
            google.script.run.setStorage('studentMessages', studentMessages);
            
            clearMessageForm();
            updateStudentMessages();
            alert('ç•™è¨€ç™¼å¸ƒæˆåŠŸï¼');
        }

        function updateStudentMessages() {
            const container = document.getElementById('messagesList');
            
            // å­¸ç”Ÿåªèƒ½çœ‹åˆ°è‡ªå·±çš„ç•™è¨€å’Œå…¬é–‹ç•™è¨€
            let visibleMessages = [];
            if (currentUser === 'student' && currentStudent) {
                // Compare studentId as strings to handle number/string mismatches
                visibleMessages = studentMessages.filter(msg => 
                    String(msg.studentId) === String(currentStudent.id) || msg.visibility === 'public'
                );
            } else if (currentUser === 'teacher') {
                visibleMessages = studentMessages;
            }
            
            if (visibleMessages.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">ğŸ“</div>
                        <p>å°šç„¡ç•™è¨€</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = visibleMessages.map(message => {
                // Determine if this is the current student's own message (compare ids as strings)
                const isOwnMessage = currentUser === 'student' && currentStudent && String(message.studentId) === String(currentStudent.id);
                const visibilityIcon = message.visibility === 'public' ? 'ğŸŒ' : 'ğŸ”’';
                const visibilityText = message.visibility === 'public' ? 'å…¬é–‹' : 'åƒ…è€å¸«å¯è¦‹';
                
                return `
                    <div class="border border-gray-200 rounded-xl p-4 ${isOwnMessage ? 'bg-blue-50' : 'bg-gray-50'}">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center space-x-3">
                                <div class="font-semibold text-gray-800">${message.studentName}</div>
                                <div class="text-sm text-gray-500">${message.groupName}</div>
                                <div class="flex items-center space-x-1 text-xs text-gray-500">
                                    <span>${visibilityIcon}</span>
                                    <span>${visibilityText}</span>
                                </div>
                            </div>
                            <div class="text-sm text-gray-500">${message.date}</div>
                        </div>
                        <p class="text-gray-700 mb-3 whitespace-pre-wrap">${message.content}</p>
                        
                        <!-- è€å¸«å›è¦†å€ -->
                        ${message.replies.length > 0 ? `
                            <div class="mt-4 pt-3 border-t border-gray-300">
                                <h5 class="font-semibold text-gray-700 mb-2">è€å¸«å›è¦†ï¼š</h5>
                                ${message.replies.map(reply => `
                                    <div class="bg-green-50 rounded-lg p-3 mb-2">
                                        <div class="flex justify-between items-start mb-1">
                                            <div class="font-medium text-green-800">ğŸ‘©â€ğŸ« è€å¸«</div>
                                            <div class="text-xs text-gray-500">${reply.date}</div>
                                        </div>
                                        <p class="text-gray-700">${reply.content}</p>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // æ•™å¸«ç•™è¨€ç®¡ç†åŠŸèƒ½
        function updateTeacherMessages() {
            const container = document.getElementById('teacherMessagesList');
            
            let filteredMessages = studentMessages;
            if (currentMessageFilter === 'public') {
                filteredMessages = studentMessages.filter(msg => msg.visibility === 'public');
            } else if (currentMessageFilter === 'private') {
                filteredMessages = studentMessages.filter(msg => msg.visibility === 'private');
            }
            
            if (filteredMessages.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">ğŸ“</div>
                        <p>å°šç„¡å­¸ç”Ÿç•™è¨€</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredMessages.map(message => {
                const visibilityIcon = message.visibility === 'public' ? 'ğŸŒ' : 'ğŸ”’';
                const visibilityText = message.visibility === 'public' ? 'å…¬é–‹' : 'ç§äºº';
                
                return `
                    <div class="border border-gray-200 rounded-xl p-4">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center space-x-3">
                                <div class="font-semibold text-gray-800">${message.studentName}</div>
                                <div class="text-sm text-gray-500">${message.groupName}</div>
                                <div class="flex items-center space-x-1 text-xs px-2 py-1 rounded-full ${message.visibility === 'public' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">
                                    <span>${visibilityIcon}</span>
                                    <span>${visibilityText}</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="text-sm text-gray-500">${message.date}</div>
                                <button onclick="deleteMessage('${message.id}')" class="text-red-500 hover:text-red-700 text-sm">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <p class="text-gray-700 mb-3 whitespace-pre-wrap">${message.content}</p>
                        
                        <!-- è€å¸«å›è¦†å€ -->
                        ${message.replies.length > 0 ? `
                            <div class="mt-4 pt-3 border-t border-gray-300">
                                <h5 class="font-semibold text-gray-700 mb-2">æˆ‘çš„å›è¦†ï¼š</h5>
                                ${message.replies.map(reply => `
                                    <div class="bg-green-50 rounded-lg p-3 mb-2">
                                        <div class="flex justify-between items-start mb-1">
                                            <div class="font-medium text-green-800">ğŸ‘©â€ğŸ« è€å¸«</div>
                                            <div class="text-xs text-gray-500">${reply.date}</div>
                                        </div>
                                        <p class="text-gray-700">${reply.content}</p>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <!-- å›è¦†è¡¨å–® -->
                        <div class="mt-4 pt-3 border-t border-gray-300">
                            <div class="flex space-x-2">
                                <input type="text" id="reply-${message.id}" placeholder="å›è¦†å­¸ç”Ÿ..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                <button onclick="replyToMessage('${message.id}')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">å›è¦†</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterMessages(filter) {
            currentMessageFilter = filter;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.getElementById('filterAll').className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors';
            document.getElementById('filterPublic').className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors';
            document.getElementById('filterPrivate').className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors';
            
            if (filter === 'all') {
                document.getElementById('filterAll').className = 'px-4 py-2 rounded-lg bg-blue-500 text-white transition-colors';
            } else if (filter === 'public') {
                document.getElementById('filterPublic').className = 'px-4 py-2 rounded-lg bg-blue-500 text-white transition-colors';
            } else if (filter === 'private') {
                document.getElementById('filterPrivate').className = 'px-4 py-2 rounded-lg bg-blue-500 text-white transition-colors';
            }
            
            updateTeacherMessages();
        }

        function replyToMessage(messageId) {
            const input = document.getElementById(`reply-${messageId}`);
            const content = input.value.trim();
            
            if (!content) return;

            // ä»¥å­—ä¸²æ¯”è¼ƒ ID ä»¥é¿å…é¡å‹éŒ¯èª¤
            const message = studentMessages.find(msg => String(msg.id) === String(messageId));
            if (!message) return;

            const reply = {
                id: Date.now(),
                content: content,
                date: new Date().toLocaleString('zh-TW')
            };

            message.replies.push(reply);
            google.script.run.setStorage('studentMessages', studentMessages);
            
            input.value = '';
            updateTeacherMessages();
        }

        function deleteMessage(messageId) {
            if (currentUser !== 'teacher') return;
            
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡ç•™è¨€å—ï¼Ÿ')) {
                // ç”¨å­—ä¸²æ¯”è¼ƒé¿å…é¡å‹ä¸ä¸€è‡´
                studentMessages = studentMessages.filter(msg => String(msg.id) !== String(messageId));
                google.script.run.setStorage('studentMessages', studentMessages);
                updateTeacherMessages();
            }
        }

        // åˆ†æ•¸è¨˜éŒ„ç®¡ç†åŠŸèƒ½
        function updateScoreHistoryFilter() {
            const studentFilter = document.getElementById('studentHistoryFilter');
            studentFilter.innerHTML = '<option value="">é¸æ“‡å­¸ç”Ÿç¯©é¸</option>';
            
            students.forEach(student => {
                studentFilter.innerHTML += `<option value="${student.id}">${student.name} (${student.groupName})</option>`;
            });
            
            // æ·»åŠ äº‹ä»¶ç›£è½å™¨
            studentFilter.addEventListener('change', function() {
                currentStudentFilter = this.value;
                updateScoreHistory();
            });
        }

        function filterScoreHistory(filter) {
            currentHistoryFilter = filter;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.getElementById('historyFilterAll').className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors';
            document.getElementById('historyFilterGroup').className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors';
            document.getElementById('historyFilterIndividual').className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors';
            
            if (filter === 'all') {
                document.getElementById('historyFilterAll').className = 'px-4 py-2 rounded-lg bg-blue-500 text-white transition-colors';
            } else if (filter === 'group') {
                document.getElementById('historyFilterGroup').className = 'px-4 py-2 rounded-lg bg-blue-500 text-white transition-colors';
            } else if (filter === 'individual') {
                document.getElementById('historyFilterIndividual').className = 'px-4 py-2 rounded-lg bg-blue-500 text-white transition-colors';
            }
            
            updateScoreHistory();
        }

        function updateScoreHistory() {
            let filteredHistory = scoreHistory;
            
            // æŒ‰é¡å‹ç¯©é¸
            if (currentHistoryFilter === 'group') {
                filteredHistory = filteredHistory.filter(record => record.type === 'group');
            } else if (currentHistoryFilter === 'individual') {
                filteredHistory = filteredHistory.filter(record => record.type === 'individual');
            }
            
            // æŒ‰å­¸ç”Ÿç¯©é¸
            if (currentStudentFilter) {
                filteredHistory = filteredHistory.filter(record => {
                    if (record.type === 'individual') {
                        return record.targetId == currentStudentFilter;
                    } else {
                        return record.affectedStudents.some(student => student.id == currentStudentFilter);
                    }
                });
            }
            
            // æ›´æ–°çµ±è¨ˆè³‡è¨Š
            updateScoreStatistics(filteredHistory);
            
            // æ›´æ–°è¨˜éŒ„åˆ—è¡¨
            const container = document.getElementById('scoreHistoryList');
            
            if (filteredHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">ğŸ“Š</div>
                        <p>å°šç„¡åˆ†æ•¸è®ŠåŒ–è¨˜éŒ„</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredHistory.map(record => {
                const isPositive = record.scoreChange > 0;
                const typeIcon = record.type === 'group' ? 'ğŸ‘¥' : 'ğŸŒŸ';
                const scoreIcon = isPositive ? 'â•' : 'â–';
                const scoreColor = isPositive ? 'text-green-600' : 'text-red-600';
                const bgColor = isPositive ? 'bg-green-50' : 'bg-red-50';
                
                return `
                    <div class="border border-gray-200 rounded-xl p-4 ${bgColor}">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center space-x-3">
                                <div class="text-2xl">${typeIcon}</div>
                                <div>
                                    <div class="font-semibold text-gray-800">${record.targetName}</div>
                                    <div class="text-sm text-gray-600">${record.reason}</div>
                                    ${record.groupName ? `<div class="text-xs text-gray-500">${record.groupName}</div>` : ''}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="flex items-center space-x-2">
                                    <span class="text-2xl ${scoreColor} font-bold">${scoreIcon} ${Math.abs(record.scoreChange)}</span>

                                </div>
                                <div class="text-xs text-gray-500 mt-1">${record.date}</div>
                            </div>
                        </div>
                        
                        <!-- å—å½±éŸ¿çš„å­¸ç”Ÿ -->
                        <div class="mt-3 pt-3 border-t border-gray-300">
                            <div class="text-sm text-gray-600 mb-2">å—å½±éŸ¿å­¸ç”Ÿï¼š</div>
                            <div class="flex flex-wrap gap-2">
                                ${record.affectedStudents.map(student => `
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs ${isPositive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${student.name} (${scoreIcon}${Math.abs(student.scoreChange)})
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateScoreStatistics(filteredHistory) {
            const totalRecords = filteredHistory.length;
            const positiveRecords = filteredHistory.filter(record => record.scoreChange > 0).length;
            const negativeRecords = filteredHistory.filter(record => record.scoreChange < 0).length;
            
            // è¨ˆç®—ä»Šæ—¥è¨˜éŒ„
            const today = new Date().toLocaleDateString('zh-TW');
            const todayRecords = filteredHistory.filter(record => record.date.includes(today)).length;
            
            document.getElementById('totalRecords').textContent = totalRecords;
            document.getElementById('totalPositive').textContent = positiveRecords;
            document.getElementById('totalNegative').textContent = negativeRecords;
            document.getElementById('todayRecords').textContent = todayRecords;
        }


        // å­¸ç”Ÿåˆ†æ•¸è®ŠåŒ–è¨˜éŒ„åŠŸèƒ½

        function updateStudentScoreHistory(studentId) {
            const container = document.getElementById('studentHistoryList');
            
            // ç¯©é¸è©²å­¸ç”Ÿç›¸é—œçš„åˆ†æ•¸è¨˜éŒ„
            let studentHistory = scoreHistory.filter(record => {
                // å€‹äººåŠ åˆ†è¨˜éŒ„
                if (record.type === 'individual' && record.targetId == studentId) {
                    return true;
                }
                // å°çµ„åŠ åˆ†è¨˜éŒ„ï¼ˆå½±éŸ¿åˆ°è©²å­¸ç”Ÿï¼‰
                if (record.type === 'group' && record.affectedStudents.some(s => s.id == studentId)) {
                    return true;
                }
                // æ¶åˆ†æ´»å‹•è¨˜éŒ„
                if (record.type === 'quiz' && record.targetId == studentId) {
                    return true;
                }
                // çå“å…Œæ›è¨˜éŒ„
                if (record.type === 'exchange' && record.targetId == studentId) {
                    return true;
                }
                return false;
            });
            
            // æŒ‰æ™‚é–“æ’åºï¼Œæœ€æ–°çš„åœ¨å‰é¢
            studentHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // åªé¡¯ç¤ºæœ€è¿‘10ç­†è¨˜éŒ„
            studentHistory = studentHistory.slice(0, 10);
            
            if (studentHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <div class="text-2xl mb-1">ğŸ“Š</div>
                        <p class="text-sm">å°šç„¡åˆ†æ•¸è®ŠåŒ–è¨˜éŒ„</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = studentHistory.map(record => {
                const isPositive = record.scoreChange > 0;
                const scoreIcon = isPositive ? 'â•' : 'â–';
                const scoreColor = isPositive ? 'text-green-600' : 'text-red-600';
                const bgColor = isPositive ? 'bg-green-50' : 'bg-red-50';
                
                // ç²å–è©²å­¸ç”Ÿåœ¨æ­¤è¨˜éŒ„ä¸­çš„åˆ†æ•¸è®ŠåŒ–
                let studentScoreChange = record.scoreChange;
                if (record.type === 'group') {
                    const affectedStudent = record.affectedStudents.find(s => s.id == studentId);
                    if (affectedStudent) {
                        studentScoreChange = affectedStudent.scoreChange;
                    }
                }
                
                // æ ¹æ“šè¨˜éŒ„é¡å‹è¨­ç½®åœ–ç¤ºå’Œæè¿°
                let typeIcon, typeDescription;
                switch (record.type) {
                    case 'individual':
                        typeIcon = 'ğŸŒŸ';
                        typeDescription = 'å€‹äºº';
                        break;
                    case 'group':
                        typeIcon = 'ğŸ‘¥';
                        typeDescription = 'å°çµ„';
                        break;
                    case 'quiz':
                        typeIcon = 'âš¡';
                        typeDescription = 'æ¶åˆ†';
                        break;
                    case 'exchange':
                        typeIcon = 'ğŸ';
                        typeDescription = 'å…Œæ›';
                        break;
                    default:
                        typeIcon = 'ğŸ“';
                        typeDescription = 'å…¶ä»–';
                }
                
                return `
                    <div class="border border-gray-200 rounded-lg p-3 ${bgColor}">
                        <div class="flex justify-between items-start">
                            <div class="flex items-start space-x-2">
                                <div class="text-lg">${typeIcon}</div>
                                <div class="flex-1">
                                    <div class="text-sm font-medium text-gray-800">${record.reason}</div>
                                    <div class="text-xs text-gray-600 mt-1">
                                        <span class="inline-block px-2 py-1 rounded-full bg-gray-100 text-gray-600">${typeDescription}</span>
                                        <span class="ml-2">${record.date}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="flex items-center space-x-1">
                                    <span class="text-lg ${scoreColor} font-bold">${scoreIcon}</span>
                                    <span class="text-lg ${scoreColor} font-bold">${Math.abs(studentScoreChange)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // å­¸ç”Ÿçå“å…Œæ›åŠŸèƒ½
        function showRewardExchange() {
            if (currentUser !== 'student' || !currentStudent) return;
            
            document.getElementById('rewardExchangeModal').classList.remove('hidden');
            document.getElementById('currentStudentPoints').textContent = currentStudent.score;
            updateStudentRewardsList();
        }

        function closeRewardExchangeModal() {
            document.getElementById('rewardExchangeModal').classList.add('hidden');
            hideExchangeHistory(); // ç¢ºä¿é—œé–‰æ™‚å›åˆ°çå“åˆ—è¡¨
        }

        function showExchangeHistory() {
            document.getElementById('rewardsList').classList.add('hidden');
            document.getElementById('studentPointsDisplay').classList.add('hidden');
            document.getElementById('exchangeHistorySection').classList.remove('hidden');
            updateStudentExchangeHistory();
        }

        function hideExchangeHistory() {
            document.getElementById('exchangeHistorySection').classList.add('hidden');
            document.getElementById('rewardsList').classList.remove('hidden');
            document.getElementById('studentPointsDisplay').classList.remove('hidden');
        }

        function updateStudentExchangeHistory() {
            if (currentUser !== 'student' || !currentStudent) return;
            
            const container = document.getElementById('studentExchangeHistory');
            // filter by studentId as strings
            const studentRequests = exchangeRequests.filter(req => String(req.studentId) === String(currentStudent.id));
            
            if (studentRequests.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">ğŸ“‹</div>
                        <p>å°šç„¡å…Œæ›è¨˜éŒ„</p>
                    </div>
                `;
                return;
            }

            // æŒ‰æ™‚é–“æ’åºï¼Œæœ€æ–°çš„åœ¨å‰é¢
            const sortedRequests = studentRequests.sort((a, b) => new Date(b.requestDate) - new Date(a.requestDate));

            container.innerHTML = sortedRequests.map(request => {
                let statusClass, statusIcon, statusText, statusBg;
                
                switch (request.status) {
                    case 'pending':
                        statusClass = 'text-yellow-700';
                        statusBg = 'bg-yellow-100';
                        statusIcon = 'â³';
                        statusText = 'å¯©æ ¸ä¸­';
                        break;
                    case 'approved':
                        statusClass = 'text-green-700';
                        statusBg = 'bg-green-100';
                        statusIcon = 'âœ…';
                        statusText = 'å·²åŒæ„';
                        break;
                    case 'rejected':
                        statusClass = 'text-red-700';
                        statusBg = 'bg-red-100';
                        statusIcon = 'âŒ';
                        statusText = 'å·²æ‹’çµ•';
                        break;
                    default:
                        statusClass = 'text-gray-700';
                        statusBg = 'bg-gray-100';
                        statusIcon = 'â“';
                        statusText = 'æœªçŸ¥';
                }

                return `
                    <div class="bg-white rounded-xl p-4 border border-gray-200">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-semibold text-gray-800">${request.rewardName}</h4>
                                <div class="text-sm text-gray-600">ç”³è«‹æ™‚é–“ï¼š${request.requestDate}</div>
                                ${request.approveDate ? `<div class="text-sm text-gray-600">è™•ç†æ™‚é–“ï¼š${request.approveDate}</div>` : ''}
                                ${request.rejectDate ? `<div class="text-sm text-gray-600">è™•ç†æ™‚é–“ï¼š${request.rejectDate}</div>` : ''}
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold text-blue-600">${request.points} é»</div>
                                <div class="flex items-center space-x-1 text-sm px-2 py-1 rounded-full ${statusBg} ${statusClass}">
                                    <span>${statusIcon}</span>
                                    <span>${statusText}</span>
                                </div>
                            </div>
                        </div>
                        
                        ${request.status === 'approved' ? `
                            <div class="mt-3 p-3 bg-green-50 rounded-lg">
                                <div class="text-sm text-green-800">ğŸ‰ æ­å–œï¼æ‚¨çš„å…Œæ›ç”³è«‹å·²é€šéï¼Œè«‹å‘è€å¸«é ˜å–çå“ã€‚</div>
                            </div>
                        ` : ''}
                        
                        ${request.status === 'rejected' ? `
                            <div class="mt-3 p-3 bg-red-50 rounded-lg">
                                <div class="text-sm text-red-800">ğŸ˜” å¾ˆæŠ±æ­‰ï¼Œæ‚¨çš„å…Œæ›ç”³è«‹æœªé€šéå¯©æ ¸ã€‚</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function updateStudentRewardsList() {
            const container = document.getElementById('rewardsList');
            
            if (rewards.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8 col-span-full">
                        <div class="text-4xl mb-2">ğŸ</div>
                        <p>å°šç„¡å¯å…Œæ›çå“</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = rewards.map(reward => {
                const canAfford = currentStudent.score >= reward.points;
                const isOutOfStock = reward.quantity <= 0;
                
                // æª¢æŸ¥æ˜¯å¦æœ‰å¾…å¯©æ ¸çš„ç”³è«‹ï¼ˆå°‡ ID è½‰ç‚ºå­—ä¸²æ¯”è¼ƒï¼‰
                const pendingRequest = exchangeRequests.find(req => 
                    String(req.studentId) === String(currentStudent.id) &&
                    String(req.rewardId) === String(reward.id) &&
                    req.status === 'pending'
                );

                let buttonClass, buttonText, buttonDisabled;
                
                if (pendingRequest) {
                    buttonClass = 'bg-yellow-500 text-white cursor-not-allowed';
                    buttonText = 'å¯©æ ¸ä¸­';
                    buttonDisabled = true;
                } else if (isOutOfStock) {
                    buttonClass = 'bg-orange-400 text-white cursor-not-allowed';
                    buttonText = 'è£œè²¨ä¸­';
                    buttonDisabled = true;
                } else if (!canAfford) {
                    buttonClass = 'bg-gray-300 text-gray-500 cursor-not-allowed';
                    buttonText = 'é»æ•¸ä¸è¶³';
                    buttonDisabled = true;
                } else {
                    buttonClass = 'bg-green-500 hover:bg-green-600 text-white';
                    buttonText = 'ç”³è«‹å…Œæ›';
                    buttonDisabled = false;
                }
                
                return `
                    <div class="bg-white rounded-xl p-4 border border-gray-200 card-shadow ${isOutOfStock ? 'opacity-75' : ''}">
                        ${reward.image ? `
                            <div class="mb-4 relative">
                                <img src="${reward.image}" alt="${reward.name}" class="w-full h-32 object-cover rounded-lg ${isOutOfStock ? 'grayscale' : ''}">
                                ${isOutOfStock ? '<div class="absolute inset-0 bg-black bg-opacity-30 rounded-lg flex items-center justify-center"><span class="text-white font-bold">ç¼ºè²¨</span></div>' : ''}
                            </div>
                        ` : `
                            <div class="mb-4 bg-gray-100 rounded-lg h-32 flex items-center justify-center relative ${isOutOfStock ? 'bg-gray-200' : ''}">
                                <div class="text-4xl ${isOutOfStock ? 'grayscale' : ''}">ğŸ</div>
                                ${isOutOfStock ? '<div class="absolute inset-0 bg-black bg-opacity-30 rounded-lg flex items-center justify-center"><span class="text-white font-bold">ç¼ºè²¨</span></div>' : ''}
                            </div>
                        `}
                        
                        <h3 class="font-semibold text-gray-800 mb-2">${reward.name}</h3>
                        <p class="text-sm text-gray-600 mb-3">${reward.description || 'æš«ç„¡æè¿°'}</p>
                        
                        <div class="flex items-center justify-between mb-3">
                            <div class="text-lg font-bold text-blue-600">${reward.points} é»</div>
                            <div class="text-sm ${isOutOfStock ? 'text-red-500 font-semibold' : 'text-gray-500'}">
                                å‰©é¤˜ ${reward.quantity} å€‹
                            </div>
                        </div>
                        
                        <button onclick="requestExchange('${reward.id}')" 
                                ${buttonDisabled ? 'disabled' : ''} 
                                class="w-full py-2 px-4 rounded-lg transition-colors ${buttonClass}">
                            ${buttonText}
                        </button>
                    </div>
                `;
            }).join('');
        }

        function requestExchange(rewardId) {
            if (currentUser !== 'student' || !currentStudent) return;
            
            // ä»¥å­—ä¸²æ¯”è¼ƒï¼Œé¿å… ID å‹åˆ¥ä¸ä¸€è‡´
            const reward = rewards.find(r => String(r.id) === String(rewardId));
            if (!reward || reward.quantity <= 0 || currentStudent.score < reward.points) {
                alert('ç„¡æ³•å…Œæ›æ­¤çå“');
                return;
            }

            // æª¢æŸ¥æ˜¯å¦å·²æœ‰å¾…å¯©æ ¸çš„ç”³è«‹
            // æª¢æŸ¥æ˜¯å¦å·²æœ‰å¾…å¯©æ ¸çš„ç”³è«‹ï¼ŒID æ¯”å°æ”¹ç‚ºå­—ä¸²
            const existingRequest = exchangeRequests.find(req => 
                String(req.studentId) === String(currentStudent.id) && 
                String(req.rewardId) === String(rewardId) && 
                req.status === 'pending'
            );

            if (existingRequest) {
                alert('æ‚¨å·²ç”³è«‹å…Œæ›æ­¤çå“ï¼Œè«‹ç­‰å¾…è€å¸«å¯©æ ¸');
                return;
            }

            if (confirm(`ç¢ºå®šè¦ç”³è«‹å…Œæ›ã€Œ${reward.name}ã€å—ï¼Ÿ\néœ€è¦ ${reward.points} é»æ•¸`)) {
                const request = {
                    id: Date.now(),
                    studentId: currentStudent.id,
                    studentName: currentStudent.name,
                    groupName: currentStudent.groupName,
                    rewardId: reward.id,
                    rewardName: reward.name,
                    points: reward.points,
                    status: 'pending',
                    requestDate: new Date().toLocaleString('zh-TW')
                };

                exchangeRequests.push(request);
                google.script.run.setStorage('exchangeRequests', exchangeRequests);
                
                alert('å…Œæ›ç”³è«‹å·²æäº¤ï¼Œè«‹ç­‰å¾…è€å¸«å¯©æ ¸');
                updateStudentRewardsList(); // é‡æ–°æ•´ç†åˆ—è¡¨ä»¥é¡¯ç¤ºå¯©æ ¸ä¸­ç‹€æ…‹
            }
        }

        // æ•™å¸«çå“ç®¡ç†åŠŸèƒ½
        function showAddRewardForm() {
            document.getElementById('addRewardForm').classList.remove('hidden');
            document.getElementById('editRewardForm').classList.add('hidden');
            document.getElementById('exchangeRequestsSection').classList.add('hidden');
        }

        function hideAddRewardForm() {
            document.getElementById('addRewardForm').classList.add('hidden');
            clearAddRewardForm();
        }

        function clearAddRewardForm() {
            document.getElementById('rewardName').value = '';
            document.getElementById('rewardPoints').value = '';
            document.getElementById('rewardQuantity').value = '';
            document.getElementById('rewardDescription').value = '';
            document.getElementById('rewardImage').value = '';
        }

        function addReward() {
            const name = document.getElementById('rewardName').value.trim();
            const points = parseInt(document.getElementById('rewardPoints').value);
            const quantity = parseInt(document.getElementById('rewardQuantity').value);
            const description = document.getElementById('rewardDescription').value.trim();
            const imageFile = document.getElementById('rewardImage').files[0];

            if (!name || !points || !quantity) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½');
                return;
            }

            const reward = {
                id: Date.now(),
                name: name,
                points: points,
                quantity: quantity,
                description: description,
                image: null
            };

            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    reward.image = e.target.result;
                    rewards.push(reward);
                    google.script.run.setStorage('rewards', rewards);
                    hideAddRewardForm();
                    updateRewardManageList();
                    alert('çå“æ–°å¢æˆåŠŸï¼');
                };
                reader.readAsDataURL(imageFile);
            } else {
                rewards.push(reward);
                google.script.run.setStorage('rewards', rewards);
                hideAddRewardForm();
                updateRewardManageList();
                alert('çå“æ–°å¢æˆåŠŸï¼');
            }
        }

        function updateRewardManageList() {
            const container = document.getElementById('rewardManageList');
            
            if (rewards.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8 col-span-full">
                        <div class="text-4xl mb-2">ğŸ</div>
                        <p>å°šç„¡çå“</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = rewards.map(reward => `
                <div class="bg-white rounded-xl p-4 border border-gray-200 card-shadow">
                    ${reward.image ? `
                        <div class="mb-4">
                            <img src="${reward.image}" alt="${reward.name}" class="w-full h-32 object-cover rounded-lg">
                        </div>
                    ` : `
                        <div class="mb-4 bg-gray-100 rounded-lg h-32 flex items-center justify-center">
                            <div class="text-4xl">ğŸ</div>
                        </div>
                    `}
                    
                    <h3 class="font-semibold text-gray-800 mb-2">${reward.name}</h3>
                    <p class="text-sm text-gray-600 mb-3">${reward.description || 'æš«ç„¡æè¿°'}</p>
                    
                    <div class="grid grid-cols-2 gap-2 mb-3 text-sm">
                        <div class="text-center bg-blue-50 rounded-lg p-2">
                            <div class="font-bold text-blue-600">${reward.points}</div>
                            <div class="text-gray-600">æ‰€éœ€é»æ•¸</div>
                        </div>
                        <div class="text-center bg-green-50 rounded-lg p-2">
                            <div class="font-bold text-green-600">${reward.quantity}</div>
                            <div class="text-gray-600">å‰©é¤˜æ•¸é‡</div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button onclick="editReward('${reward.id}')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-3 rounded-lg transition-colors text-sm">
                            ç·¨è¼¯
                        </button>
                        <button onclick="deleteReward('${reward.id}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded-lg transition-colors text-sm">
                            åˆªé™¤
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function editReward(rewardId) {
            // ä»¥å­—ä¸²æ¯”è¼ƒï¼Œé¿å… ID å‹åˆ¥ä¸ä¸€è‡´
            const reward = rewards.find(r => String(r.id) === String(rewardId));
            if (!reward) return;

            document.getElementById('editRewardId').value = reward.id;
            document.getElementById('editRewardName').value = reward.name;
            document.getElementById('editRewardPoints').value = reward.points;
            document.getElementById('editRewardQuantity').value = reward.quantity;
            document.getElementById('editRewardDescription').value = reward.description || '';

            document.getElementById('addRewardForm').classList.add('hidden');
            document.getElementById('editRewardForm').classList.remove('hidden');
            document.getElementById('exchangeRequestsSection').classList.add('hidden');
        }

        function hideEditRewardForm() {
            document.getElementById('editRewardForm').classList.add('hidden');
        }

        function updateReward() {
            // ç›´æ¥ä½¿ç”¨å­—ä¸²å½¢å¼çš„ rewardIdï¼Œé¿å…å‹åˆ¥ä¸ä¸€è‡´
            const rewardId = document.getElementById('editRewardId').value;
            const name = document.getElementById('editRewardName').value.trim();
            const points = parseInt(document.getElementById('editRewardPoints').value);
            const quantity = parseInt(document.getElementById('editRewardQuantity').value);
            const description = document.getElementById('editRewardDescription').value.trim();
            const imageFile = document.getElementById('editRewardImage').files[0];

            if (!name || !points || quantity < 0) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½');
                return;
            }

            // ç”¨å­—ä¸²æ¯”è¼ƒå°‹æ‰¾å°æ‡‰çå“
            const reward = rewards.find(r => String(r.id) === String(rewardId));
            if (!reward) return;

            reward.name = name;
            reward.points = points;
            reward.quantity = quantity;
            reward.description = description;

            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    reward.image = e.target.result;
                    google.script.run.setStorage('rewards', rewards);
                    hideEditRewardForm();
                    updateRewardManageList();
                    alert('çå“æ›´æ–°æˆåŠŸï¼');
                };
                reader.readAsDataURL(imageFile);
            } else {
                google.script.run.setStorage('rewards', rewards);
                hideEditRewardForm();
                updateRewardManageList();
                alert('çå“æ›´æ–°æˆåŠŸï¼');
            }
        }

        function deleteReward(rewardId) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹çå“å—ï¼Ÿ')) {
                // ç”¨å­—ä¸²æ¯”è¼ƒé¿å…é¡å‹ä¸ä¸€è‡´
                rewards = rewards.filter(r => String(r.id) !== String(rewardId));
                google.script.run.setStorage('rewards', rewards);
                updateRewardManageList();
                alert('çå“å·²åˆªé™¤ï¼');
            }
        }

        function showExchangeRequests() {
            document.getElementById('addRewardForm').classList.add('hidden');
            document.getElementById('editRewardForm').classList.add('hidden');
            document.getElementById('exchangeRequestsSection').classList.remove('hidden');
            document.getElementById('teacherExchangeHistorySection').classList.add('hidden');
            updateExchangeRequests();
        }

        function showTeacherExchangeHistory() {
            document.getElementById('addRewardForm').classList.add('hidden');
            document.getElementById('editRewardForm').classList.add('hidden');
            document.getElementById('exchangeRequestsSection').classList.add('hidden');
            document.getElementById('teacherExchangeHistorySection').classList.remove('hidden');
            updateTeacherExchangeHistoryFilters();
            updateTeacherExchangeHistory();
        }

        function updateTeacherExchangeHistoryFilters() {
            const studentFilter = document.getElementById('exchangeStudentFilter');
            studentFilter.innerHTML = '<option value="">æ‰€æœ‰å­¸ç”Ÿ</option>';
            
            // ç²å–æ‰€æœ‰æœ‰å…Œæ›è¨˜éŒ„çš„å­¸ç”Ÿ
            const studentsWithExchange = [...new Set(exchangeRequests.map(req => req.studentId))];
            studentsWithExchange.forEach(studentId => {
                // ç”¨å­—ä¸²æ¯”è¼ƒé¿å…é¡å‹ä¸ä¸€è‡´
                const student = students.find(s => String(s.id) === String(studentId));
                if (student) {
                    studentFilter.innerHTML += `<option value="${student.id}">${student.name} (${student.groupName})</option>`;
                }
            });
            
            // æ·»åŠ äº‹ä»¶ç›£è½å™¨
            document.getElementById('exchangeStatusFilter').addEventListener('change', updateTeacherExchangeHistory);
            document.getElementById('exchangeStudentFilter').addEventListener('change', updateTeacherExchangeHistory);
        }

        function updateTeacherExchangeHistory() {
            const container = document.getElementById('teacherExchangeHistoryList');
            const statusFilter = document.getElementById('exchangeStatusFilter').value;
            const studentFilter = document.getElementById('exchangeStudentFilter').value;
            
            let filteredRequests = [...exchangeRequests];
            
            // æŒ‰ç‹€æ…‹ç¯©é¸
            if (statusFilter) {
                filteredRequests = filteredRequests.filter(req => req.status === statusFilter);
            }
            
            // æŒ‰å­¸ç”Ÿç¯©é¸
            if (studentFilter) {
                filteredRequests = filteredRequests.filter(req => req.studentId == studentFilter);
            }
            
            // æŒ‰æ™‚é–“æ’åºï¼Œæœ€æ–°çš„åœ¨å‰é¢
            filteredRequests.sort((a, b) => new Date(b.requestDate) - new Date(a.requestDate));
            
            if (filteredRequests.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">ğŸ“Š</div>
                        <p>å°šç„¡å…Œæ›è¨˜éŒ„</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredRequests.map(request => {
                let statusClass, statusIcon, statusText, statusBg;
                
                switch (request.status) {
                    case 'pending':
                        statusClass = 'text-yellow-700';
                        statusBg = 'bg-yellow-100';
                        statusIcon = 'â³';
                        statusText = 'å¯©æ ¸ä¸­';
                        break;
                    case 'approved':
                        statusClass = 'text-green-700';
                        statusBg = 'bg-green-100';
                        statusIcon = 'âœ…';
                        statusText = 'å·²åŒæ„';
                        break;
                    case 'rejected':
                        statusClass = 'text-red-700';
                        statusBg = 'bg-red-100';
                        statusIcon = 'âŒ';
                        statusText = 'å·²æ‹’çµ•';
                        break;
                    default:
                        statusClass = 'text-gray-700';
                        statusBg = 'bg-gray-100';
                        statusIcon = 'â“';
                        statusText = 'æœªçŸ¥';
                }

                return `
                    <div class="bg-white rounded-xl p-4 border border-gray-200">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="font-semibold text-gray-800">${request.studentName}</div>
                                <div class="text-sm text-gray-600">${request.groupName}</div>
                                <div class="text-xs text-gray-500">ç”³è«‹æ™‚é–“ï¼š${request.requestDate}</div>
                                ${request.approveDate ? `<div class="text-xs text-gray-500">åŒæ„æ™‚é–“ï¼š${request.approveDate}</div>` : ''}
                                ${request.rejectDate ? `<div class="text-xs text-gray-500">æ‹’çµ•æ™‚é–“ï¼š${request.rejectDate}</div>` : ''}
                            </div>
                            <div class="text-right">
                                <div class="font-semibold text-blue-600 mb-1">${request.rewardName}</div>
                                <div class="text-sm text-gray-600 mb-2">${request.points} é»æ•¸</div>
                                <div class="flex items-center space-x-1 text-sm px-2 py-1 rounded-full ${statusBg} ${statusClass}">
                                    <span>${statusIcon}</span>
                                    <span>${statusText}</span>
                                </div>
                            </div>
                        </div>
                        
                        ${request.status === 'pending' ? `
                            <div class="flex space-x-2 mt-3 pt-3 border-t border-gray-200">
                                <button onclick="approveExchange('${request.id}')" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg transition-colors text-sm">
                                    åŒæ„å…Œæ›
                                </button>
                                <button onclick="rejectExchange('${request.id}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg transition-colors text-sm">
                                    æ‹’çµ•å…Œæ›
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function updateExchangeRequests() {
            const container = document.getElementById('exchangeRequestsList');
            const pendingRequests = exchangeRequests.filter(req => req.status === 'pending');
            
            if (pendingRequests.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">ğŸ“‹</div>
                        <p>å°šç„¡å¾…è™•ç†ç”³è«‹</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = pendingRequests.map(request => `
                <div class="bg-white rounded-xl p-4 border border-gray-200">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="font-semibold text-gray-800">${request.studentName}</div>
                            <div class="text-sm text-gray-600">${request.groupName}</div>
                            <div class="text-xs text-gray-500">${request.requestDate}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold text-blue-600">${request.rewardName}</div>
                            <div class="text-sm text-gray-600">${request.points} é»æ•¸</div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button onclick="approveExchange('${request.id}')" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg transition-colors">
                            åŒæ„å…Œæ›
                        </button>
                        <button onclick="rejectExchange('${request.id}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg transition-colors">
                            æ‹’çµ•å…Œæ›
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function approveExchange(requestId) {
            // æ ¹æ“š requestId æ‰¾ç”³è«‹ï¼›è½‰ç‚ºå­—ä¸²æ¯”è¼ƒ
            const request = exchangeRequests.find(req => String(req.id) === String(requestId));
            if (!request || request.status !== 'pending') return;

            // æ‰¾å­¸ç”Ÿèˆ‡çå“æ™‚ç”¨å­—ä¸²æ¯”è¼ƒ IDï¼Œé¿å…é¡å‹ä¸ä¸€è‡´
            const student = students.find(s => String(s.id) === String(request.studentId));
            const reward = rewards.find(r => String(r.id) === String(request.rewardId));

            if (!student || !reward) {
                alert('æ‰¾ä¸åˆ°å­¸ç”Ÿæˆ–çå“è³‡æ–™');
                return;
            }

            if (student.score < request.points) {
                alert('å­¸ç”Ÿé»æ•¸ä¸è¶³');
                return;
            }

            if (reward.quantity <= 0) {
                alert('çå“æ•¸é‡ä¸è¶³');
                return;
            }

            if (confirm(`ç¢ºå®šåŒæ„ ${request.studentName} å…Œæ›ã€Œ${request.rewardName}ã€å—ï¼Ÿ`)) {
                // æ‰£é™¤å­¸ç”Ÿé»æ•¸
                student.score -= request.points;
                
                // æ¸›å°‘çå“æ•¸é‡
                reward.quantity -= 1;
                
                // æ›´æ–°ç”³è«‹ç‹€æ…‹
                request.status = 'approved';
                request.approveDate = new Date().toLocaleString('zh-TW');

                // è¨˜éŒ„åˆ†æ•¸è®ŠåŒ–
                const historyRecord = {
                    id: Date.now(),
                    type: 'exchange',
                    targetId: student.id,
                    targetName: student.name,
                    groupName: student.groupName,
                    scoreChange: -request.points,
                    reason: `å…Œæ›çå“ï¼š${request.rewardName}`,
                    date: new Date().toLocaleString('zh-TW'),
                    affectedStudents: [{
                        id: student.id,
                        name: student.name,
                        scoreChange: -request.points
                    }]
                };

                scoreHistory.unshift(historyRecord);

                // ä¿å­˜è³‡æ–™
                google.script.run.setStorage('students', students);
                google.script.run.setStorage('rewards', rewards);
                google.script.run.setStorage('exchangeRequests', exchangeRequests);
                google.script.run.setStorage('scoreHistory', scoreHistory);

                updateExchangeRequests();
                updateRewardManageList();
                updateRankings();
                updateTeacherExchangeHistory(); // æ›´æ–°è€å¸«å…Œæ›è¨˜éŒ„
                alert('å…Œæ›ç”³è«‹å·²åŒæ„ï¼');
            }
        }

        function rejectExchange(requestId) {
            // ä»¥å­—ä¸²æ¯”è¼ƒ ID ä¾†å°‹æ‰¾ç”³è«‹
            const request = exchangeRequests.find(req => String(req.id) === String(requestId));
            if (!request || request.status !== 'pending') return;

            if (confirm(`ç¢ºå®šæ‹’çµ• ${request.studentName} çš„å…Œæ›ç”³è«‹å—ï¼Ÿ`)) {
                request.status = 'rejected';
                request.rejectDate = new Date().toLocaleString('zh-TW');

                google.script.run.setStorage('exchangeRequests', exchangeRequests);
                updateExchangeRequests();
                updateTeacherExchangeHistory(); // æ›´æ–°è€å¸«å…Œæ›è¨˜éŒ„
                alert('å…Œæ›ç”³è«‹å·²æ‹’çµ•ï¼');
            }
        }

        // æ¶åˆ†åŠŸèƒ½ç›¸é—œå‡½æ•¸
        function showStudentQuiz() {
            if (currentUser !== 'student') return;
            
            document.getElementById('studentQuizModal').classList.remove('hidden');
            updateStudentQuizList();
            checkQuizCountdown();
        }

        function closeStudentQuizModal() {
            document.getElementById('studentQuizModal').classList.add('hidden');
            if (quizCountdown) {
                clearInterval(quizCountdown);
                quizCountdown = null;
            }
        }

        function updateStudentQuizList() {
            const container = document.getElementById('studentQuizList');
            const now = new Date();
            
            // ç¯©é¸å¯åƒèˆ‡çš„æ¶åˆ†æ´»å‹•
            const availableQuizzes = quizzes.filter(quiz => {
                if (quiz.status === 'ended') return false;
                if (quiz.startType === 'scheduled') {
                    const startTime = new Date(quiz.startDate + ' ' + quiz.startTime);
                    return startTime <= now;
                }
                return quiz.status === 'active';
            });
            
            if (availableQuizzes.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">âš¡</div>
                        <p>ç›®å‰æ²’æœ‰æ¶åˆ†æ´»å‹•</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = availableQuizzes.map(quiz => {
                // æŸ¥æ‰¾å­¸ç”Ÿæ˜¯å¦ä½œç­”éæ­¤é¡Œç›®ï¼ˆç”¨å­—ä¸²æ¯”è¼ƒ quizId èˆ‡ studentIdï¼‰
                const studentAnswer = quizAnswers.find(answer => 
                    String(answer.quizId) === String(quiz.id) && String(answer.studentId) === String(currentStudent.id)
                );
                
                const typeIcon = quiz.type === 'choice' ? 'ğŸ“' : 'ğŸ’­';
                const typeText = quiz.type === 'choice' ? 'é¸æ“‡é¡Œ' : 'å•ç­”é¡Œ';
                
                return `
                    <div class="bg-white rounded-xl p-6 border border-gray-200 card-shadow">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="text-2xl">${typeIcon}</span>
                                    <h3 class="text-xl font-bold text-gray-800">${quiz.title}</h3>
                                    <span class="text-sm px-2 py-1 rounded-full bg-blue-100 text-blue-700">${typeText}</span>
                                </div>
                                <div class="text-sm text-gray-600 mb-2">å‰ ${quiz.winners} åå¯å¾—åˆ†</div>
                                <div class="text-sm text-gray-500">
                                    ${quiz.startType === 'immediate' ? 'ç«‹å³é–‹å§‹' : `é–‹å§‹æ™‚é–“ï¼š${quiz.startDate} ${quiz.startTime}`}
                                </div>
                            </div>
                            <div class="text-right">
                                ${studentAnswer ? `
                                    <div class="text-${studentAnswer.isCorrect ? 'green' : 'red'}-600 font-semibold">
                                        ${studentAnswer.isCorrect ? 'âœ… ç­”å°äº†' : 'âŒ ç­”éŒ¯äº†'}
                                        ${studentAnswer.rank ? ` (ç¬¬${studentAnswer.rank}å)` : ''}
                                    </div>
                                ` : `
                                    <div class="text-red-600 font-semibold">âš¡ æ¶ç­”ä¸­</div>
                                `}
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-4 mb-4">
                            <div class="font-semibold text-gray-800 mb-2">é¡Œç›®ï¼š</div>
                            <p class="text-gray-700 whitespace-pre-wrap">${quiz.question}</p>
                        </div>
                        
                        ${studentAnswer ? `
                            <div class="p-4 rounded-lg ${studentAnswer.isCorrect ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="font-semibold ${studentAnswer.isCorrect ? 'text-green-800' : 'text-red-800'}">
                                        æ‚¨çš„ç­”æ¡ˆï¼š${studentAnswer.answer}
                                    </div>
                                    <div class="text-sm text-gray-500">${new Date(studentAnswer.submitTime).toLocaleString('zh-TW')}</div>
                                </div>
                                ${studentAnswer.isCorrect ? `
                                    <div class="text-sm text-green-700">
                                        ğŸ‰ æ­å–œç­”å°ï¼${studentAnswer.rank ? `ç²å¾—ç¬¬${studentAnswer.rank}åï¼Œå¾—åˆ° ${studentAnswer.scoreAwarded} åˆ†ï¼` : ''}
                                    </div>
                                ` : `
                                    <div class="text-sm text-red-700">
                                        ğŸ˜” ç­”æ¡ˆéŒ¯èª¤ï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${quiz.answer}
                                    </div>
                                `}
                            </div>
                        ` : `
                            <!-- ä½œç­”å€åŸŸ -->
                            <div class="border-t pt-4">
                                ${quiz.type === 'choice' ? `
                                    <div class="space-y-2 mb-4">
                                        ${Object.entries(quiz.choices).filter(([key, value]) => value).map(([key, value]) => `
                                            <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                                <input type="radio" name="quiz-${quiz.id}" value="${key}" class="text-blue-500">
                                                <span class="font-medium text-gray-700">${key}.</span>
                                                <span class="text-gray-700">${value}</span>
                                            </label>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <div class="mb-4">
                                        <textarea id="textAnswer-${quiz.id}" placeholder="è«‹è¼¸å…¥æ‚¨çš„ç­”æ¡ˆ..." rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"></textarea>
                                    </div>
                                `}
                                <button onclick="submitQuizAnswer('${quiz.id}')" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 px-6 rounded-lg transition-colors font-semibold">
                                    ğŸš€ æäº¤ç­”æ¡ˆ
                                </button>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        function checkQuizCountdown() {
            // æ¯æ¬¡æª¢æŸ¥æ™‚éƒ½é‡æ–°ç²å–ç•¶å‰æ™‚é–“
            const now = new Date();
            
            // æª¢æŸ¥é ç´„çš„æ¶åˆ†æ´»å‹•æ˜¯å¦åˆ°æ™‚é–“éœ€è¦å•Ÿå‹•
            quizzes.forEach(quiz => {
                if (quiz.startType === 'scheduled' && quiz.status === 'scheduled') {
                    const startTime = new Date(quiz.startDate + ' ' + quiz.startTime);
                    if (startTime <= now) {
                        // æ™‚é–“åˆ°äº†ï¼Œå•Ÿå‹•æ¶åˆ†æ´»å‹•
                        quiz.status = 'active';
                        google.script.run.setStorage('quizzes', quizzes);
                    }
                }
            });
            
            const scheduledQuizzes = quizzes.filter(quiz => 
                quiz.startType === 'scheduled' && 
                quiz.status === 'scheduled' &&
                new Date(quiz.startDate + ' ' + quiz.startTime) > now
            );
            
            if (scheduledQuizzes.length === 0) {
                document.getElementById('quizCountdownSection').classList.add('hidden');
                if (quizCountdown) {
                    clearInterval(quizCountdown);
                    quizCountdown = null;
                }
                return;
            }
            
            // æ‰¾åˆ°æœ€è¿‘çš„æ¶åˆ†æ´»å‹•
            const nextQuiz = scheduledQuizzes.sort((a, b) => 
                new Date(a.startDate + ' ' + a.startTime) - new Date(b.startDate + ' ' + b.startTime)
            )[0];
            
            document.getElementById('countdownQuizTitle').textContent = nextQuiz.title;
            document.getElementById('quizCountdownSection').classList.remove('hidden');
            
            // é–‹å§‹å€’æ•¸è¨ˆæ™‚
            if (quizCountdown) clearInterval(quizCountdown);
            
            quizCountdown = setInterval(() => {
                // æ¯ç§’éƒ½é‡æ–°ç²å–ç•¶å‰æ™‚é–“ï¼Œç¢ºä¿æ™‚é–“æº–ç¢º
                const currentTime = new Date();
                const startTime = new Date(nextQuiz.startDate + ' ' + nextQuiz.startTime);
                const timeDiff = startTime - currentTime;
                
                if (timeDiff <= 0) {
                    // æ™‚é–“åˆ°äº†ï¼Œå•Ÿå‹•æ¶åˆ†æ´»å‹•
                    nextQuiz.status = 'active';
                    google.script.run.setStorage('quizzes', quizzes);
                    
                    clearInterval(quizCountdown);
                    quizCountdown = null;
                    document.getElementById('quizCountdownSection').classList.add('hidden');
                    updateStudentQuizList();
                    return;
                }
                
                const hours = Math.floor(timeDiff / (1000 * 60 * 60));
                const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
                
                document.getElementById('countdownDisplay').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function submitQuizAnswer(quizId) {
            // ç”¨å­—ä¸²æ¯”è¼ƒæŸ¥æ‰¾å°æ‡‰çš„ quiz
            const quiz = quizzes.find(q => String(q.id) === String(quizId));
            if (!quiz || !currentStudent) return;

            // æª¢æŸ¥æ˜¯å¦å·²ç¶“ä½œç­”
            const hasAnswered = quizAnswers.some(answer =>
                String(answer.quizId) === String(quizId) && String(answer.studentId) === String(currentStudent.id)
            );
            if (hasAnswered) {
                alert('æ‚¨å·²ç¶“ä½œç­”éæ­¤é¡Œç›®');
                return;
            }

            // å–å¾—ä½¿ç”¨è€…ç­”æ¡ˆ
            let userAnswer;
            if (quiz.type === 'choice') {
                const selectedOption = document.querySelector(`input[name="quiz-${quizId}"]:checked`);
                if (!selectedOption) {
                    alert('è«‹é¸æ“‡ä¸€å€‹ç­”æ¡ˆ');
                    return;
                }
                userAnswer = selectedOption.value;
            } else {
                const textArea = document.getElementById(`textAnswer-${quizId}`);
                userAnswer = textArea.value.trim();
                if (!userAnswer) {
                    alert('è«‹è¼¸å…¥ç­”æ¡ˆ');
                    return;
                }
            }

            const isCorrect = userAnswer === quiz.answer;

            // æº–å‚™ç­”æ¡ˆç‰©ä»¶ï¼ŒsubmitTime ä½¿ç”¨ ISO æ ¼å¼
            const answer = {
                id: Date.now(),
                quizId: quizId,
                studentId: currentStudent.id,
                studentName: currentStudent.name,
                groupName: currentStudent.groupName,
                answer: userAnswer,
                submitTime: new Date().toISOString(),
                isCorrect: isCorrect
            };

            // å¾ä¼ºæœå™¨å–å¾—ç¾æœ‰ä½œç­”ç´€éŒ„ï¼Œå†æ ¹æ“šæœ€æ–°è³‡æ–™çµ¦åˆ†
            google.script.run.withSuccessHandler(function(serverAnswers) {
                if (isCorrect) {
                    const correctAnswers = (serverAnswers || []).filter(a =>
                        String(a.quizId) === String(quizId) && a.isCorrect
                    ).sort((a, b) => {
                        // è§£ææäº¤æ™‚é–“ï¼Œè‹¥ç„¡æ³•è§£æå‰‡è¦–ç‚ºæœ€æ—©
                        const parseTime = (t) => {
                            const d = new Date(t);
                            return isNaN(d) ? 0 : d.getTime();
                        };
                        return parseTime(a.submitTime) - parseTime(b.submitTime);
                    });
                    const rank = correctAnswers.length + 1;
                    if (rank <= quiz.winners) {
                        const scoreAwarded = Number(quiz.scores[rank]);
                        answer.rank = rank;
                        answer.scoreAwarded = scoreAwarded;
                        const student = students.find(s => String(s.id) === String(currentStudent.id));
                        if (student) {
                            // student å’Œ currentStudent æŒ‡å‘åŒä¸€å°è±¡ï¼Œåªéœ€åŠ ä¸€æ¬¡åˆ†æ•¸
                            student.score += scoreAwarded;
                            const historyRecord = {
                                id: Date.now() + Math.random(),
                                type: 'quiz',
                                targetId: student.id,
                                targetName: student.name,
                                groupName: student.groupName,
                                scoreChange: scoreAwarded,
                                reason: `æ¶åˆ†æ´»å‹•ç¬¬${rank}åï¼š${quiz.title}`,
                                date: new Date().toLocaleString('zh-TW'),
                                affectedStudents: [{
                                    id: student.id,
                                    name: student.name,
                                    scoreChange: scoreAwarded
                                }]
                            };
                            scoreHistory.unshift(historyRecord);
                            google.script.run.setStorage('students', students);
                            google.script.run.setStorage('scoreHistory', scoreHistory);
                            updateRankings();
                        }
                    }
                }
                // å°‡ç­”æ¡ˆåŠ å…¥æœ¬åœ°é™£åˆ—ä¸¦åŒæ­¥åˆ°å¾Œç«¯
                quizAnswers.push(answer);
                google.script.run.setStorage('quizAnswers', quizAnswers);
                updateStudentQuizList();
            }).getStorage('quizAnswers');
        }

        // æ•™å¸«æ¶åˆ†ç®¡ç†åŠŸèƒ½
        function showCreateQuizForm() {
            document.getElementById('createQuizForm').classList.remove('hidden');
            document.getElementById('quizHistorySection').classList.add('hidden');
            
            // è¨­å®šé è¨­æ—¥æœŸæ™‚é–“ç‚ºç•¶å‰æ™‚é–“çš„ä¸‹ä¸€å€‹å°æ™‚
            const now = new Date();
            const nextHour = new Date(now);
            nextHour.setHours(nextHour.getHours() + 1);
            nextHour.setMinutes(0);
            nextHour.setSeconds(0);
            
            // æ ¼å¼åŒ–æ—¥æœŸå’Œæ™‚é–“
            const year = nextHour.getFullYear();
            const month = String(nextHour.getMonth() + 1).padStart(2, '0');
            const day = String(nextHour.getDate()).padStart(2, '0');
            const hours = String(nextHour.getHours()).padStart(2, '0');
            const minutes = String(nextHour.getMinutes()).padStart(2, '0');
            
            document.getElementById('startDate').value = `${year}-${month}-${day}`;
            document.getElementById('startTime').value = `${hours}:${minutes}`;
            
            // ç›£è½é¡Œå‹è®ŠåŒ–
            document.getElementById('quizType').addEventListener('change', function() {
                const isChoice = this.value === 'choice';
                document.getElementById('choiceOptions').style.display = isChoice ? 'block' : 'none';
                document.getElementById('textAnswer').style.display = isChoice ? 'none' : 'block';
            });
            
            // ç›£è½å‰å¹¾åè®ŠåŒ–
            document.getElementById('quizWinners').addEventListener('input', function() {
                updateScoreSettings(parseInt(this.value) || 1);
            });
            
            // ç›£è½é–‹å§‹æ™‚é–“é¡å‹è®ŠåŒ–
            document.querySelectorAll('input[name="startType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('scheduledTime').style.display = 
                        this.value === 'scheduled' ? 'block' : 'none';
                });
            });
            
            // åˆå§‹åŒ–å¾—åˆ†è¨­å®š
            updateScoreSettings(1);
        }

        function hideCreateQuizForm() {
            document.getElementById('createQuizForm').classList.add('hidden');
            clearQuizForm();
        }

        function clearQuizForm() {
            document.getElementById('quizType').value = 'choice';
            document.getElementById('quizWinners').value = '';
            document.getElementById('quizQuestion').value = '';
            document.getElementById('choiceA').value = '';
            document.getElementById('choiceB').value = '';
            document.getElementById('choiceC').value = '';
            document.getElementById('choiceD').value = '';
            document.getElementById('quizAnswer').value = '';
            document.querySelector('input[name="correctChoice"]:checked').checked = false;
            document.querySelector('input[name="startType"][value="immediate"]').checked = true;
            document.getElementById('scheduledTime').style.display = 'none';
            document.getElementById('choiceOptions').style.display = 'block';
            document.getElementById('textAnswer').style.display = 'none';
        }

        function updateScoreSettings(winners) {
            const container = document.getElementById('scoreSettings');
            container.innerHTML = '';
            
            for (let i = 1; i <= winners; i++) {
                container.innerHTML += `
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-600 w-16">ç¬¬${i}åï¼š</span>
                        <input type="number" id="score${i}" placeholder="åˆ†æ•¸" min="1" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                `;
            }
        }

        function createQuiz() {
            const type = document.getElementById('quizType').value;
            const winners = parseInt(document.getElementById('quizWinners').value);
            const question = document.getElementById('quizQuestion').value.trim();
            const startType = document.querySelector('input[name="startType"]:checked').value;
            
            if (!winners || !question) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½');
                return;
            }
            
            if (winners < 1 || winners > 10) {
                alert('å‰å¹¾åå¾—åˆ†å¿…é ˆåœ¨ 1-10 ä¹‹é–“');
                return;
            }
            
            // æ”¶é›†å¾—åˆ†è¨­å®š
            const scores = {};
            for (let i = 1; i <= winners; i++) {
                const score = parseInt(document.getElementById(`score${i}`).value);
                if (!score || score < 1) {
                    alert(`è«‹è¨­å®šç¬¬${i}åçš„åˆ†æ•¸`);
                    return;
                }
                scores[i] = score;
            }
            
            let answer, choices;
            
            if (type === 'choice') {
                // é¸æ“‡é¡Œ
                const correctChoice = document.querySelector('input[name="correctChoice"]:checked');
                if (!correctChoice) {
                    alert('è«‹é¸æ“‡æ­£ç¢ºç­”æ¡ˆ');
                    return;
                }
                
                choices = {
                    A: document.getElementById('choiceA').value.trim(),
                    B: document.getElementById('choiceB').value.trim(),
                    C: document.getElementById('choiceC').value.trim(),
                    D: document.getElementById('choiceD').value.trim()
                };
                
                // æª¢æŸ¥è‡³å°‘æœ‰å…©å€‹é¸é …
                const filledChoices = Object.values(choices).filter(choice => choice);
                if (filledChoices.length < 2) {
                    alert('è‡³å°‘éœ€è¦å¡«å¯«å…©å€‹é¸é …');
                    return;
                }
                
                answer = correctChoice.value;
            } else {
                // å•ç­”é¡Œ
                answer = document.getElementById('quizAnswer').value.trim();
                if (!answer) {
                    alert('è«‹è¼¸å…¥æ¨™æº–ç­”æ¡ˆ');
                    return;
                }
            }
            
            let startDate, startTime;
            if (startType === 'scheduled') {
                startDate = document.getElementById('startDate').value;
                startTime = document.getElementById('startTime').value;
                
                if (!startDate || !startTime) {
                    alert('è«‹è¨­å®šé–‹å§‹æ—¥æœŸå’Œæ™‚é–“');
                    return;
                }
                
                const scheduledDateTime = new Date(startDate + ' ' + startTime);
                if (scheduledDateTime <= new Date()) {
                    alert('é–‹å§‹æ™‚é–“å¿…é ˆæ˜¯æœªä¾†æ™‚é–“');
                    return;
                }
            }
            
            const quiz = {
                id: Date.now(),
                title: `${type === 'choice' ? 'é¸æ“‡é¡Œ' : 'å•ç­”é¡Œ'}æ¶åˆ† - ${new Date().toLocaleString('zh-TW')}`,
                type: type,
                question: question,
                answer: answer,
                choices: choices,
                choiceA: (choices && choices.A) ? choices.A : '',
                choiceB: (choices && choices.B) ? choices.B : '',
                choiceC: (choices && choices.C) ? choices.C : '',
                choiceD: (choices && choices.D) ? choices.D : '',
                correct: (answer || ''),
                winners: winners,
                scores: scores,
                startType: startType,
                startDate: startDate,
                startTime: (startType === 'immediate' ? new Date().toISOString() : startTime),
                status: startType === 'immediate' ? 'active' : 'scheduled',
                createDate: new Date().toLocaleString('zh-TW'),
                endDate: null
            };
            
            quizzes.push(quiz);
            google.script.run.setStorage('quizzes', quizzes);
            
            hideCreateQuizForm();
            updateCurrentQuizList();
            alert('æ¶åˆ†æ´»å‹•å»ºç«‹æˆåŠŸï¼');
        }

        function updateCurrentQuizList() {
            const container = document.getElementById('currentQuizList');
            const activeQuizzes = quizzes.filter(quiz => quiz.status !== 'ended');
            
            if (activeQuizzes.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">âš¡</div>
                        <p>å°šç„¡æ¶åˆ†æ´»å‹•</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = activeQuizzes.map(quiz => {
                const typeIcon = quiz.type === 'choice' ? 'ğŸ“' : 'ğŸ’­';
                const typeText = quiz.type === 'choice' ? 'é¸æ“‡é¡Œ' : 'å•ç­”é¡Œ';
                const statusText = quiz.status === 'active' ? 'é€²è¡Œä¸­' : 'é ç´„ä¸­';
                const statusColor = quiz.status === 'active' ? 'text-green-600' : 'text-yellow-600';
                
                // çµ±è¨ˆä½œç­”æƒ…æ³
                // ç”¨å­—ä¸²æ¯”è¼ƒ quizId é¿å…é¡å‹ä¸ä¸€è‡´
                const totalAnswers = quizAnswers.filter(answer => String(answer.quizId) === String(quiz.id)).length;
                
                return `
                    <div class="bg-white rounded-xl p-6 border border-gray-200 card-shadow">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="text-2xl">${typeIcon}</span>
                                    <h3 class="text-xl font-bold text-gray-800">${quiz.title}</h3>
                                    <span class="text-sm px-2 py-1 rounded-full bg-blue-100 text-blue-700">${typeText}</span>
                                    <span class="text-sm px-2 py-1 rounded-full bg-gray-100 ${statusColor}">${statusText}</span>
                                </div>
                                <div class="text-sm text-gray-600 mb-2">å‰ ${quiz.winners} åå¯å¾—åˆ† | å·²æœ‰ ${totalAnswers} äººä½œç­”</div>
                                <div class="text-sm text-gray-500">
                                    å»ºç«‹æ™‚é–“ï¼š${quiz.createDate}
                                    ${quiz.startType === 'scheduled' ? ` | é–‹å§‹æ™‚é–“ï¼š${quiz.startDate} ${quiz.startTime}` : ''}
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="viewQuizAnswers('${quiz.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg transition-colors text-sm">
                                    æŸ¥çœ‹ä½œç­”
                                </button>
                                <button onclick="endQuiz('${quiz.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg transition-colors text-sm">
                                    çµæŸæ´»å‹•
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="font-semibold text-gray-800 mb-2">é¡Œç›®ï¼š</div>
                            <p class="text-gray-700 whitespace-pre-wrap">${quiz.question}</p>
                            
                            ${quiz.type === 'choice' ? `
                                <div class="mt-3">
                                    <div class="font-semibold text-gray-800 mb-1">é¸é …ï¼š</div>
                                    ${Object.entries(quiz.choices).filter(([key, value]) => value).map(([key, value]) => 
                                        `<div class="text-sm ${key === quiz.answer ? 'text-green-600 font-semibold' : 'text-gray-600'}">
                                            ${key}. ${value} ${key === quiz.answer ? '(æ­£ç¢ºç­”æ¡ˆ)' : ''}
                                        </div>`
                                    ).join('')}
                                </div>
                            ` : `
                                <div class="mt-3">
                                    <div class="font-semibold text-gray-800 mb-1">æ¨™æº–ç­”æ¡ˆï¼š</div>
                                    <div class="text-green-600 font-semibold">${quiz.answer}</div>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewQuizAnswers(quizId) {
            const quiz = quizzes.find(q => String(q.id) === String(quizId));
            if (!quiz) return;
            
            const answers = quizAnswers.filter(answer => String(answer.quizId) === String(quizId));
            
            if (answers.length === 0) {
                alert('å°šç„¡å­¸ç”Ÿä½œç­”');
                return;
            }
            
            // å»ºç«‹ä½œç­”çµæœè¦–çª—
            let resultHTML = `æ¶åˆ†æ´»å‹•ï¼š${quiz.title}\n\n`;
            
            // çµ±è¨ˆç­”å°å’Œç­”éŒ¯çš„å­¸ç”Ÿ
            const correctAnswers = answers.filter(answer => answer.isCorrect);
            const incorrectAnswers = answers.filter(answer => !answer.isCorrect);
            
            resultHTML += `ç¸½ä½œç­”äººæ•¸ï¼š${answers.length}\n`;
            resultHTML += `ç­”å°äººæ•¸ï¼š${correctAnswers.length}\n`;
            resultHTML += `ç­”éŒ¯äººæ•¸ï¼š${incorrectAnswers.length}\n\n`;
            
            if (correctAnswers.length > 0) {
                resultHTML += 'âœ… ç­”å°å­¸ç”Ÿï¼ˆæŒ‰ä½œç­”æ™‚é–“æ’åºï¼‰ï¼š\n';
                correctAnswers
                    // æŒ‰æäº¤æ™‚é–“æ’åºï¼Œä½¿ç”¨ submitTime æ¬„ä½
                    .sort((a, b) => new Date(a.submitTime) - new Date(b.submitTime))
                    .forEach((answer, index) => {
                        const rank = index + 1;
                        const scoreAwarded = answer.scoreAwarded || 0;
                        resultHTML += `${rank}. ${answer.studentName} (${answer.groupName}) - ${answer.answer}`;
                        if (rank <= quiz.winners && scoreAwarded > 0) {
                            resultHTML += ` [å·²å¾— ${scoreAwarded} åˆ†]`;
                        }
                        // å°‡ ISO æ™‚é–“è½‰ç‚ºæœ¬åœ°æ ¼å¼é¡¯ç¤º
                        resultHTML += `\n   æ™‚é–“ï¼š${new Date(answer.submitTime).toLocaleString('zh-TW')}\n`;
                    });
                resultHTML += '\n';
            }
            
            if (incorrectAnswers.length > 0) {
                resultHTML += 'âŒ ç­”éŒ¯å­¸ç”Ÿï¼š\n';
                incorrectAnswers.forEach((answer, index) => {
                    resultHTML += `${index + 1}. ${answer.studentName} (${answer.groupName}) - ${answer.answer}\n`;
                    // è½‰æ› ISO æ™‚é–“ç‚ºæœ¬åœ°æ ¼å¼
                    resultHTML += `   æ™‚é–“ï¼š${new Date(answer.submitTime).toLocaleString('zh-TW')}\n`;
                });
                resultHTML += '\n';
            }
            
            resultHTML += `æ­£ç¢ºç­”æ¡ˆï¼š${quiz.answer}\n`;
            
            if (quiz.type === 'choice') {
                resultHTML += '\né¸é …ï¼š\n';
                Object.entries(quiz.choices).filter(([key, value]) => value).forEach(([key, value]) => {
                    resultHTML += `${key}. ${value}${key === quiz.answer ? ' (æ­£ç¢ºç­”æ¡ˆ)' : ''}\n`;
                });
            }
            
            alert(resultHTML);
        }



        function endQuiz(quizId) {
            // ç”¨å­—ä¸²æ¯”è¼ƒæ‰¾åˆ°å°æ‡‰çš„ quizï¼Œé¿å… ID å‹åˆ¥ä¸ä¸€è‡´
            const quiz = quizzes.find(q => String(q.id) === String(quizId));
            if (!quiz) return;
            
            if (confirm(`ç¢ºå®šè¦çµæŸæ¶åˆ†æ´»å‹•ã€Œ${quiz.title}ã€å—ï¼Ÿ`)) {
                quiz.status = 'ended';
                quiz.endDate = new Date().toLocaleString('zh-TW');
                
                google.script.run.setStorage('quizzes', quizzes);
                updateCurrentQuizList();
                alert('æ¶åˆ†æ´»å‹•å·²çµæŸï¼');
            }
        }

        function showQuizHistory() {
            document.getElementById('createQuizForm').classList.add('hidden');
            document.getElementById('quizHistorySection').classList.remove('hidden');
            updateQuizHistory();
        }

        function hideQuizHistory() {
            document.getElementById('quizHistorySection').classList.add('hidden');
        }

        function updateQuizHistory() {
            const container = document.getElementById('quizHistoryList');
            const endedQuizzes = quizzes.filter(quiz => quiz.status === 'ended');
            
            if (endedQuizzes.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">ğŸ“Š</div>
                        <p>å°šç„¡æ´»å‹•è¨˜éŒ„</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = endedQuizzes.map(quiz => {
                const typeIcon = quiz.type === 'choice' ? 'ğŸ“' : 'ğŸ’­';
                const typeText = quiz.type === 'choice' ? 'é¸æ“‡é¡Œ' : 'å•ç­”é¡Œ';
                // ç”¨å­—ä¸²æ¯”è¼ƒ quizId é¿å…é¡å‹ä¸ä¸€è‡´
                const totalAnswers = quizAnswers.filter(answer => String(answer.quizId) === String(quiz.id)).length;
                
                return `
                    <div class="bg-white rounded-xl p-4 border border-gray-200">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="flex items-center space-x-2 mb-1">
                                    <span class="text-xl">${typeIcon}</span>
                                    <h4 class="font-semibold text-gray-800">${quiz.title}</h4>
                                    <span class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600">${typeText}</span>
                                </div>
                                <div class="text-sm text-gray-600">
                                    å»ºç«‹ï¼š${quiz.createDate} | çµæŸï¼š${quiz.endDate}
                                </div>
                                <div class="text-sm text-gray-500">
                                    å…± ${totalAnswers} äººåƒèˆ‡ | å‰ ${quiz.winners} åå¾—åˆ†
                                </div>
                            </div>
                            <button onclick="viewQuizAnswers('${quiz.id}')" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg transition-colors text-sm">
                                æŸ¥çœ‹çµæœ
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97680b49636e8097',t:'MTc1NjQyODUyMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
