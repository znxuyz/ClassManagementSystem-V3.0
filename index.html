<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>班級管理系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 這裡放原本的 CSS （我幫你保留了） */
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; }
    /* 你的動畫、樣式 ... 全部貼這裡 */
  </style>
</head>
<body class="gradient-bg min-h-screen">
  <!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>班級排行榜系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .rank-animation {
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .podium-rise {
            transition: transform 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .info-appear {
            transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .score-pulse {
            animation: pulse 0.6s ease-in-out;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .floating {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffed4e); }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #e8e8e8); }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #daa520); }
        
        .modal {
            backdrop-filter: blur(5px);
        }
        
        /* 自定義滾動條樣式 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 via-purple-50 to-pink-100 min-h-screen">
    <!-- 學生登入模態框 -->
    <div id="studentLoginModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 card-shadow">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">👨‍🎓</div>
                <h2 class="text-2xl font-bold text-gray-800">學生登入</h2>
                <p class="text-gray-600 mt-2">請選擇您的姓名</p>
            </div>
            
            <div class="space-y-4">
                <input type="text" id="studentNameInput" placeholder="請輸入您的姓名" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="loginAsStudent()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl transition-colors">
                    登入
                </button>
                <button onclick="closeLoginModal()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-xl transition-colors">
                    取消
                </button>
                <div id="studentLoginError" class="hidden mt-2 text-red-500 text-sm text-center"></div>
            </div>
        </div>
    </div>

    <!-- 教師登入模態框 -->
    <div id="teacherLoginModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 card-shadow">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">👩‍🏫</div>
                <h2 class="text-2xl font-bold text-gray-800">教師登入</h2>
                <p class="text-gray-600 mt-2">請輸入教師密碼</p>
            </div>
            
            <div class="space-y-4">
                <input type="password" id="teacherPassword" placeholder="請輸入教師密碼" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500">
                <button onclick="loginAsTeacher()" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-xl transition-colors">
                    登入
                </button>
                <button onclick="closeLoginModal()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-xl transition-colors">
                    取消
                </button>
                <div id="loginError" class="hidden mt-2 text-red-500 text-sm text-center"></div>
                <div id="lockoutMessage" class="hidden mt-2 text-red-600 text-sm text-center font-semibold"></div>
            </div>
        </div>
    </div>

    <!-- 學生分數查詢模態框 -->
    <div id="scoreQueryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 card-shadow max-h-[90vh] overflow-y-auto">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">📊</div>
                <h2 class="text-2xl font-bold text-gray-800">查詢我的分數</h2>
                <p class="text-gray-600 mt-2">輸入您的姓名查看分數與排名</p>
            </div>
            
            <div class="space-y-4">
                <input type="text" id="scoreQueryName" placeholder="請輸入您的姓名" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500">
                <button onclick="queryScore()" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-xl transition-colors">
                    查詢分數
                </button>
                <button onclick="closeScoreQueryModal()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-xl transition-colors">
                    關閉
                </button>
                
                <!-- 查詢結果顯示區 -->
                <div id="scoreQueryResult" class="hidden mt-6 p-4 bg-gray-50 rounded-xl">
                    <div class="text-center">
                        <div id="studentAvatar" class="text-4xl mb-2">👨‍🎓</div>
                        <div id="studentNameDisplay" class="text-xl font-bold text-gray-800 mb-2"></div>
                        <div id="studentGroupDisplay" class="text-sm text-gray-600 mb-4"></div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-white rounded-lg p-3 text-center">
                                <div class="text-2xl font-bold text-blue-600" id="studentScoreDisplay">0</div>
                                <div class="text-xs text-gray-500">個人分數</div>
                            </div>
                            <div class="bg-white rounded-lg p-3 text-center">
                                <div class="text-2xl font-bold text-purple-600" id="studentRankDisplay">-</div>
                                <div class="text-xs text-gray-500">個人排名</div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg p-3 text-center">
                            <div class="text-lg font-bold text-green-600" id="groupScoreDisplay">0</div>
                            <div class="text-xs text-gray-500">小組總分</div>
                        </div>
                    </div>
                </div>
                
                <!-- 分數變化記錄區域 -->
                <div id="studentScoreHistory" class="mt-6">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-semibold text-gray-800">📈 我的分數變化記錄</h4>
                    </div>
                    
                    <div id="studentHistoryList" class="space-y-2 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-3 bg-gray-50 custom-scrollbar" style="scrollbar-width: thin; scrollbar-color: #cbd5e0 #f7fafc;">
                        <!-- 分數記錄將在這裡顯示 -->
                    </div>
                </div>
                
                <div id="scoreQueryError" class="hidden mt-2 text-red-500 text-sm text-center"></div>
            </div>
        </div>
    </div>

    <!-- 學生留言板模態框 -->
    <div id="messageboardModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-4xl w-full mx-4 card-shadow max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center space-x-3">
                    <div class="text-4xl">💬</div>
                    <h2 class="text-2xl font-bold text-gray-800">學生留言板</h2>
                </div>
                <button onclick="closeMessageboardModal()" class="text-gray-500 hover:text-gray-700 text-2xl">✕</button>
            </div>
            
            <!-- 學生發表留言區 -->
            <div id="studentMessageForm" class="hidden mb-6 p-4 bg-blue-50 rounded-xl">
                <h3 class="font-semibold text-gray-800 mb-3">發表新留言</h3>
                <textarea id="messageContent" placeholder="請輸入您的留言..." rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="messageVisibility" value="private" checked class="text-blue-500">
                            <span class="text-sm text-gray-700">🔒 僅老師可見</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="messageVisibility" value="public" class="text-blue-500">
                            <span class="text-sm text-gray-700">🌍 公開給全班</span>
                        </label>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="postMessage()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">發布留言</button>
                        <button onclick="clearMessageForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">清空</button>
                    </div>
                </div>
            </div>

            <!-- 留言列表 -->
            <div id="messagesList" class="space-y-4">
                <div class="text-center text-gray-500 py-8">
                    <div class="text-4xl mb-2">📝</div>
                    <p>尚無留言</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 學生獎品兌換模態框 -->
    <div id="rewardExchangeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-4xl w-full mx-4 card-shadow max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center space-x-3">
                    <div class="text-4xl">🎁</div>
                    <h2 class="text-2xl font-bold text-gray-800">獎品兌換</h2>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="showExchangeHistory()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                        📋 兌換記錄
                    </button>
                    <button onclick="closeRewardExchangeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">✕</button>
                </div>
            </div>
            
            <!-- 學生分數顯示 -->
            <div id="studentPointsDisplay" class="mb-6 p-4 bg-blue-50 rounded-xl text-center">
                <div class="text-lg font-semibold text-gray-800 mb-2">我的點數</div>
                <div class="text-3xl font-bold text-blue-600" id="currentStudentPoints">0</div>
            </div>
            
            <!-- 獎品列表 -->
            <div id="rewardsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="text-center text-gray-500 py-8 col-span-full">
                    <div class="text-4xl mb-2">🎁</div>
                    <p>尚無可兌換獎品</p>
                </div>
            </div>
            
            <!-- 兌換記錄區域 -->
            <div id="exchangeHistorySection" class="hidden">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">我的兌換記錄</h3>
                    <button onclick="hideExchangeHistory()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                        ← 返回獎品列表
                    </button>
                </div>
                
                <div id="studentExchangeHistory" class="space-y-3">
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">📋</div>
                        <p>尚無兌換記錄</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 學生搶分模態框 -->
    <div id="studentQuizModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-4xl w-full mx-4 card-shadow max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center space-x-3">
                    <div class="text-4xl">⚡</div>
                    <h2 class="text-2xl font-bold text-gray-800">搶分活動</h2>
                </div>
                <button onclick="closeStudentQuizModal()" class="text-gray-500 hover:text-gray-700 text-2xl">✕</button>
            </div>
            
            <!-- 倒數計時區 -->
            <div id="quizCountdownSection" class="hidden mb-6 p-6 bg-gradient-to-r from-red-100 to-orange-100 rounded-xl text-center">
                <div class="text-lg font-semibold text-gray-800 mb-2">搶分活動即將開始</div>
                <div id="countdownDisplay" class="text-4xl font-bold text-red-600 mb-2">00:00:00</div>
                <div id="countdownQuizTitle" class="text-gray-600"></div>
            </div>
            
            <!-- 搶分活動列表 -->
            <div id="studentQuizList" class="space-y-4">
                <div class="text-center text-gray-500 py-8">
                    <div class="text-4xl mb-2">⚡</div>
                    <p>目前沒有搶分活動</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改密碼模態框 -->
    <div id="changePasswordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 card-shadow">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">🔑</div>
                <h2 class="text-2xl font-bold text-gray-800">修改教師密碼</h2>
                <p class="text-gray-600 mt-2">請輸入舊密碼和新密碼</p>
            </div>
            
            <div class="space-y-4">
                <input type="password" id="oldPassword" placeholder="請輸入舊密碼" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500">
                <input type="password" id="newPassword" placeholder="請輸入新密碼" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500">
                <input type="password" id="confirmPassword" placeholder="請再次輸入新密碼" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500">
                <button onclick="changePassword()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 px-6 rounded-xl transition-colors">
                    修改密碼
                </button>
                <button onclick="closeChangePasswordModal()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-xl transition-colors">
                    取消
                </button>
                <div id="changePasswordError" class="hidden mt-2 text-red-500 text-sm text-center"></div>
                <div id="changePasswordSuccess" class="hidden mt-2 text-green-500 text-sm text-center"></div>
            </div>
        </div>
    </div>

    <!-- 主要內容 -->
    <div id="mainContent" class="hidden">
        <!-- 左上角主畫面按鈕 -->
        <div class="fixed left-4 top-4 z-40">
            <button id="homeBtn" onclick="showHomeTab()" class="bg-gray-500 hover:bg-gray-600 w-16 h-16 rounded-full transition-colors flex items-center justify-center text-2xl shadow-lg" title="主畫面">
                🏠
            </button>
        </div>
        
        <!-- 左側中間功能按鈕 -->
        <div class="fixed left-4 top-1/2 transform -translate-y-1/2 z-40 flex flex-col space-y-4">
            <!-- 學生功能按鈕 -->
            <button id="messageboardBtn" onclick="showMessageboard()" class="hidden bg-purple-500 hover:bg-purple-600 w-16 h-16 rounded-full transition-colors flex items-center justify-center text-2xl shadow-lg" title="學生留言板">
                💬
            </button>
            
            <button id="scoreQueryBtn" onclick="showScoreQuery()" class="hidden bg-green-500 hover:bg-green-600 w-16 h-16 rounded-full transition-colors flex items-center justify-center text-2xl shadow-lg" title="查詢我的分數">
                📊
            </button>
            
            <button id="rewardExchangeBtn" onclick="showRewardExchange()" class="hidden bg-yellow-500 hover:bg-yellow-600 w-16 h-16 rounded-full transition-colors flex items-center justify-center text-2xl shadow-lg" title="獎品兌換">
                🎁
            </button>
            
            <button id="studentQuizBtn" onclick="showStudentQuiz()" class="hidden bg-red-500 hover:bg-red-600 w-16 h-16 rounded-full transition-colors flex items-center justify-center text-2xl shadow-lg" title="搶分活動">
                ⚡
            </button>
            
            <!-- 教師功能按鈕 -->
            <button id="manageBtn" onclick="showManageTab()" class="hidden bg-blue-500 hover:bg-blue-600 w-16 h-16 rounded-full transition-colors flex items-center justify-center text-2xl shadow-lg" title="班級分組建立">
                📝
            </button>
            
            <button id="messagesBtn" onclick="showMessagesTab()" class="hidden bg-indigo-500 hover:bg-indigo-600 w-16 h-16 rounded-full transition-colors flex items-center justify-center text-2xl shadow-lg" title="學生留言管理">
                💬
            </button>
            
            <button id="scoreHistoryBtn" onclick="showScoreHistoryTab()" class="hidden bg-purple-500 hover:bg-purple-600 w-16 h-16 rounded-full transition-colors flex items-center justify-center text-2xl shadow-lg" title="分數變化記錄">
                📈
            </button>
            
            <button id="rewardManageBtn" onclick="showRewardManageTab()" class="hidden bg-yellow-500 hover:bg-yellow-600 w-16 h-16 rounded-full transition-colors flex items-center justify-center text-2xl shadow-lg" title="獎品管理">
                🎁
            </button>
            
            <button id="quizManageBtn" onclick="showQuizManageTab()" class="hidden bg-red-500 hover:bg-red-600 w-16 h-16 rounded-full transition-colors flex items-center justify-center text-2xl shadow-lg" title="搶分管理">
                ⚡
            </button>
        </div>
        
        <!-- 左下角修改密碼按鈕 -->
        <div class="fixed left-4 bottom-4 z-40">
            <button id="changePasswordBtn" onclick="showChangePasswordModal()" class="hidden bg-orange-500 hover:bg-orange-600 w-16 h-16 rounded-full transition-colors flex items-center justify-center text-2xl shadow-lg" title="修改教師密碼">
                🔑
            </button>
        </div>
        
        <!-- 右上角登入按鈕 -->
        <div class="fixed top-4 right-4 z-40">
            <!-- 未登入狀態 -->
            <div id="loginButtons" class="flex flex-col space-y-2">
                <button onclick="showStudentLogin()" class="bg-blue-500 hover:bg-blue-600 w-12 h-12 rounded-full transition-colors flex items-center justify-center text-xl shadow-lg" title="學生登入">
                    👨‍🎓
                </button>
                <button onclick="showTeacherLogin()" class="bg-green-500 hover:bg-green-600 w-12 h-12 rounded-full transition-colors flex items-center justify-center text-xl shadow-lg" title="教師登入">
                    👩‍🏫
                </button>
            </div>
            
            <!-- 已登入狀態 -->
            <div id="userInfo" class="hidden flex flex-col items-end space-y-2">
                <div class="bg-white rounded-full px-4 py-2 shadow-lg">
                    <span id="userMode" class="text-sm font-semibold text-gray-800"></span>
                </div>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 w-12 h-12 rounded-full transition-colors flex items-center justify-center text-xl shadow-lg text-white" title="登出">
                    🚪
                </button>
            </div>
        </div>
        
        <!-- 標題區 -->
        <div class="text-center py-6">
            <div class="flex items-center justify-center space-x-4 mb-4">
                <div class="text-4xl floating">🏆</div>
                <h1 id="classTitle" class="text-4xl font-bold text-gray-800 cursor-pointer hover:text-blue-600 transition-colors" onclick="editTitle()">班級管理系統</h1>
            </div>
        </div>

        <!-- 主要內容區 -->
        <div class="max-w-6xl mx-auto px-4 pb-8">
            <!-- 排行榜區域 -->
            <div id="homeContent" class="max-w-6xl mx-auto">
                <!-- 合併排行榜 -->
                <div class="bg-white rounded-2xl p-6 card-shadow mb-8">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                            🏆 排行榜
                        </h2>
                        <div class="flex space-x-2">
                            <button id="groupRankBtn" onclick="switchRankingMode('group')" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">
                                👥 小組排行
                            </button>
                            <button id="individualRankBtn" onclick="switchRankingMode('individual')" class="px-4 py-2 rounded-lg bg-blue-500 text-white transition-colors">
                                🌟 個人排行
                            </button>
                        </div>
                    </div>
                    
                    <!-- 頒獎台區域 -->
                    <div id="podiumContainer" class="mb-8">
                        <div class="flex justify-center items-end space-x-4 h-64">
                            <!-- 第二名 -->
                            <div class="flex flex-col items-center">
                                <div id="rank2Info" class="info-appear text-center mb-2 opacity-0 transform translate-y-4">
                                    <div class="text-4xl mb-1">🥈</div>
                                    <div class="font-bold text-gray-800 text-sm"></div>
                                    <div class="text-xs text-gray-600"></div>
                                    <div class="text-lg font-bold text-gray-800"></div>
                                </div>
                                <div id="podium2" class="podium-rise w-20 bg-gradient-to-t from-gray-400 to-gray-300 rounded-t-lg transform scale-y-0 origin-bottom" style="height: 0px;">
                                    <div class="text-white font-bold text-center py-2 text-sm">2</div>
                                </div>
                            </div>
                            
                            <!-- 第一名 -->
                            <div class="flex flex-col items-center">
                                <div id="rank1Info" class="info-appear text-center mb-2 opacity-0 transform translate-y-4">
                                    <div class="text-5xl mb-1">🥇</div>
                                    <div class="font-bold text-gray-800"></div>
                                    <div class="text-xs text-gray-600"></div>
                                    <div class="text-xl font-bold text-gray-800"></div>
                                </div>
                                <div id="podium1" class="podium-rise w-24 bg-gradient-to-t from-yellow-500 to-yellow-300 rounded-t-lg transform scale-y-0 origin-bottom" style="height: 0px;">
                                    <div class="text-white font-bold text-center py-2">1</div>
                                </div>
                            </div>
                            
                            <!-- 第三名 -->
                            <div class="flex flex-col items-center">
                                <div id="rank3Info" class="info-appear text-center mb-2 opacity-0 transform translate-y-4">
                                    <div class="text-3xl mb-1">🥉</div>
                                    <div class="font-bold text-gray-800 text-sm"></div>
                                    <div class="text-xs text-gray-600"></div>
                                    <div class="text-md font-bold text-gray-800"></div>
                                </div>
                                <div id="podium3" class="podium-rise w-16 bg-gradient-to-t from-orange-600 to-orange-400 rounded-t-lg transform scale-y-0 origin-bottom" style="height: 0px;">
                                    <div class="text-white font-bold text-center py-1 text-sm">3</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 第四第五名 -->
                    <div id="otherRankings" class="space-y-3">
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-2">📊</div>
                            <p id="emptyMessage">尚未建立學生</p>
                        </div>
                    </div>
                </div>

                <!-- 快速加分區 (教師專用) -->
                <div id="quickScoreSection" class="hidden bg-white rounded-2xl p-6 card-shadow mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                        ⚡ 快速加減分
                    </h3>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- 小組加分 -->
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-3">👥 小組加減分</h4>
                            <div class="space-y-3">
                                <select id="groupSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">選擇小組</option>
                                </select>
                                <div class="flex space-x-2">
                                    <input type="number" id="groupScore" placeholder="分數" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <button onclick="addGroupScore()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                                        ➕
                                    </button>
                                    <button onclick="subtractGroupScore()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                                        ➖
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 個人加分 -->
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-3">🌟 個人加減分</h4>
                            <div class="space-y-3">
                                <select id="studentSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">選擇學生</option>
                                </select>
                                <div class="flex space-x-2">
                                    <input type="number" id="studentScore" placeholder="分數" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <button onclick="addStudentScore()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                                        ➕
                                    </button>
                                    <button onclick="subtractStudentScore()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                                        ➖
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 課程公告區 -->
                <div class="bg-white rounded-2xl p-6 card-shadow">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                            📢 課程公告
                        </h2>
                        <button id="addAnnouncementBtn" onclick="showAnnouncementForm()" class="hidden bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            ➕ 新增公告
                        </button>
                    </div>

                    <!-- 公告表單 -->
                    <div id="announcementForm" class="hidden mb-6 p-4 bg-gray-50 rounded-xl">
                        <input type="text" id="announcementTitle" placeholder="公告標題" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <textarea id="announcementContent" placeholder="公告內容" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        <input type="url" id="announcementLink" placeholder="相關連結 (選填)" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="flex space-x-2">
                            <button onclick="addAnnouncement()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">發布</button>
                            <button onclick="hideAnnouncementForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">取消</button>
                        </div>
                    </div>

                    <!-- 公告列表 -->
                    <div id="announcements" class="space-y-4">
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-2">📝</div>
                            <p>尚無課程公告</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 教師留言管理頁面 -->
        <div id="messagesContent" class="hidden max-w-6xl mx-auto px-4 pb-8">
            <div class="bg-white rounded-2xl p-6 card-shadow">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        💬 學生留言管理
                    </h2>
                    <div class="flex items-center space-x-2">
                        <div class="flex space-x-2">
                            <button id="filterAll" onclick="filterMessages('all')" class="px-4 py-2 rounded-lg bg-blue-500 text-white transition-colors">全部</button>
                            <button id="filterPublic" onclick="filterMessages('public')" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">公開</button>
                            <button id="filterPrivate" onclick="filterMessages('private')" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">私人</button>
                        </div>
                        <button onclick="showHomeTab()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                            ← 返回首頁
                        </button>
                    </div>
                </div>
                
                <div id="teacherMessagesList" class="space-y-4">
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">📝</div>
                        <p>尚無學生留言</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 分數變化記錄頁面 -->
        <div id="scoreHistoryContent" class="hidden max-w-6xl mx-auto px-4 pb-8">
            <div class="bg-white rounded-2xl p-6 card-shadow">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        📈 分數變化記錄
                    </h2>
                    <div class="flex items-center space-x-2">
                        <div class="flex space-x-2">
                            <button id="historyFilterAll" onclick="filterScoreHistory('all')" class="px-4 py-2 rounded-lg bg-blue-500 text-white transition-colors">全部記錄</button>
                            <button id="historyFilterGroup" onclick="filterScoreHistory('group')" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">小組加分</button>
                            <button id="historyFilterIndividual" onclick="filterScoreHistory('individual')" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">個人加分</button>
                        </div>
                        <select id="studentHistoryFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">選擇學生篩選</option>
                        </select>

                        <button onclick="showHomeTab()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                            ← 返回首頁
                        </button>
                    </div>
                </div>
                
                <!-- 統計資訊 -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-blue-600" id="totalRecords">0</div>
                        <div class="text-sm text-gray-600">總記錄數</div>
                    </div>
                    <div class="bg-green-50 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-green-600" id="totalPositive">0</div>
                        <div class="text-sm text-gray-600">加分次數</div>
                    </div>
                    <div class="bg-red-50 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-red-600" id="totalNegative">0</div>
                        <div class="text-sm text-gray-600">扣分次數</div>
                    </div>
                    <div class="bg-purple-50 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-purple-600" id="todayRecords">0</div>
                        <div class="text-sm text-gray-600">今日記錄</div>
                    </div>
                </div>
                
                <div id="scoreHistoryList" class="space-y-3">
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">📊</div>
                        <p>尚無分數變化記錄</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 教師搶分管理頁面 -->
        <div id="quizManageContent" class="hidden max-w-6xl mx-auto px-4 pb-8">
            <div class="bg-white rounded-2xl p-6 card-shadow">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        ⚡ 搶分管理
                    </h2>
                    <div class="flex items-center space-x-2">
                        <button onclick="showCreateQuizForm()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                            ➕ 建立搶分活動
                        </button>
                        <button onclick="showQuizHistory()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors">
                            📊 活動記錄
                        </button>
                        <button onclick="showHomeTab()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                            ← 返回首頁
                        </button>
                    </div>
                </div>
                
                <!-- 建立搶分活動表單 -->
                <div id="createQuizForm" class="hidden mb-6 p-4 bg-gray-50 rounded-xl">
                    <h3 class="font-semibold text-gray-800 mb-4">建立新的搶分活動</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">題型</label>
                            <select id="quizType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="choice">選擇題</option>
                                <option value="text">問答題</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">前幾名得分</label>
                            <input type="number" id="quizWinners" placeholder="例如：3" min="1" max="10" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">題目</label>
                            <textarea id="quizQuestion" placeholder="請輸入題目內容" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                        </div>
                    </div>
                    
                    <!-- 選擇題選項 -->
                    <div id="choiceOptions" class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">選項設定</label>
                        <div class="space-y-2">
                            <div class="flex items-center space-x-2">
                                <input type="radio" name="correctChoice" value="A" id="choiceA_radio" class="text-green-500">
                                <label for="choiceA_radio" class="text-sm text-gray-600">正確答案</label>
                                <input type="text" id="choiceA" placeholder="選項 A" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="radio" name="correctChoice" value="B" id="choiceB_radio" class="text-green-500">
                                <label for="choiceB_radio" class="text-sm text-gray-600">正確答案</label>
                                <input type="text" id="choiceB" placeholder="選項 B" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="radio" name="correctChoice" value="C" id="choiceC_radio" class="text-green-500">
                                <label for="choiceC_radio" class="text-sm text-gray-600">正確答案</label>
                                <input type="text" id="choiceC" placeholder="選項 C" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="radio" name="correctChoice" value="D" id="choiceD_radio" class="text-green-500">
                                <label for="choiceD_radio" class="text-sm text-gray-600">正確答案</label>
                                <input type="text" id="choiceD" placeholder="選項 D" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 問答題答案 -->
                    <div id="textAnswer" class="hidden mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">標準答案</label>
                        <textarea id="quizAnswer" placeholder="請輸入標準答案" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                    </div>
                    
                    <!-- 得分設定 -->
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">得分設定</label>
                        <div id="scoreSettings" class="space-y-2">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-600 w-16">第1名：</span>
                                <input type="number" id="score1" placeholder="分數" min="1" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 開始時間設定 -->
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">開始時間</label>
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="startType" value="immediate" checked class="text-green-500">
                                <span class="text-sm text-gray-700">立即開始</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="startType" value="scheduled" class="text-green-500">
                                <span class="text-sm text-gray-700">預約開始</span>
                            </label>
                        </div>
                        <div id="scheduledTime" class="hidden mt-3 grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">開始日期</label>
                                <input type="date" id="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">開始時間</label>
                                <input type="time" id="startTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2 mt-6">
                        <button onclick="createQuiz()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">建立活動</button>
                        <button onclick="hideCreateQuizForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">取消</button>
                    </div>
                </div>
                
                <!-- 活動記錄區域 -->
                <div id="quizHistorySection" class="hidden mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">活動記錄</h3>
                        <button onclick="hideQuizHistory()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                            ← 返回活動列表
                        </button>
                    </div>
                    
                    <div id="quizHistoryList" class="space-y-3">
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-2">📊</div>
                            <p>尚無活動記錄</p>
                        </div>
                    </div>
                </div>
                
                <!-- 目前活動列表 -->
                <div id="currentQuizList" class="space-y-4">
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">⚡</div>
                        <p>尚無搶分活動</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 教師獎品管理頁面 -->
        <div id="rewardManageContent" class="hidden max-w-6xl mx-auto px-4 pb-8">
            <div class="bg-white rounded-2xl p-6 card-shadow">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        🎁 獎品管理
                    </h2>
                    <div class="flex items-center space-x-2">
                        <button onclick="showAddRewardForm()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                            ➕ 新增獎品
                        </button>
                        <button onclick="showExchangeRequests()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            📋 兌換申請
                        </button>
                        <button onclick="showTeacherExchangeHistory()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors">
                            📊 兌換記錄
                        </button>
                        <button onclick="showHomeTab()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                            ← 返回首頁
                        </button>
                    </div>
                </div>
                
                <!-- 新增獎品表單 -->
                <div id="addRewardForm" class="hidden mb-6 p-4 bg-gray-50 rounded-xl">
                    <h3 class="font-semibold text-gray-800 mb-4">新增獎品</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">獎品名稱</label>
                            <input type="text" id="rewardName" placeholder="請輸入獎品名稱" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">所需點數</label>
                            <input type="number" id="rewardPoints" placeholder="請輸入所需點數" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">獎品數量</label>
                            <input type="number" id="rewardQuantity" placeholder="請輸入獎品數量" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">獎品圖片</label>
                            <input type="file" id="rewardImage" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">獎品描述</label>
                        <textarea id="rewardDescription" placeholder="請輸入獎品描述" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                    </div>
                    <div class="flex space-x-2 mt-4">
                        <button onclick="addReward()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">新增獎品</button>
                        <button onclick="hideAddRewardForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">取消</button>
                    </div>
                </div>
                
                <!-- 編輯獎品表單 -->
                <div id="editRewardForm" class="hidden mb-6 p-4 bg-blue-50 rounded-xl">
                    <h3 class="font-semibold text-gray-800 mb-4">編輯獎品</h3>
                    <input type="hidden" id="editRewardId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">獎品名稱</label>
                            <input type="text" id="editRewardName" placeholder="請輸入獎品名稱" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">所需點數</label>
                            <input type="number" id="editRewardPoints" placeholder="請輸入所需點數" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">獎品數量</label>
                            <input type="number" id="editRewardQuantity" placeholder="請輸入獎品數量" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">更換獎品圖片</label>
                            <input type="file" id="editRewardImage" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">獎品描述</label>
                        <textarea id="editRewardDescription" placeholder="請輸入獎品描述" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div class="flex space-x-2 mt-4">
                        <button onclick="updateReward()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">更新獎品</button>
                        <button onclick="hideEditRewardForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">取消</button>
                    </div>
                </div>
                
                <!-- 兌換申請列表 -->
                <div id="exchangeRequestsSection" class="hidden mb-6">
                    <h3 class="font-semibold text-gray-800 mb-4">待處理兌換申請</h3>
                    <div id="exchangeRequestsList" class="space-y-3">
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-2">📋</div>
                            <p>尚無待處理申請</p>
                        </div>
                    </div>
                </div>
                
                <!-- 老師兌換記錄列表 -->
                <div id="teacherExchangeHistorySection" class="hidden mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-800">所有兌換記錄</h3>
                        <div class="flex items-center space-x-2">
                            <select id="exchangeStatusFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">所有狀態</option>
                                <option value="pending">審核中</option>
                                <option value="approved">已同意</option>
                                <option value="rejected">已拒絕</option>
                            </select>
                            <select id="exchangeStudentFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">所有學生</option>
                            </select>
                        </div>
                    </div>
                    <div id="teacherExchangeHistoryList" class="space-y-3">
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-2">📊</div>
                            <p>尚無兌換記錄</p>
                        </div>
                    </div>
                </div>
                
                <!-- 獎品列表 -->
                <div id="rewardManageList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="text-center text-gray-500 py-8 col-span-full">
                        <div class="text-4xl mb-2">🎁</div>
                        <p>尚無獎品</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 管理頁面內容 -->
        <div id="manageContent" class="hidden max-w-6xl mx-auto px-4 pb-8">
            <!-- 班級分組建立區 -->
            <div class="bg-white rounded-2xl p-6 card-shadow mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center">
                        🏫 班級分組建立
                    </h3>
                    <button onclick="showHomeTab()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                        ← 返回首頁
                    </button>
                </div>
                
                <div class="space-y-6">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">一次建立整班分組</h4>
                        <p class="text-sm text-gray-600 mb-3">使用表格方式輸入分組資料，每行一個小組，可輸入多個學生（空白欄位會自動忽略）</p>
                        
                        <!-- 動態表格 -->
                        <div class="border border-gray-300 rounded-lg mb-4">
                            <table class="w-full table-auto" id="groupTable">
                                <thead class="bg-gray-50">
                                    <tr id="tableHeader">
                                        <th class="px-2 py-2 text-left font-semibold text-gray-700">小組名稱</th>
                                        <th class="px-2 py-2 text-left font-semibold text-gray-700">學生1</th>
                                        <th class="px-2 py-2 text-left font-semibold text-gray-700">學生2</th>
                                        <th class="px-2 py-2 text-left font-semibold text-gray-700">學生3</th>
                                        <th class="px-2 py-2 text-left font-semibold text-gray-700">學生4</th>
                                        <th class="px-2 py-2 text-left font-semibold text-gray-700">學生5</th>
                                        <th class="px-2 py-2 text-center font-semibold text-gray-700">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="groupTableBody">
                                    <tr>
                                        <td class="px-2 py-2 border-t">
                                            <input type="text" placeholder="第一組" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                                        </td>
                                        <td class="px-2 py-2 border-t">
                                            <input type="text" placeholder="王小明" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                                        </td>
                                        <td class="px-2 py-2 border-t">
                                            <input type="text" placeholder="李小華" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                                        </td>
                                        <td class="px-2 py-2 border-t">
                                            <input type="text" placeholder="張小美" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                                        </td>
                                        <td class="px-2 py-2 border-t">
                                            <input type="text" placeholder="陳小強" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                                        </td>
                                        <td class="px-2 py-2 border-t">
                                            <input type="text" placeholder="林小雅" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                                        </td>
                                        <td class="px-2 py-2 border-t text-center">
                                            <button onclick="removeTableRow(this)" class="text-red-500 hover:text-red-700">🗑️</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="flex space-x-2 mb-4">
                            <button onclick="addTableRow()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                                ➕ 增加小組欄位
                            </button>
                            <button onclick="removeTableRow()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                                ➖ 減少小組欄位
                            </button>
                            <button onclick="addStudentColumn()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                                👥 增加學生欄位
                            </button>
                            <button onclick="removeStudentColumn()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-colors">
                                👤 減少學生欄位
                            </button>
                        </div>
                        
                        <button onclick="createClassGroupsFromTable()" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-2 rounded-lg transition-colors">
                            🚀 建立整班分組
                        </button>
                    </div>
                    

                    
                    <!-- 目前分組狀況 -->
                    <div class="border-t pt-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-semibold text-gray-700">📋 目前分組狀況</h4>
                            <button onclick="refreshGroupStatus()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                🔄 重新整理
                            </button>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">查看和調整目前的學生分組狀況</p>
                        
                        <div id="currentGroupStatus" class="space-y-4">
                            <div class="text-center text-gray-500 py-8">
                                <div class="text-4xl mb-2">👥</div>
                                <p>尚未建立分組</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全域變數
        let currentUser = null;
        let currentStudent = null;
        let groups = [];
        let students = [];
        let announcements = [];
        let classTitle = '班級管理系統';
        let loginAttempts = 0;
        let lockoutTime = 0;
        let teacherPassword = 'hres';
        let studentMessages = [];
        let currentMessageFilter = 'all';
        let currentRankingMode = 'individual';
        let scoreHistory = [];
        let currentHistoryFilter = 'all';
        let currentStudentFilter = '';
        let rewards = [];
        let exchangeRequests = [];
        let quizzes = [];
        let quizAnswers = [];
        let currentQuiz = null;
        let quizCountdown = null;


        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('classTitle').textContent = classTitle;
            document.getElementById('mainContent').classList.remove('hidden');
            checkLockout();
            loadData();
            
            // 每30秒檢查一次搶分活動狀態
            setInterval(() => {
                if (currentUser === 'student') {
                    checkQuizCountdown();
                }
            }, 30000);
        });

        // 檢查是否被鎖定
        function checkLockout() {
            const now = Date.now();
            if (lockoutTime > now) {
                const remainingTime = Math.ceil((lockoutTime - now) / 60000);
                document.getElementById('lockoutMessage').textContent = `登入失敗次數過多，請等待 ${remainingTime} 分鐘後再試`;
                document.getElementById('lockoutMessage').classList.remove('hidden');
                document.getElementById('teacherPassword').disabled = true;
                
                setTimeout(checkLockout, 60000);
            } else {
                document.getElementById('lockoutMessage').classList.add('hidden');
                document.getElementById('teacherPassword').disabled = false;
                if (lockoutTime > 0) {
                    loginAttempts = 0;
                    lockoutTime = 0;
                    google.script.run.setStorage('loginAttempts', '0');
                    google.script.run.setStorage('lockoutTime', '0');
                }
            }
        }

        // 登入相關函數
        function showStudentLogin() {
            document.getElementById('studentLoginModal').classList.remove('hidden');
        }

        function showTeacherLogin() {
            if (lockoutTime > Date.now()) {
                return;
            }
            document.getElementById('teacherLoginModal').classList.remove('hidden');
        }

        function closeLoginModal() {
            document.getElementById('studentLoginModal').classList.add('hidden');
            document.getElementById('teacherLoginModal').classList.add('hidden');
            document.getElementById('teacherPassword').value = '';
            document.getElementById('studentNameInput').value = '';
            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('studentLoginError').classList.add('hidden');
        }

        // 修改密碼相關函數
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('hidden');
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('hidden');
            document.getElementById('oldPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('changePasswordError').classList.add('hidden');
            document.getElementById('changePasswordSuccess').classList.add('hidden');
        }

        function changePassword() {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // 清除之前的訊息
            document.getElementById('changePasswordError').classList.add('hidden');
            document.getElementById('changePasswordSuccess').classList.add('hidden');

            // 驗證舊密碼
            if (oldPassword !== teacherPassword) {
                document.getElementById('changePasswordError').textContent = '舊密碼錯誤';
                document.getElementById('changePasswordError').classList.remove('hidden');
                return;
            }

            // 驗證新密碼
            if (!newPassword || newPassword.length < 3) {
                document.getElementById('changePasswordError').textContent = '新密碼至少需要3個字元';
                document.getElementById('changePasswordError').classList.remove('hidden');
                return;
            }

            // 驗證密碼確認
            if (newPassword !== confirmPassword) {
                document.getElementById('changePasswordError').textContent = '新密碼與確認密碼不一致';
                document.getElementById('changePasswordError').classList.remove('hidden');
                return;
            }

            // 更新密碼
            teacherPassword = newPassword;
            google.script.run.setStorage('teacherPassword', teacherPassword);

            // 顯示成功訊息
            document.getElementById('changePasswordSuccess').textContent = '密碼修改成功！';
            document.getElementById('changePasswordSuccess').classList.remove('hidden');

            // 2秒後關閉視窗
            setTimeout(() => {
                closeChangePasswordModal();
            }, 2000);
        }

        function loginAsStudent() {
            const studentName = document.getElementById('studentNameInput').value.trim();
            if (!studentName) {
                document.getElementById('studentLoginError').textContent = '請輸入您的姓名';
                document.getElementById('studentLoginError').classList.remove('hidden');
                return;
            }

            const student = students.find(s => s.name === studentName);
            if (!student) {
                document.getElementById('studentLoginError').textContent = '找不到此學生，請確認姓名是否正確';
                document.getElementById('studentLoginError').classList.remove('hidden');
                return;
            }

            currentUser = 'student';
            currentStudent = student;
            document.getElementById('userMode').textContent = `👨‍🎓 ${student.name}`;
            closeLoginModal();
            updateUI();
        }

        function loginAsTeacher() {
            if (lockoutTime > Date.now()) {
                return;
            }

            const password = document.getElementById('teacherPassword').value;
            if (password === teacherPassword) {
                currentUser = 'teacher';
                currentStudent = null;
                document.getElementById('userMode').textContent = '👩‍🏫 教師';
                loginAttempts = 0;
                google.script.run.setStorage('loginAttempts', '0');
                closeLoginModal();
                updateUI();
            } else {
                loginAttempts++;
                google.script.run.setStorage('loginAttempts', loginAttempts.toString());
                
                if (loginAttempts >= 3) {
                    lockoutTime = Date.now() + 10 * 60 * 1000; // 10分鐘
                    google.script.run.setStorage('lockoutTime', lockoutTime.toString());
                    checkLockout();
                } else {
                    document.getElementById('loginError').textContent = `密碼錯誤，還有 ${3 - loginAttempts} 次機會`;
                    document.getElementById('loginError').classList.remove('hidden');
                }
                document.getElementById('teacherPassword').value = '';
            }
        }

        function logout() {
            currentUser = null;
            currentStudent = null;
            updateUI();
        }

        // 更新UI權限
        function updateUI() {
            const isLoggedIn = currentUser !== null;
            const isTeacher = currentUser === 'teacher';
            const isStudent = currentUser === 'student';

            // 顯示/隱藏登入按鈕和用戶資訊
            document.getElementById('loginButtons').style.display = isLoggedIn ? 'none' : 'flex';
            document.getElementById('userInfo').style.display = isLoggedIn ? 'flex' : 'none';

            // 顯示/隱藏教師功能按鈕
            document.getElementById('manageBtn').style.display = isTeacher ? 'flex' : 'none';
            document.getElementById('messagesBtn').style.display = isTeacher ? 'flex' : 'none';
            document.getElementById('scoreHistoryBtn').style.display = isTeacher ? 'flex' : 'none';
            document.getElementById('rewardManageBtn').style.display = isTeacher ? 'flex' : 'none';
            document.getElementById('quizManageBtn').style.display = isTeacher ? 'flex' : 'none';
            document.getElementById('changePasswordBtn').style.display = isTeacher ? 'flex' : 'none';
            document.getElementById('addAnnouncementBtn').style.display = isTeacher ? 'block' : 'none';
            document.getElementById('quickScoreSection').style.display = isTeacher ? 'block' : 'none';
            
            // 顯示/隱藏學生功能按鈕
            document.getElementById('messageboardBtn').style.display = isStudent ? 'flex' : 'none';
            document.getElementById('scoreQueryBtn').style.display = isStudent ? 'flex' : 'none';
            document.getElementById('rewardExchangeBtn').style.display = isStudent ? 'flex' : 'none';
            document.getElementById('studentQuizBtn').style.display = isStudent ? 'flex' : 'none';

            // 如果不是教師且在管理頁面，切換到首頁
            if (!isTeacher && (!document.getElementById('manageContent').classList.contains('hidden') || 
                              !document.getElementById('messagesContent').classList.contains('hidden') ||
                              !document.getElementById('scoreHistoryContent').classList.contains('hidden') ||
                              !document.getElementById('rewardManageContent').classList.contains('hidden') ||
                              !document.getElementById('quizManageContent').classList.contains('hidden'))) {
                showTab('home');
            }

            // 更新標題編輯權限
            const titleElement = document.getElementById('classTitle');
            if (isTeacher) {
                titleElement.style.cursor = 'pointer';
                titleElement.title = '點擊編輯班級名稱';
            } else {
                titleElement.style.cursor = 'default';
                titleElement.title = '';
            }
        }

        // 分頁切換函數
        function showManageTab() {
            if (currentUser !== 'teacher') return;
            
            document.getElementById('homeContent').classList.add('hidden');
            document.getElementById('manageContent').classList.remove('hidden');
            document.getElementById('messagesContent').classList.add('hidden');
            document.getElementById('scoreHistoryContent').classList.add('hidden');
            document.getElementById('rewardManageContent').classList.add('hidden');
            document.getElementById('quizManageContent').classList.add('hidden');
            updateSelects();
            updateGroupStatus();
        }

        function showMessagesTab() {
            if (currentUser !== 'teacher') return;
            
            document.getElementById('homeContent').classList.add('hidden');
            document.getElementById('manageContent').classList.add('hidden');
            document.getElementById('messagesContent').classList.remove('hidden');
            document.getElementById('scoreHistoryContent').classList.add('hidden');
            document.getElementById('rewardManageContent').classList.add('hidden');
            document.getElementById('quizManageContent').classList.add('hidden');
            updateTeacherMessages();
        }

        function showScoreHistoryTab() {
            if (currentUser !== 'teacher') return;
            
            document.getElementById('homeContent').classList.add('hidden');
            document.getElementById('manageContent').classList.add('hidden');
            document.getElementById('messagesContent').classList.add('hidden');
            document.getElementById('scoreHistoryContent').classList.remove('hidden');
            document.getElementById('rewardManageContent').classList.add('hidden');
            document.getElementById('quizManageContent').classList.add('hidden');
            updateScoreHistoryFilter();
            updateScoreHistory();
        }

        function showRewardManageTab() {
            if (currentUser !== 'teacher') return;
            
            document.getElementById('homeContent').classList.add('hidden');
            document.getElementById('manageContent').classList.add('hidden');
            document.getElementById('messagesContent').classList.add('hidden');
            document.getElementById('scoreHistoryContent').classList.add('hidden');
            document.getElementById('rewardManageContent').classList.remove('hidden');
            document.getElementById('quizManageContent').classList.add('hidden');
            updateRewardManageList();
            updateExchangeRequests();
        }

        function showQuizManageTab() {
            if (currentUser !== 'teacher') return;
            
            document.getElementById('homeContent').classList.add('hidden');
            document.getElementById('manageContent').classList.add('hidden');
            document.getElementById('messagesContent').classList.add('hidden');
            document.getElementById('scoreHistoryContent').classList.add('hidden');
            document.getElementById('rewardManageContent').classList.add('hidden');
            document.getElementById('quizManageContent').classList.remove('hidden');
            updateCurrentQuizList();
        }

        function showHomeTab() {
            document.getElementById('homeContent').classList.remove('hidden');
            document.getElementById('manageContent').classList.add('hidden');
            document.getElementById('messagesContent').classList.add('hidden');
            document.getElementById('scoreHistoryContent').classList.add('hidden');
            document.getElementById('rewardManageContent').classList.add('hidden');
            document.getElementById('quizManageContent').classList.add('hidden');
        }

        // 分頁切換 (保留舊函數以防其他地方使用)
        function showTab(tab) {
            if (tab === 'home') {
                showHomeTab();
            } else if (tab === 'manage' && currentUser === 'teacher') {
                showManageTab();
            } else if (tab === 'messages' && currentUser === 'teacher') {
                showMessagesTab();
            }
        }

        // 編輯標題
        function editTitle() {
            if (currentUser !== 'teacher') return;
            
            const newTitle = prompt('請輸入新的班級名稱：', classTitle);
            if (newTitle && newTitle.trim()) {
                classTitle = newTitle.trim();
                document.getElementById('classTitle').textContent = classTitle;
                google.script.run.setStorage('classTitle', classTitle);
            }
        }

        // 載入資料
        function loadData() {
            const keys = ['groups','students','announcements','classTitle','loginAttempts','lockoutTime','teacherPassword','studentMessages','scoreHistory','rewards','exchangeRequests','quizzes','quizAnswers'];
            let loaded = 0;
            const expected = keys.length;
            // finalize function to run once all keys have been processed (success or failure)
            function finalizeLoad() {
                // ensure defaults
                groups = groups || [];
                students = students || [];
                announcements = announcements || [];
                studentMessages = studentMessages || [];
                scoreHistory = scoreHistory || [];
                rewards = rewards || [];
                exchangeRequests = exchangeRequests || [];
                quizzes = quizzes || [];
                quizAnswers = quizAnswers || [];
                classTitle = classTitle || '班級管理系統';
                document.getElementById('classTitle').textContent = classTitle;
                // update UI
                updateRankings();
                updateAnnouncements();
                updateSelects();
                updateGroupStatus();
                updateTeacherMessages();
                updateCurrentQuizList();
                updateRewardManageList();
                updateQuizHistory();
                updateTeacherExchangeHistoryFilters();
                updateTeacherExchangeHistory();
            }
            keys.forEach(function(key){
                google.script.run
                    .withSuccessHandler(function(value){
                        try {
                            if (value !== null && value !== undefined) {
                                switch(key) {
                                    case 'groups': groups = value; break;
                                    case 'students': students = value; break;
                                    case 'announcements': announcements = value; break;
                                    case 'classTitle': classTitle = value; break;
                                    case 'loginAttempts': loginAttempts = parseInt(value) || 0; break;
                                    case 'lockoutTime': lockoutTime = parseInt(value) || 0; break;
                                    case 'teacherPassword': teacherPassword = value || teacherPassword; break;
                                    case 'studentMessages': studentMessages = value; break;
                                    case 'scoreHistory': scoreHistory = value; break;
                                    case 'rewards': rewards = value; break;
                                    case 'exchangeRequests': exchangeRequests = value; break;
                                    case 'quizzes': quizzes = value; break;
                                    case 'quizAnswers': quizAnswers = value; break;
                                }
                            }
                        } catch(e) {
                            console.error('loadData parse error for', key, e);
                        }
                        loaded++;
                        if (loaded === expected) {
                            finalizeLoad();
                        }
                    })
                    .withFailureHandler(function(err){
                        console.error('loadData failed for', key, err);
                        loaded++;
                        if (loaded === expected) {
                            finalizeLoad();
                        }
                    })
                    .getStorage(key);
            });
        }

        // 表格操作函數
        function addTableRow() {
            const tbody = document.getElementById('groupTableBody');
            const header = document.getElementById('tableHeader');
            const rowCount = tbody.children.length;
            const columnCount = header.children.length - 2; // 扣除小組名稱和操作欄位
            
            const newRow = document.createElement('tr');
            let rowHTML = `
                <td class="px-2 py-2 border-t">
                    <input type="text" placeholder="第${rowCount + 1}組" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                </td>
            `;
            
            // 根據目前的欄位數量動態生成學生欄位
            for (let i = 1; i <= columnCount; i++) {
                rowHTML += `
                    <td class="px-2 py-2 border-t">
                        <input type="text" placeholder="學生姓名" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                    </td>
                `;
            }
            
            rowHTML += `
                <td class="px-2 py-2 border-t text-center">
                    <button onclick="removeTableRow(this)" class="text-red-500 hover:text-red-700">🗑️</button>
                </td>
            `;
            
            newRow.innerHTML = rowHTML;
            tbody.appendChild(newRow);
        }

        function addStudentColumn() {
            const header = document.getElementById('tableHeader');
            const tbody = document.getElementById('groupTableBody');
            const currentColumns = header.children.length - 2; // 扣除小組名稱和操作欄位
            const newColumnNumber = currentColumns + 1;
            
            // 在表頭新增學生欄位（在操作欄位之前）
            const newHeaderCell = document.createElement('th');
            newHeaderCell.className = 'px-2 py-2 text-left font-semibold text-gray-700';
            newHeaderCell.textContent = `學生${newColumnNumber}`;
            header.insertBefore(newHeaderCell, header.lastElementChild);
            
            // 為每一行新增學生欄位
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                const newCell = document.createElement('td');
                newCell.className = 'px-2 py-2 border-t';
                newCell.innerHTML = `
                    <input type="text" placeholder="學生姓名" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                `;
                row.insertBefore(newCell, row.lastElementChild);
            });
        }

        function removeStudentColumn() {
            const header = document.getElementById('tableHeader');
            const tbody = document.getElementById('groupTableBody');
            const currentColumns = header.children.length - 2; // 扣除小組名稱和操作欄位
            
            // 至少要保留一個學生欄位
            if (currentColumns <= 1) {
                alert('至少需要保留一個學生欄位');
                return;
            }
            
            // 移除表頭最後一個學生欄位（操作欄位的前一個）
            const lastStudentHeader = header.children[header.children.length - 2];
            header.removeChild(lastStudentHeader);
            
            // 移除每一行的最後一個學生欄位
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                const lastStudentCell = row.children[row.children.length - 2];
                row.removeChild(lastStudentCell);
            });
        }

        function removeTableRow(button) {
            // 如果是按鈕呼叫（沒有參數），移除最後一行
            if (!button) {
                const tbody = document.getElementById('groupTableBody');
                if (tbody.children.length > 1) {
                    tbody.removeChild(tbody.lastElementChild);
                } else {
                    alert('至少需要保留一行');
                }
                return;
            }
            
            // 如果是從行內刪除按鈕呼叫（有參數），移除該行
            const tbody = document.getElementById('groupTableBody');
            if (tbody.children.length > 1) {
                button.closest('tr').remove();
            } else {
                alert('至少需要保留一行');
            }
        }



        function createClassGroupsFromTable() {
            const tbody = document.getElementById('groupTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            let successCount = 0;
            let errorMessages = [];
            
            rows.forEach((row, index) => {
                const groupInput = row.querySelector('td:first-child input');
                const groupName = groupInput.value.trim();
                
                if (!groupName) {
                    return; // 跳過沒有小組名稱的行
                }
                
                // 收集該行所有學生姓名
                const studentInputs = row.querySelectorAll('td:not(:first-child):not(:last-child) input');
                const studentNames = [];
                
                studentInputs.forEach(input => {
                    const name = input.value.trim();
                    if (name) {
                        studentNames.push(name);
                    }
                });
                
                if (studentNames.length === 0) {
                    errorMessages.push(`第 ${index + 1} 行：小組 ${groupName} 沒有學生`);
                    return;
                }
                
                // 檢查是否有重複的學生
                for (let studentName of studentNames) {
                    if (students.find(s => s.name === studentName)) {
                        errorMessages.push(`第 ${index + 1} 行：學生 ${studentName} 已存在`);
                        return;
                    }
                }
                
                // 建立或找到小組
                let group = groups.find(g => g.name === groupName);
                if (!group) {
                    group = {
                        id: Date.now() + Math.random(),
                        name: groupName,
                        score: 0
                    };
                    groups.push(group);
                }
                
                // 建立該組所有學生
                studentNames.forEach(studentName => {
                    students.push({
                        id: Date.now() + Math.random() + Math.random(),
                        name: studentName,
                        groupId: group.id,
                        groupName: groupName,
                        score: 0
                    });
                    successCount++;
                });
            });
            
            if (errorMessages.length > 0) {
                alert('建立過程中發現錯誤：\n' + errorMessages.join('\n'));
            }
            
            if (successCount > 0) {
                google.script.run.setStorage('groups', groups);
                google.script.run.setStorage('students', students);
                
                // 清空表格
                const tbody = document.getElementById('groupTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td class="px-2 py-2 border-t">
                            <input type="text" placeholder="第一組" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                        </td>
                        <td class="px-2 py-2 border-t">
                            <input type="text" placeholder="王小明" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                        </td>
                        <td class="px-2 py-2 border-t">
                            <input type="text" placeholder="李小華" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                        </td>
                        <td class="px-2 py-2 border-t">
                            <input type="text" placeholder="張小美" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                        </td>
                        <td class="px-2 py-2 border-t">
                            <input type="text" placeholder="陳小強" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                        </td>
                        <td class="px-2 py-2 border-t">
                            <input type="text" placeholder="林小雅" class="w-full px-1 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">
                        </td>
                        <td class="px-2 py-2 border-t text-center">
                            <button onclick="removeTableRow(this)" class="text-red-500 hover:text-red-700">🗑️</button>
                        </td>
                    </tr>
                `;
                
                updateRankings();
                updateSelects();
                updateGroupStatus();
                alert(`成功建立 ${successCount} 位學生！`);
            }
        }

        // 更新分組狀況顯示
        function updateGroupStatus() {
            const container = document.getElementById('currentGroupStatus');
            
            if (groups.length === 0 || students.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">👥</div>
                        <p>尚未建立分組</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = groups.map(group => {
                // compare groupId as strings to avoid number/string mismatch
                const groupStudents = students.filter(s => String(s.groupId) === String(group.id));
                
                return `
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-3">
                                <h5 class="font-semibold text-gray-800 text-lg">${group.name}</h5>
                                <span class="text-sm text-gray-500">(${groupStudents.length} 人)</span>
                                <span class="text-sm font-medium text-blue-600">${group.score} 分</span>
                            </div>
                            <button onclick="deleteGroup('${group.id}')" class="text-red-500 hover:text-red-700 text-xl" title="刪除小組">🗑️</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                            ${groupStudents.map(student => `
                                <div class="bg-white rounded-lg p-3 border border-gray-200 flex items-center justify-between">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-gray-800">${student.name}</span>
                                        <span class="text-xs text-gray-500">${student.score} 分</span>
                                    </div>
                                    <button onclick="deleteStudent('${student.id}')" class="text-red-500 hover:text-red-700 text-sm" title="刪除學生">🗑️</button>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- 新增學生到此組 -->
                        <div class="mt-3 pt-3 border-t border-gray-300">
                            <div class="flex space-x-2">
                                <input type="text" id="newStudent-${group.id}" placeholder="新增學生到 ${group.name}" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button onclick="addStudentToGroup('${group.id}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm transition-colors">
                                    ➕ 新增
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 重新整理分組狀況
        function refreshGroupStatus() {
            updateGroupStatus();
        }

        // 編輯小組名稱
        function editGroupName(groupId) {
            console.log('編輯小組名稱，ID:', groupId);
            const group = groups.find(g => g.id == groupId);
            if (!group) {
                console.log('找不到小組');
                return;
            }

            const newName = prompt('請輸入新的小組名稱：', group.name);
            if (newName && newName.trim() && newName.trim() !== group.name) {
                const trimmedName = newName.trim();
                
                // 檢查是否有重複的小組名稱
                if (groups.some(g => g.id != groupId && g.name === trimmedName)) {
                    alert('小組名稱已存在，請使用其他名稱');
                    return;
                }

                group.name = trimmedName;
                
                // 同時更新該組所有學生的 groupName
                students.forEach(student => {
                    if (student.groupId == groupId) {
                        student.groupName = trimmedName;
                    }
                });

                google.script.run.setStorage('groups', groups);
                google.script.run.setStorage('students', students);
                
                updateGroupStatus();
                updateRankings();
                updateSelects();
                alert('小組名稱已更新！');
            }
        }

        // 刪除小組
        function deleteGroup(groupId) {
            console.log('刪除小組，ID:', groupId);
            const group = groups.find(g => g.id.toString() === groupId.toString());
            if (!group) {
                console.log('找不到小組');
                return;
            }

            const groupStudents = students.filter(s => s.groupId.toString() === groupId.toString());
            
            if (groupStudents.length > 0) {
                if (!confirm(`確定要刪除小組「${group.name}」嗎？\n這將同時刪除該組的 ${groupStudents.length} 位學生。`)) {
                    return;
                }
            } else {
                if (!confirm(`確定要刪除小組「${group.name}」嗎？`)) {
                    return;
                }
            }

            // 刪除小組和該組所有學生
            groups = groups.filter(g => g.id.toString() !== groupId.toString());
            try { google.script.run.deleteStorage('groups', groupId); } catch(e) { console.error(e); }
            students = students.filter(s => s.groupId.toString() !== groupId.toString());
            try { groupStudents.forEach(function(s){ google.script.run.deleteStorage('students', s.id); }); } catch(e) { console.error(e); }

            google.script.run.setStorage('groups', groups);
            google.script.run.setStorage('students', students);
            
            updateGroupStatus();
            updateRankings();
            updateSelects();
            alert('小組已刪除！');
        }

        // 編輯學生姓名
        function editStudentName(studentId) {
            console.log('編輯學生姓名，ID:', studentId);
            const student = students.find(s => s.id == studentId);
            if (!student) {
                console.log('找不到學生');
                return;
            }

            const newName = prompt('請輸入新的學生姓名：', student.name);
            if (newName && newName.trim() && newName.trim() !== student.name) {
                const trimmedName = newName.trim();
                
                // 檢查是否有重複的學生姓名
                if (students.some(s => s.id != studentId && s.name === trimmedName)) {
                    alert('學生姓名已存在，請使用其他姓名');
                    return;
                }

                student.name = trimmedName;
                google.script.run.setStorage('students', students);
                
                updateGroupStatus();
                updateRankings();
                updateSelects();
                alert('學生姓名已更新！');
            }
        }

        // 移動學生到其他組
        function moveStudent(studentId) {
            console.log('移動學生，ID:', studentId);
            const student = students.find(s => s.id == studentId);
            if (!student) {
                console.log('找不到學生');
                return;
            }

            // 建立其他小組的選項
            const otherGroups = groups.filter(g => g.id != student.groupId);
            if (otherGroups.length === 0) {
                alert('沒有其他小組可以移動');
                return;
            }

            let options = '請選擇要移動到的小組：\n';
            otherGroups.forEach((group, index) => {
                options += `${index + 1}. ${group.name}\n`;
            });

            const choice = prompt(options + '\n請輸入數字選擇：');
            const choiceIndex = parseInt(choice) - 1;

            if (choiceIndex >= 0 && choiceIndex < otherGroups.length) {
                const targetGroup = otherGroups[choiceIndex];
                
                student.groupId = targetGroup.id;
                student.groupName = targetGroup.name;
                
                google.script.run.setStorage('students', students);
                
                updateGroupStatus();
                updateRankings();
                updateSelects();
                
                alert(`${student.name} 已移動到 ${targetGroup.name}`);
            } else {
                alert('選擇無效，請重新操作');
            }
        }

        // 刪除學生
        function deleteStudent(studentId) {
            console.log('刪除學生，ID:', studentId);
            const student = students.find(s => s.id.toString() === studentId.toString());
            if (!student) {
                console.log('找不到學生');
                return;
            }

            if (confirm(`確定要刪除學生「${student.name}」嗎？`)) {
                students = students.filter(s => s.id.toString() !== studentId.toString());
                try { google.script.run.deleteStorage('students', studentId); } catch(e) { console.error(e); }
                google.script.run.setStorage('students', students);
                
                updateGroupStatus();
                updateRankings();
                updateSelects();
                alert('學生已刪除！');
            }
        }

        // 新增學生到指定小組
        function addStudentToGroup(groupId) {
            const input = document.getElementById(`newStudent-${groupId}`);
            const studentName = input.value.trim();
            
            if (!studentName) {
                alert('請輸入學生姓名');
                return;
            }

            // 檢查是否有重複的學生姓名
            if (students.some(s => s.name === studentName)) {
                alert('學生姓名已存在');
                input.value = '';
                return;
            }

            const group = groups.find(g => g.id.toString() === groupId.toString());
            if (!group) return;

            const newStudent = {
                id: Date.now() + Math.random(),
                name: studentName,
                groupId: group.id,
                groupName: group.name,
                score: 0
            };

            students.push(newStudent);
            google.script.run.setStorage('students', students);
            
            input.value = '';
            updateGroupStatus();
            updateRankings();
            updateSelects();
        }

        // 清空所有資料
        function clearAllData() {
            if (confirm('⚠️ 確定要完全重置班級嗎？\n\n此操作將永久刪除：\n• 所有學生資料和分數\n• 所有小組資料和分數\n• 所有課程公告和留言\n• 所有學生留言記錄\n• 班級名稱將重置為預設值\n\n⚠️ 此操作無法復原！請確認後再繼續。')) {
                
                // 如果有登入的學生，先登出
                if (currentUser === 'student') {
                    logout();
                }
                
                // 完全清空所有資料
                groups = [];
                students = [];
                announcements = [];
                studentMessages = [];
                
                // 重置班級名稱為預設值
                classTitle = '班級管理系統';
                document.getElementById('classTitle').textContent = classTitle;
                
                // 清空本地存儲中的所有相關資料
                google.script.run.setStorage('groups', []);
                google.script.run.setStorage('students', []);
                google.script.run.setStorage('announcements', []);
                google.script.run.setStorage('studentMessages', []);
                google.script.run.setStorage('classTitle', classTitle);
                
                // 重置所有全域變數
                currentMessageFilter = 'all';
                currentRankingMode = 'group';
                
                // 更新所有UI顯示
                updateRankings();
                updateSelects();
                updateGroupStatus();
                updateAnnouncements();
                updateTeacherMessages();
                
                // 重置排行榜模式按鈕
                switchRankingMode('group');
                
                // 重置留言篩選按鈕
                filterMessages('all');
                
                // 確保回到首頁
                showHomeTab();
                
                alert('✅ 班級資料已完全清空！\n系統已重置為初始狀態。');
            }
        }

        // 刪除單一小組
        function deleteGroup(groupId) {
            const group = groups.find(g => g.id == groupId);
            if (!group) return;

            const groupStudents = students.filter(s => s.groupId == groupId);
            
            if (groupStudents.length > 0) {
                if (!confirm(`確定要刪除小組「${group.name}」嗎？\n這將同時刪除該組的 ${groupStudents.length} 位學生。`)) {
                    return;
                }
            } else {
                if (!confirm(`確定要刪除小組「${group.name}」嗎？`)) {
                    return;
                }
            }

            // 刪除小組和該組所有學生
            groups = groups.filter(g => g.id != groupId);
            students = students.filter(s => s.groupId != groupId);

            google.script.run.setStorage('groups', groups);
            google.script.run.setStorage('students', students);
            
            updateGroupStatus();
            updateRankings();
            updateSelects();
            alert('小組已刪除！');
        }

        // 更新選擇器
        function updateSelects() {
            const groupSelect = document.getElementById('groupSelect');
            const studentSelect = document.getElementById('studentSelect');

            groupSelect.innerHTML = '<option value="">選擇小組</option>';
            groups.forEach(group => {
                groupSelect.innerHTML += `<option value="${group.id}">${group.name}</option>`;
            });

            studentSelect.innerHTML = '<option value="">選擇學生</option>';
            students.forEach(student => {
                studentSelect.innerHTML += `<option value="${student.id}">${student.name} (${student.groupName})</option>`;
            });
        }

        // 小組加分
        function addGroupScore() {
            const groupId = document.getElementById('groupSelect').value;
            const score = parseInt(document.getElementById('groupScore').value);
            
            if (!groupId || !score) return;

            modifyGroupScore(groupId, score);
        }

        // 小組扣分
        function subtractGroupScore() {
            const groupId = document.getElementById('groupSelect').value;
            const score = parseInt(document.getElementById('groupScore').value);
            
            if (!groupId || !score) return;

            modifyGroupScore(groupId, -score);
        }

        // 修改小組分數
        function modifyGroupScore(groupId, scoreChange) {
            const group = groups.find(g => g.id == groupId);
            if (!group) return;

            group.score += scoreChange;
            
            // 記錄分數變化
            const historyRecord = {
                id: Date.now(),
                type: 'group',
                targetId: groupId,
                targetName: group.name,
                scoreChange: scoreChange,
                reason: scoreChange > 0 ? '小組加分' : '小組扣分',
                date: new Date().toLocaleString('zh-TW'),
                affectedStudents: []
            };
            
            // 同時更新該組所有學生分數
            students.forEach(student => {
                if (student.groupId == groupId) {
                    student.score += scoreChange;
                    historyRecord.affectedStudents.push({
                        id: student.id,
                        name: student.name,
                        scoreChange: scoreChange
                    });
                }
            });

            scoreHistory.unshift(historyRecord);
            google.script.run.setStorage('groups', groups);
            google.script.run.setStorage('students', students);
            google.script.run.setStorage('scoreHistory', scoreHistory);
            
            document.getElementById('groupScore').value = '';
            updateRankings();
        }

        // 個人加分
        function addStudentScore() {
            const studentId = document.getElementById('studentSelect').value;
            const score = parseInt(document.getElementById('studentScore').value);
            
            if (!studentId || !score) return;

            modifyStudentScore(studentId, score);
        }

        // 個人扣分
        function subtractStudentScore() {
            const studentId = document.getElementById('studentSelect').value;
            const score = parseInt(document.getElementById('studentScore').value);
            
            if (!studentId || !score) return;

            modifyStudentScore(studentId, -score);
        }

        // 修改個人分數
        function modifyStudentScore(studentId, scoreChange) {
            const student = students.find(s => s.id == studentId);
            if (!student) return;

            student.score += scoreChange;
            
            // 記錄分數變化
            const historyRecord = {
                id: Date.now(),
                type: 'individual',
                targetId: studentId,
                targetName: student.name,
                groupName: student.groupName,
                scoreChange: scoreChange,
                reason: scoreChange > 0 ? '個人加分' : '個人扣分',
                date: new Date().toLocaleString('zh-TW'),
                affectedStudents: [{
                    id: student.id,
                    name: student.name,
                    scoreChange: scoreChange
                }]
            };

            scoreHistory.unshift(historyRecord);
            google.script.run.setStorage('students', students);
            google.script.run.setStorage('scoreHistory', scoreHistory);
            
            document.getElementById('studentScore').value = '';
            updateRankings();
        }

        // 排行榜模式切換
        function switchRankingMode(mode) {
            currentRankingMode = mode;
            
            // 更新按鈕樣式
            const groupBtn = document.getElementById('groupRankBtn');
            const individualBtn = document.getElementById('individualRankBtn');
            
            // 重置所有按鈕樣式
            groupBtn.className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors';
            individualBtn.className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors';
            
            // 設置選中的按鈕樣式
            if (mode === 'group') {
                groupBtn.className = 'px-4 py-2 rounded-lg bg-blue-500 text-white transition-colors';
            } else {
                individualBtn.className = 'px-4 py-2 rounded-lg bg-blue-500 text-white transition-colors';
            }
            
            // 先重置頒獎台，然後更新排行榜
            resetPodium();
            setTimeout(() => {
                updateRankings();
            }, 100);
        }

        // 更新排行榜
        function updateRankings() {
            if (currentRankingMode === 'group') {
                updateGroupRankings();
            } else {
                updateIndividualRankings();
            }
        }

        // 更新小組排行榜
        function updateGroupRankings() {
            if (groups.length === 0) {
                resetPodium();
                return;
            }

            const sortedGroups = [...groups].sort((a, b) => b.score - a.score);
            updatePodiumDisplay(sortedGroups, 'group');
        }

        // 更新個人排行榜
        function updateIndividualRankings() {
            if (students.length === 0) {
                resetPodium();
                return;
            }

            const sortedStudents = [...students].sort((a, b) => b.score - a.score);
            updatePodiumDisplay(sortedStudents, 'individual');
        }

        // 重置頒獎台
        function resetPodium() {
            // 隱藏所有頒獎台元素
            for (let i = 1; i <= 3; i++) {
                const infoElement = document.getElementById(`rank${i}Info`);
                const podiumElement = document.getElementById(`podium${i}`);
                
                if (infoElement) {
                    infoElement.style.opacity = '0';
                    infoElement.style.transform = 'translateY(4px)';
                }
                
                if (podiumElement) {
                    podiumElement.style.transform = 'scaleY(0)';
                    podiumElement.style.height = '0px';
                }
            }
            
            // 清空第四第五名
            const otherRankings = document.getElementById('otherRankings');
            if (otherRankings) {
                otherRankings.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">📊</div>
                        <p id="emptyMessage">${currentRankingMode === 'group' ? '尚未建立小組' : '尚未建立學生'}</p>
                    </div>
                `;
            }
        }

        // 更新頒獎台顯示
        function updatePodiumDisplay(sortedData, type) {
            // 先重置
            resetPodium();
            
            if (sortedData.length === 0) return;
            
            // 只顯示前三名在頒獎台上
            const topThree = sortedData.slice(0, 3);
            
            // 計算高度比例 - 基於分數差距
            const maxScore = topThree.length > 0 ? topThree[0].score : 0;
            const minScore = topThree.length > 0 ? Math.min(...topThree.map(item => item.score)) : 0;
            const scoreRange = maxScore - minScore;
            
            // 設定高度範圍
            const baseHeight = 80;  // 基礎高度
            const maxExtraHeight = 60; // 最大額外高度
            
            setTimeout(() => {
                // 同時開始所有頒獎台動畫
                topThree.forEach((item, index) => {
                    const rank = index + 1;
                    
                    // 計算相對高度
                    let height = baseHeight;
                    if (scoreRange > 0) {
                        const scoreRatio = (item.score - minScore) / scoreRange;
                        height = baseHeight + (maxExtraHeight * scoreRatio);
                    }
                    
                    // 第一名額外加高
                    if (rank === 1) {
                        height += 20;
                    }
                    
                    // 更新資訊
                    const infoElement = document.getElementById(`rank${rank}Info`);
                    const nameDiv = infoElement.children[1];
                    const detailDiv = infoElement.children[2];
                    const scoreDiv = infoElement.children[3];
                    
                    if (type === 'group') {
                        nameDiv.textContent = item.name;
                        detailDiv.textContent = ''; // 小組排行不顯示人數
                    } else {
                        nameDiv.textContent = item.name;
                        detailDiv.textContent = ''; // 個人排行不顯示組名
                    }
                    scoreDiv.textContent = `${item.score} 分`;
                    
                    // 設置最終高度
                    const podiumElement = document.getElementById(`podium${rank}`);
                    podiumElement.style.height = `${height}px`;
                    
                    // 同時觸發所有動畫（無延遲差）
                    setTimeout(() => {
                        podiumElement.style.transform = 'scaleY(1)';
                        infoElement.style.opacity = '1';
                        infoElement.style.transform = 'translateY(0)';
                    }, 300); // 統一延遲
                });
            }, 200);
            
            // 更新第四第五名（如果有的話）
            setTimeout(() => {
                updateOtherRankings(sortedData, type);
            }, 1500);
        }

        // 更新第四第五名排行
        function updateOtherRankings(sortedData, type) {
            const container = document.getElementById('otherRankings');
            const otherRanks = sortedData.slice(3, 5); // 只取第四第五名
            
            if (otherRanks.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = otherRanks.map((item, index) => {
                const rank = index + 4; // 第四名開始
                
                return `
                    <div class="rank-animation bg-gray-50 rounded-xl p-4 flex items-center justify-between opacity-0 transform translate-y-4" style="animation: slideInUp 0.6s ease-out ${index * 0.2}s forwards;">
                        <div class="flex items-center space-x-4">
                            <div class="text-2xl font-bold text-gray-600">${rank}</div>
                            <div>
                                <div class="font-semibold text-gray-800">${item.name}</div>
                            </div>
                        </div>
                        <div class="text-2xl font-bold text-gray-800">${item.score} 分</div>
                    </div>
                `;
            }).join('');
        }

        // 公告相關函數
        function showAnnouncementForm() {
            document.getElementById('announcementForm').classList.remove('hidden');
        }

        function hideAnnouncementForm() {
            document.getElementById('announcementForm').classList.add('hidden');
            document.getElementById('announcementTitle').value = '';
            document.getElementById('announcementContent').value = '';
            document.getElementById('announcementLink').value = '';
        }

        function addAnnouncement() {
            const title = document.getElementById('announcementTitle').value.trim();
            const content = document.getElementById('announcementContent').value.trim();
            const link = document.getElementById('announcementLink').value.trim();

            if (!title || !content) return;

            const announcement = {
                id: Date.now(),
                title: title,
                content: content,
                link: link,
                date: new Date().toLocaleDateString('zh-TW'),
                comments: []
            };

            announcements.unshift(announcement);
            google.script.run.setStorage('announcements', announcements);
            
            hideAnnouncementForm();
            updateAnnouncements();
        }

        function updateAnnouncements() {
            const container = document.getElementById('announcements');
            
            if (announcements.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">📝</div>
                        <p>尚無課程公告</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = announcements.map(announcement => `
                <div class="border border-gray-200 rounded-xl p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">${announcement.title}</h3>
                            <p class="text-sm text-gray-500">${announcement.date}</p>
                        </div>
                        ${currentUser === 'teacher' ? `<button onclick="deleteAnnouncement('${announcement.id}')" class="text-red-500 hover:text-red-700">🗑️</button>` : ''}
                    </div>
                    <p class="text-gray-700 mb-4 whitespace-pre-wrap">${announcement.content}</p>
                    ${announcement.link ? `<a href="${announcement.link}" target="_blank" class="text-blue-500 hover:text-blue-700 underline">📎 相關連結</a>` : ''}
                    
                    <!-- 留言區 -->
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <h4 class="font-semibold text-gray-700 mb-3">💬 留言區</h4>
                        <div class="space-y-3 mb-4">
                            ${announcement.comments.map(comment => `
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="flex justify-between items-start">
                                        <div class="font-medium text-gray-800">${comment.author}</div>
                                        <div class="text-xs text-gray-500">${comment.date}</div>
                                    </div>
                                    <p class="text-gray-700 mt-1">${comment.content}</p>
                                </div>
                            `).join('')}
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" id="comment-${announcement.id}" placeholder="輸入留言..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button onclick="addComment('${announcement.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">發送</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function addComment(announcementId) {
            const input = document.getElementById(`comment-${announcementId}`);
            const content = input.value.trim();
            
            if (!content) return;

            // 用字串比較以避免類型不一致
            const announcement = announcements.find(a => String(a.id) === String(announcementId));
            if (!announcement) return;

            const comment = {
                id: Date.now(),
                author: currentUser === 'teacher' ? '老師' : '學生',
                content: content,
                date: new Date().toLocaleString('zh-TW')
            };

            announcement.comments.push(comment);
            google.script.run.setStorage('announcements', announcements);
            
            input.value = '';
            updateAnnouncements();
        }

        function deleteAnnouncement(announcementId) {
            if (currentUser !== 'teacher') return;
            
            if (confirm('確定要刪除這個公告嗎？')) {
                // 用字串比較避免類型不一致
                announcements = announcements.filter(a => String(a.id) !== String(announcementId));
                google.script.run.setStorage('announcements', announcements);
                updateAnnouncements();
            }
        }

        // 學生分數查詢功能
        function showScoreQuery() {
            if (currentUser !== 'student') return;
            
            document.getElementById('scoreQueryModal').classList.remove('hidden');
            document.getElementById('scoreQueryResult').classList.add('hidden');
            document.getElementById('scoreQueryError').classList.add('hidden');
            document.getElementById('scoreQueryName').value = '';
            
            // 如果已經登入，自動填入姓名
            if (currentStudent) {
                document.getElementById('scoreQueryName').value = currentStudent.name;
            }
        }

        function closeScoreQueryModal() {
            document.getElementById('scoreQueryModal').classList.add('hidden');
            document.getElementById('scoreQueryResult').classList.add('hidden');
            document.getElementById('scoreQueryError').classList.add('hidden');
            document.getElementById('scoreQueryName').value = '';
        }

        function queryScore() {
            const studentName = document.getElementById('scoreQueryName').value.trim();
            
            // 清除之前的結果和錯誤訊息
            document.getElementById('scoreQueryResult').classList.add('hidden');
            document.getElementById('scoreQueryError').classList.add('hidden');
            
            if (!studentName) {
                document.getElementById('scoreQueryError').textContent = '請輸入學生姓名';
                document.getElementById('scoreQueryError').classList.remove('hidden');
                return;
            }

            // 查找學生
            const student = students.find(s => s.name === studentName);
            if (!student) {
                document.getElementById('scoreQueryError').textContent = '找不到此學生，請確認姓名是否正確';
                document.getElementById('scoreQueryError').classList.remove('hidden');
                return;
            }

            // 計算個人排名
            const sortedStudents = [...students].sort((a, b) => b.score - a.score);
            // use string comparison for id to avoid type mismatch
            const studentRank = sortedStudents.findIndex(s => String(s.id) === String(student.id)) + 1;

            // 獲取小組資訊
            const group = groups.find(g => String(g.id) === String(student.groupId));
            const groupScore = group ? group.score : 0;

            // 顯示結果
            document.getElementById('studentNameDisplay').textContent = student.name;
            document.getElementById('studentGroupDisplay').textContent = student.groupName;
            document.getElementById('studentScoreDisplay').textContent = student.score;
            document.getElementById('studentRankDisplay').textContent = `第 ${studentRank} 名`;
            document.getElementById('groupScoreDisplay').textContent = `${groupScore} 分`;

            // 根據排名設置不同的頭像
            const avatarElement = document.getElementById('studentAvatar');
            if (studentRank === 1) {
                avatarElement.textContent = '🥇';
            } else if (studentRank === 2) {
                avatarElement.textContent = '🥈';
            } else if (studentRank === 3) {
                avatarElement.textContent = '🥉';
            } else {
                avatarElement.textContent = '👨‍🎓';
            }

            // 顯示結果區域
            document.getElementById('scoreQueryResult').classList.remove('hidden');
            
            // 更新學生分數變化記錄
            updateStudentScoreHistory(student.id);
        }

        // 學生留言板功能
        function showMessageboard() {
            if (currentUser !== 'student') return;
            
            document.getElementById('messageboardModal').classList.remove('hidden');
            document.getElementById('studentMessageForm').classList.remove('hidden');
            updateStudentMessages();
        }

        function closeMessageboardModal() {
            document.getElementById('messageboardModal').classList.add('hidden');
            clearMessageForm();
        }

        function clearMessageForm() {
            document.getElementById('messageContent').value = '';
            document.querySelector('input[name="messageVisibility"][value="private"]').checked = true;
        }

        function postMessage() {
            if (currentUser !== 'student' || !currentStudent) return;
            
            const content = document.getElementById('messageContent').value.trim();
            const visibility = document.querySelector('input[name="messageVisibility"]:checked').value;
            
            if (!content) {
                alert('請輸入留言內容');
                return;
            }

            const message = {
                id: Date.now(),
                studentId: currentStudent.id,
                studentName: currentStudent.name,
                groupName: currentStudent.groupName,
                content: content,
                visibility: visibility,
                date: new Date().toLocaleString('zh-TW'),
                replies: []
            };

            studentMessages.unshift(message);
            google.script.run.setStorage('studentMessages', studentMessages);
            
            clearMessageForm();
            updateStudentMessages();
            alert('留言發布成功！');
        }

        function updateStudentMessages() {
            const container = document.getElementById('messagesList');
            
            // 學生只能看到自己的留言和公開留言
            let visibleMessages = [];
            if (currentUser === 'student' && currentStudent) {
                // Compare studentId as strings to handle number/string mismatches
                visibleMessages = studentMessages.filter(msg => 
                    String(msg.studentId) === String(currentStudent.id) || msg.visibility === 'public'
                );
            } else if (currentUser === 'teacher') {
                visibleMessages = studentMessages;
            }
            
            if (visibleMessages.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">📝</div>
                        <p>尚無留言</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = visibleMessages.map(message => {
                // Determine if this is the current student's own message (compare ids as strings)
                const isOwnMessage = currentUser === 'student' && currentStudent && String(message.studentId) === String(currentStudent.id);
                const visibilityIcon = message.visibility === 'public' ? '🌍' : '🔒';
                const visibilityText = message.visibility === 'public' ? '公開' : '僅老師可見';
                
                return `
                    <div class="border border-gray-200 rounded-xl p-4 ${isOwnMessage ? 'bg-blue-50' : 'bg-gray-50'}">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center space-x-3">
                                <div class="font-semibold text-gray-800">${message.studentName}</div>
                                <div class="text-sm text-gray-500">${message.groupName}</div>
                                <div class="flex items-center space-x-1 text-xs text-gray-500">
                                    <span>${visibilityIcon}</span>
                                    <span>${visibilityText}</span>
                                </div>
                            </div>
                            <div class="text-sm text-gray-500">${message.date}</div>
                        </div>
                        <p class="text-gray-700 mb-3 whitespace-pre-wrap">${message.content}</p>
                        
                        <!-- 老師回覆區 -->
                        ${message.replies.length > 0 ? `
                            <div class="mt-4 pt-3 border-t border-gray-300">
                                <h5 class="font-semibold text-gray-700 mb-2">老師回覆：</h5>
                                ${message.replies.map(reply => `
                                    <div class="bg-green-50 rounded-lg p-3 mb-2">
                                        <div class="flex justify-between items-start mb-1">
                                            <div class="font-medium text-green-800">👩‍🏫 老師</div>
                                            <div class="text-xs text-gray-500">${reply.date}</div>
                                        </div>
                                        <p class="text-gray-700">${reply.content}</p>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // 教師留言管理功能
        function updateTeacherMessages() {
            const container = document.getElementById('teacherMessagesList');
            
            let filteredMessages = studentMessages;
            if (currentMessageFilter === 'public') {
                filteredMessages = studentMessages.filter(msg => msg.visibility === 'public');
            } else if (currentMessageFilter === 'private') {
                filteredMessages = studentMessages.filter(msg => msg.visibility === 'private');
            }
            
            if (filteredMessages.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">📝</div>
                        <p>尚無學生留言</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredMessages.map(message => {
                const visibilityIcon = message.visibility === 'public' ? '🌍' : '🔒';
                const visibilityText = message.visibility === 'public' ? '公開' : '私人';
                
                return `
                    <div class="border border-gray-200 rounded-xl p-4">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center space-x-3">
                                <div class="font-semibold text-gray-800">${message.studentName}</div>
                                <div class="text-sm text-gray-500">${message.groupName}</div>
                                <div class="flex items-center space-x-1 text-xs px-2 py-1 rounded-full ${message.visibility === 'public' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">
                                    <span>${visibilityIcon}</span>
                                    <span>${visibilityText}</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="text-sm text-gray-500">${message.date}</div>
                                <button onclick="deleteMessage('${message.id}')" class="text-red-500 hover:text-red-700 text-sm">🗑️</button>
                            </div>
                        </div>
                        <p class="text-gray-700 mb-3 whitespace-pre-wrap">${message.content}</p>
                        
                        <!-- 老師回覆區 -->
                        ${message.replies.length > 0 ? `
                            <div class="mt-4 pt-3 border-t border-gray-300">
                                <h5 class="font-semibold text-gray-700 mb-2">我的回覆：</h5>
                                ${message.replies.map(reply => `
                                    <div class="bg-green-50 rounded-lg p-3 mb-2">
                                        <div class="flex justify-between items-start mb-1">
                                            <div class="font-medium text-green-800">👩‍🏫 老師</div>
                                            <div class="text-xs text-gray-500">${reply.date}</div>
                                        </div>
                                        <p class="text-gray-700">${reply.content}</p>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <!-- 回覆表單 -->
                        <div class="mt-4 pt-3 border-t border-gray-300">
                            <div class="flex space-x-2">
                                <input type="text" id="reply-${message.id}" placeholder="回覆學生..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                <button onclick="replyToMessage('${message.id}')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">回覆</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterMessages(filter) {
            currentMessageFilter = filter;
            
            // 更新按鈕樣式
            document.getElementById('filterAll').className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors';
            document.getElementById('filterPublic').className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors';
            document.getElementById('filterPrivate').className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors';
            
            if (filter === 'all') {
                document.getElementById('filterAll').className = 'px-4 py-2 rounded-lg bg-blue-500 text-white transition-colors';
            } else if (filter === 'public') {
                document.getElementById('filterPublic').className = 'px-4 py-2 rounded-lg bg-blue-500 text-white transition-colors';
            } else if (filter === 'private') {
                document.getElementById('filterPrivate').className = 'px-4 py-2 rounded-lg bg-blue-500 text-white transition-colors';
            }
            
            updateTeacherMessages();
        }

        function replyToMessage(messageId) {
            const input = document.getElementById(`reply-${messageId}`);
            const content = input.value.trim();
            
            if (!content) return;

            // 以字串比較 ID 以避免類型錯誤
            const message = studentMessages.find(msg => String(msg.id) === String(messageId));
            if (!message) return;

            const reply = {
                id: Date.now(),
                content: content,
                date: new Date().toLocaleString('zh-TW')
            };

            message.replies.push(reply);
            google.script.run.setStorage('studentMessages', studentMessages);
            
            input.value = '';
            updateTeacherMessages();
        }

        function deleteMessage(messageId) {
            if (currentUser !== 'teacher') return;
            
            if (confirm('確定要刪除這則留言嗎？')) {
                // 用字串比較避免類型不一致
                studentMessages = studentMessages.filter(msg => String(msg.id) !== String(messageId));
                google.script.run.setStorage('studentMessages', studentMessages);
                updateTeacherMessages();
            }
        }

        // 分數記錄管理功能
        function updateScoreHistoryFilter() {
            const studentFilter = document.getElementById('studentHistoryFilter');
            studentFilter.innerHTML = '<option value="">選擇學生篩選</option>';
            
            students.forEach(student => {
                studentFilter.innerHTML += `<option value="${student.id}">${student.name} (${student.groupName})</option>`;
            });
            
            // 添加事件監聽器
            studentFilter.addEventListener('change', function() {
                currentStudentFilter = this.value;
                updateScoreHistory();
            });
        }

        function filterScoreHistory(filter) {
            currentHistoryFilter = filter;
            
            // 更新按鈕樣式
            document.getElementById('historyFilterAll').className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors';
            document.getElementById('historyFilterGroup').className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors';
            document.getElementById('historyFilterIndividual').className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors';
            
            if (filter === 'all') {
                document.getElementById('historyFilterAll').className = 'px-4 py-2 rounded-lg bg-blue-500 text-white transition-colors';
            } else if (filter === 'group') {
                document.getElementById('historyFilterGroup').className = 'px-4 py-2 rounded-lg bg-blue-500 text-white transition-colors';
            } else if (filter === 'individual') {
                document.getElementById('historyFilterIndividual').className = 'px-4 py-2 rounded-lg bg-blue-500 text-white transition-colors';
            }
            
            updateScoreHistory();
        }

        function updateScoreHistory() {
            let filteredHistory = scoreHistory;
            
            // 按類型篩選
            if (currentHistoryFilter === 'group') {
                filteredHistory = filteredHistory.filter(record => record.type === 'group');
            } else if (currentHistoryFilter === 'individual') {
                filteredHistory = filteredHistory.filter(record => record.type === 'individual');
            }
            
            // 按學生篩選
            if (currentStudentFilter) {
                filteredHistory = filteredHistory.filter(record => {
                    if (record.type === 'individual') {
                        return record.targetId == currentStudentFilter;
                    } else {
                        return record.affectedStudents.some(student => student.id == currentStudentFilter);
                    }
                });
            }
            
            // 更新統計資訊
            updateScoreStatistics(filteredHistory);
            
            // 更新記錄列表
            const container = document.getElementById('scoreHistoryList');
            
            if (filteredHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">📊</div>
                        <p>尚無分數變化記錄</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredHistory.map(record => {
                const isPositive = record.scoreChange > 0;
                const typeIcon = record.type === 'group' ? '👥' : '🌟';
                const scoreIcon = isPositive ? '➕' : '➖';
                const scoreColor = isPositive ? 'text-green-600' : 'text-red-600';
                const bgColor = isPositive ? 'bg-green-50' : 'bg-red-50';
                
                return `
                    <div class="border border-gray-200 rounded-xl p-4 ${bgColor}">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center space-x-3">
                                <div class="text-2xl">${typeIcon}</div>
                                <div>
                                    <div class="font-semibold text-gray-800">${record.targetName}</div>
                                    <div class="text-sm text-gray-600">${record.reason}</div>
                                    ${record.groupName ? `<div class="text-xs text-gray-500">${record.groupName}</div>` : ''}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="flex items-center space-x-2">
                                    <span class="text-2xl ${scoreColor} font-bold">${scoreIcon} ${Math.abs(record.scoreChange)}</span>

                                </div>
                                <div class="text-xs text-gray-500 mt-1">${record.date}</div>
                            </div>
                        </div>
                        
                        <!-- 受影響的學生 -->
                        <div class="mt-3 pt-3 border-t border-gray-300">
                            <div class="text-sm text-gray-600 mb-2">受影響學生：</div>
                            <div class="flex flex-wrap gap-2">
                                ${record.affectedStudents.map(student => `
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs ${isPositive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${student.name} (${scoreIcon}${Math.abs(student.scoreChange)})
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateScoreStatistics(filteredHistory) {
            const totalRecords = filteredHistory.length;
            const positiveRecords = filteredHistory.filter(record => record.scoreChange > 0).length;
            const negativeRecords = filteredHistory.filter(record => record.scoreChange < 0).length;
            
            // 計算今日記錄
            const today = new Date().toLocaleDateString('zh-TW');
            const todayRecords = filteredHistory.filter(record => record.date.includes(today)).length;
            
            document.getElementById('totalRecords').textContent = totalRecords;
            document.getElementById('totalPositive').textContent = positiveRecords;
            document.getElementById('totalNegative').textContent = negativeRecords;
            document.getElementById('todayRecords').textContent = todayRecords;
        }


        // 學生分數變化記錄功能

        function updateStudentScoreHistory(studentId) {
            const container = document.getElementById('studentHistoryList');
            
            // 篩選該學生相關的分數記錄
            let studentHistory = scoreHistory.filter(record => {
                // 個人加分記錄
                if (record.type === 'individual' && record.targetId == studentId) {
                    return true;
                }
                // 小組加分記錄（影響到該學生）
                if (record.type === 'group' && record.affectedStudents.some(s => s.id == studentId)) {
                    return true;
                }
                // 搶分活動記錄
                if (record.type === 'quiz' && record.targetId == studentId) {
                    return true;
                }
                // 獎品兌換記錄
                if (record.type === 'exchange' && record.targetId == studentId) {
                    return true;
                }
                return false;
            });
            
            // 按時間排序，最新的在前面
            studentHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // 只顯示最近10筆記錄
            studentHistory = studentHistory.slice(0, 10);
            
            if (studentHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <div class="text-2xl mb-1">📊</div>
                        <p class="text-sm">尚無分數變化記錄</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = studentHistory.map(record => {
                const isPositive = record.scoreChange > 0;
                const scoreIcon = isPositive ? '➕' : '➖';
                const scoreColor = isPositive ? 'text-green-600' : 'text-red-600';
                const bgColor = isPositive ? 'bg-green-50' : 'bg-red-50';
                
                // 獲取該學生在此記錄中的分數變化
                let studentScoreChange = record.scoreChange;
                if (record.type === 'group') {
                    const affectedStudent = record.affectedStudents.find(s => s.id == studentId);
                    if (affectedStudent) {
                        studentScoreChange = affectedStudent.scoreChange;
                    }
                }
                
                // 根據記錄類型設置圖示和描述
                let typeIcon, typeDescription;
                switch (record.type) {
                    case 'individual':
                        typeIcon = '🌟';
                        typeDescription = '個人';
                        break;
                    case 'group':
                        typeIcon = '👥';
                        typeDescription = '小組';
                        break;
                    case 'quiz':
                        typeIcon = '⚡';
                        typeDescription = '搶分';
                        break;
                    case 'exchange':
                        typeIcon = '🎁';
                        typeDescription = '兌換';
                        break;
                    default:
                        typeIcon = '📝';
                        typeDescription = '其他';
                }
                
                return `
                    <div class="border border-gray-200 rounded-lg p-3 ${bgColor}">
                        <div class="flex justify-between items-start">
                            <div class="flex items-start space-x-2">
                                <div class="text-lg">${typeIcon}</div>
                                <div class="flex-1">
                                    <div class="text-sm font-medium text-gray-800">${record.reason}</div>
                                    <div class="text-xs text-gray-600 mt-1">
                                        <span class="inline-block px-2 py-1 rounded-full bg-gray-100 text-gray-600">${typeDescription}</span>
                                        <span class="ml-2">${record.date}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="flex items-center space-x-1">
                                    <span class="text-lg ${scoreColor} font-bold">${scoreIcon}</span>
                                    <span class="text-lg ${scoreColor} font-bold">${Math.abs(studentScoreChange)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 學生獎品兌換功能
        function showRewardExchange() {
            if (currentUser !== 'student' || !currentStudent) return;
            
            document.getElementById('rewardExchangeModal').classList.remove('hidden');
            document.getElementById('currentStudentPoints').textContent = currentStudent.score;
            updateStudentRewardsList();
        }

        function closeRewardExchangeModal() {
            document.getElementById('rewardExchangeModal').classList.add('hidden');
            hideExchangeHistory(); // 確保關閉時回到獎品列表
        }

        function showExchangeHistory() {
            document.getElementById('rewardsList').classList.add('hidden');
            document.getElementById('studentPointsDisplay').classList.add('hidden');
            document.getElementById('exchangeHistorySection').classList.remove('hidden');
            updateStudentExchangeHistory();
        }

        function hideExchangeHistory() {
            document.getElementById('exchangeHistorySection').classList.add('hidden');
            document.getElementById('rewardsList').classList.remove('hidden');
            document.getElementById('studentPointsDisplay').classList.remove('hidden');
        }

        function updateStudentExchangeHistory() {
            if (currentUser !== 'student' || !currentStudent) return;
            
            const container = document.getElementById('studentExchangeHistory');
            // filter by studentId as strings
            const studentRequests = exchangeRequests.filter(req => String(req.studentId) === String(currentStudent.id));
            
            if (studentRequests.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">📋</div>
                        <p>尚無兌換記錄</p>
                    </div>
                `;
                return;
            }

            // 按時間排序，最新的在前面
            const sortedRequests = studentRequests.sort((a, b) => new Date(b.requestDate) - new Date(a.requestDate));

            container.innerHTML = sortedRequests.map(request => {
                let statusClass, statusIcon, statusText, statusBg;
                
                switch (request.status) {
                    case 'pending':
                        statusClass = 'text-yellow-700';
                        statusBg = 'bg-yellow-100';
                        statusIcon = '⏳';
                        statusText = '審核中';
                        break;
                    case 'approved':
                        statusClass = 'text-green-700';
                        statusBg = 'bg-green-100';
                        statusIcon = '✅';
                        statusText = '已同意';
                        break;
                    case 'rejected':
                        statusClass = 'text-red-700';
                        statusBg = 'bg-red-100';
                        statusIcon = '❌';
                        statusText = '已拒絕';
                        break;
                    default:
                        statusClass = 'text-gray-700';
                        statusBg = 'bg-gray-100';
                        statusIcon = '❓';
                        statusText = '未知';
                }

                return `
                    <div class="bg-white rounded-xl p-4 border border-gray-200">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-semibold text-gray-800">${request.rewardName}</h4>
                                <div class="text-sm text-gray-600">申請時間：${request.requestDate}</div>
                                ${request.approveDate ? `<div class="text-sm text-gray-600">處理時間：${request.approveDate}</div>` : ''}
                                ${request.rejectDate ? `<div class="text-sm text-gray-600">處理時間：${request.rejectDate}</div>` : ''}
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold text-blue-600">${request.points} 點</div>
                                <div class="flex items-center space-x-1 text-sm px-2 py-1 rounded-full ${statusBg} ${statusClass}">
                                    <span>${statusIcon}</span>
                                    <span>${statusText}</span>
                                </div>
                            </div>
                        </div>
                        
                        ${request.status === 'approved' ? `
                            <div class="mt-3 p-3 bg-green-50 rounded-lg">
                                <div class="text-sm text-green-800">🎉 恭喜！您的兌換申請已通過，請向老師領取獎品。</div>
                            </div>
                        ` : ''}
                        
                        ${request.status === 'rejected' ? `
                            <div class="mt-3 p-3 bg-red-50 rounded-lg">
                                <div class="text-sm text-red-800">😔 很抱歉，您的兌換申請未通過審核。</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function updateStudentRewardsList() {
            const container = document.getElementById('rewardsList');
            
            if (rewards.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8 col-span-full">
                        <div class="text-4xl mb-2">🎁</div>
                        <p>尚無可兌換獎品</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = rewards.map(reward => {
                const canAfford = currentStudent.score >= reward.points;
                const isOutOfStock = reward.quantity <= 0;
                
                // 檢查是否有待審核的申請（將 ID 轉為字串比較）
                const pendingRequest = exchangeRequests.find(req => 
                    String(req.studentId) === String(currentStudent.id) &&
                    String(req.rewardId) === String(reward.id) &&
                    req.status === 'pending'
                );

                let buttonClass, buttonText, buttonDisabled;
                
                if (pendingRequest) {
                    buttonClass = 'bg-yellow-500 text-white cursor-not-allowed';
                    buttonText = '審核中';
                    buttonDisabled = true;
                } else if (isOutOfStock) {
                    buttonClass = 'bg-orange-400 text-white cursor-not-allowed';
                    buttonText = '補貨中';
                    buttonDisabled = true;
                } else if (!canAfford) {
                    buttonClass = 'bg-gray-300 text-gray-500 cursor-not-allowed';
                    buttonText = '點數不足';
                    buttonDisabled = true;
                } else {
                    buttonClass = 'bg-green-500 hover:bg-green-600 text-white';
                    buttonText = '申請兌換';
                    buttonDisabled = false;
                }
                
                return `
                    <div class="bg-white rounded-xl p-4 border border-gray-200 card-shadow ${isOutOfStock ? 'opacity-75' : ''}">
                        ${reward.image ? `
                            <div class="mb-4 relative">
                                <img src="${reward.image}" alt="${reward.name}" class="w-full h-32 object-cover rounded-lg ${isOutOfStock ? 'grayscale' : ''}">
                                ${isOutOfStock ? '<div class="absolute inset-0 bg-black bg-opacity-30 rounded-lg flex items-center justify-center"><span class="text-white font-bold">缺貨</span></div>' : ''}
                            </div>
                        ` : `
                            <div class="mb-4 bg-gray-100 rounded-lg h-32 flex items-center justify-center relative ${isOutOfStock ? 'bg-gray-200' : ''}">
                                <div class="text-4xl ${isOutOfStock ? 'grayscale' : ''}">🎁</div>
                                ${isOutOfStock ? '<div class="absolute inset-0 bg-black bg-opacity-30 rounded-lg flex items-center justify-center"><span class="text-white font-bold">缺貨</span></div>' : ''}
                            </div>
                        `}
                        
                        <h3 class="font-semibold text-gray-800 mb-2">${reward.name}</h3>
                        <p class="text-sm text-gray-600 mb-3">${reward.description || '暫無描述'}</p>
                        
                        <div class="flex items-center justify-between mb-3">
                            <div class="text-lg font-bold text-blue-600">${reward.points} 點</div>
                            <div class="text-sm ${isOutOfStock ? 'text-red-500 font-semibold' : 'text-gray-500'}">
                                剩餘 ${reward.quantity} 個
                            </div>
                        </div>
                        
                        <button onclick="requestExchange('${reward.id}')" 
                                ${buttonDisabled ? 'disabled' : ''} 
                                class="w-full py-2 px-4 rounded-lg transition-colors ${buttonClass}">
                            ${buttonText}
                        </button>
                    </div>
                `;
            }).join('');
        }

        function requestExchange(rewardId) {
            if (currentUser !== 'student' || !currentStudent) return;
            
            // 以字串比較，避免 ID 型別不一致
            const reward = rewards.find(r => String(r.id) === String(rewardId));
            if (!reward || reward.quantity <= 0 || currentStudent.score < reward.points) {
                alert('無法兌換此獎品');
                return;
            }

            // 檢查是否已有待審核的申請
            // 檢查是否已有待審核的申請，ID 比對改為字串
            const existingRequest = exchangeRequests.find(req => 
                String(req.studentId) === String(currentStudent.id) && 
                String(req.rewardId) === String(rewardId) && 
                req.status === 'pending'
            );

            if (existingRequest) {
                alert('您已申請兌換此獎品，請等待老師審核');
                return;
            }

            if (confirm(`確定要申請兌換「${reward.name}」嗎？\n需要 ${reward.points} 點數`)) {
                const request = {
                    id: Date.now(),
                    studentId: currentStudent.id,
                    studentName: currentStudent.name,
                    groupName: currentStudent.groupName,
                    rewardId: reward.id,
                    rewardName: reward.name,
                    points: reward.points,
                    status: 'pending',
                    requestDate: new Date().toLocaleString('zh-TW')
                };

                exchangeRequests.push(request);
                google.script.run.setStorage('exchangeRequests', exchangeRequests);
                
                alert('兌換申請已提交，請等待老師審核');
                updateStudentRewardsList(); // 重新整理列表以顯示審核中狀態
            }
        }

        // 教師獎品管理功能
        function showAddRewardForm() {
            document.getElementById('addRewardForm').classList.remove('hidden');
            document.getElementById('editRewardForm').classList.add('hidden');
            document.getElementById('exchangeRequestsSection').classList.add('hidden');
        }

        function hideAddRewardForm() {
            document.getElementById('addRewardForm').classList.add('hidden');
            clearAddRewardForm();
        }

        function clearAddRewardForm() {
            document.getElementById('rewardName').value = '';
            document.getElementById('rewardPoints').value = '';
            document.getElementById('rewardQuantity').value = '';
            document.getElementById('rewardDescription').value = '';
            document.getElementById('rewardImage').value = '';
        }

        function addReward() {
            const name = document.getElementById('rewardName').value.trim();
            const points = parseInt(document.getElementById('rewardPoints').value);
            const quantity = parseInt(document.getElementById('rewardQuantity').value);
            const description = document.getElementById('rewardDescription').value.trim();
            const imageFile = document.getElementById('rewardImage').files[0];

            if (!name || !points || !quantity) {
                alert('請填寫所有必要欄位');
                return;
            }

            const reward = {
                id: Date.now(),
                name: name,
                points: points,
                quantity: quantity,
                description: description,
                image: null
            };

            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    reward.image = e.target.result;
                    rewards.push(reward);
                    google.script.run.setStorage('rewards', rewards);
                    hideAddRewardForm();
                    updateRewardManageList();
                    alert('獎品新增成功！');
                };
                reader.readAsDataURL(imageFile);
            } else {
                rewards.push(reward);
                google.script.run.setStorage('rewards', rewards);
                hideAddRewardForm();
                updateRewardManageList();
                alert('獎品新增成功！');
            }
        }

        function updateRewardManageList() {
            const container = document.getElementById('rewardManageList');
            
            if (rewards.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8 col-span-full">
                        <div class="text-4xl mb-2">🎁</div>
                        <p>尚無獎品</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = rewards.map(reward => `
                <div class="bg-white rounded-xl p-4 border border-gray-200 card-shadow">
                    ${reward.image ? `
                        <div class="mb-4">
                            <img src="${reward.image}" alt="${reward.name}" class="w-full h-32 object-cover rounded-lg">
                        </div>
                    ` : `
                        <div class="mb-4 bg-gray-100 rounded-lg h-32 flex items-center justify-center">
                            <div class="text-4xl">🎁</div>
                        </div>
                    `}
                    
                    <h3 class="font-semibold text-gray-800 mb-2">${reward.name}</h3>
                    <p class="text-sm text-gray-600 mb-3">${reward.description || '暫無描述'}</p>
                    
                    <div class="grid grid-cols-2 gap-2 mb-3 text-sm">
                        <div class="text-center bg-blue-50 rounded-lg p-2">
                            <div class="font-bold text-blue-600">${reward.points}</div>
                            <div class="text-gray-600">所需點數</div>
                        </div>
                        <div class="text-center bg-green-50 rounded-lg p-2">
                            <div class="font-bold text-green-600">${reward.quantity}</div>
                            <div class="text-gray-600">剩餘數量</div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button onclick="editReward('${reward.id}')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-3 rounded-lg transition-colors text-sm">
                            編輯
                        </button>
                        <button onclick="deleteReward('${reward.id}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded-lg transition-colors text-sm">
                            刪除
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function editReward(rewardId) {
            // 以字串比較，避免 ID 型別不一致
            const reward = rewards.find(r => String(r.id) === String(rewardId));
            if (!reward) return;

            document.getElementById('editRewardId').value = reward.id;
            document.getElementById('editRewardName').value = reward.name;
            document.getElementById('editRewardPoints').value = reward.points;
            document.getElementById('editRewardQuantity').value = reward.quantity;
            document.getElementById('editRewardDescription').value = reward.description || '';

            document.getElementById('addRewardForm').classList.add('hidden');
            document.getElementById('editRewardForm').classList.remove('hidden');
            document.getElementById('exchangeRequestsSection').classList.add('hidden');
        }

        function hideEditRewardForm() {
            document.getElementById('editRewardForm').classList.add('hidden');
        }

        function updateReward() {
            // 直接使用字串形式的 rewardId，避免型別不一致
            const rewardId = document.getElementById('editRewardId').value;
            const name = document.getElementById('editRewardName').value.trim();
            const points = parseInt(document.getElementById('editRewardPoints').value);
            const quantity = parseInt(document.getElementById('editRewardQuantity').value);
            const description = document.getElementById('editRewardDescription').value.trim();
            const imageFile = document.getElementById('editRewardImage').files[0];

            if (!name || !points || quantity < 0) {
                alert('請填寫所有必要欄位');
                return;
            }

            // 用字串比較尋找對應獎品
            const reward = rewards.find(r => String(r.id) === String(rewardId));
            if (!reward) return;

            reward.name = name;
            reward.points = points;
            reward.quantity = quantity;
            reward.description = description;

            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    reward.image = e.target.result;
                    google.script.run.setStorage('rewards', rewards);
                    hideEditRewardForm();
                    updateRewardManageList();
                    alert('獎品更新成功！');
                };
                reader.readAsDataURL(imageFile);
            } else {
                google.script.run.setStorage('rewards', rewards);
                hideEditRewardForm();
                updateRewardManageList();
                alert('獎品更新成功！');
            }
        }

        function deleteReward(rewardId) {
            if (confirm('確定要刪除這個獎品嗎？')) {
                // 用字串比較避免類型不一致
                rewards = rewards.filter(r => String(r.id) !== String(rewardId));
                google.script.run.setStorage('rewards', rewards);
                updateRewardManageList();
                alert('獎品已刪除！');
            }
        }

        function showExchangeRequests() {
            document.getElementById('addRewardForm').classList.add('hidden');
            document.getElementById('editRewardForm').classList.add('hidden');
            document.getElementById('exchangeRequestsSection').classList.remove('hidden');
            document.getElementById('teacherExchangeHistorySection').classList.add('hidden');
            updateExchangeRequests();
        }

        function showTeacherExchangeHistory() {
            document.getElementById('addRewardForm').classList.add('hidden');
            document.getElementById('editRewardForm').classList.add('hidden');
            document.getElementById('exchangeRequestsSection').classList.add('hidden');
            document.getElementById('teacherExchangeHistorySection').classList.remove('hidden');
            updateTeacherExchangeHistoryFilters();
            updateTeacherExchangeHistory();
        }

        function updateTeacherExchangeHistoryFilters() {
            const studentFilter = document.getElementById('exchangeStudentFilter');
            studentFilter.innerHTML = '<option value="">所有學生</option>';
            
            // 獲取所有有兌換記錄的學生
            const studentsWithExchange = [...new Set(exchangeRequests.map(req => req.studentId))];
            studentsWithExchange.forEach(studentId => {
                // 用字串比較避免類型不一致
                const student = students.find(s => String(s.id) === String(studentId));
                if (student) {
                    studentFilter.innerHTML += `<option value="${student.id}">${student.name} (${student.groupName})</option>`;
                }
            });
            
            // 添加事件監聽器
            document.getElementById('exchangeStatusFilter').addEventListener('change', updateTeacherExchangeHistory);
            document.getElementById('exchangeStudentFilter').addEventListener('change', updateTeacherExchangeHistory);
        }

        function updateTeacherExchangeHistory() {
            const container = document.getElementById('teacherExchangeHistoryList');
            const statusFilter = document.getElementById('exchangeStatusFilter').value;
            const studentFilter = document.getElementById('exchangeStudentFilter').value;
            
            let filteredRequests = [...exchangeRequests];
            
            // 按狀態篩選
            if (statusFilter) {
                filteredRequests = filteredRequests.filter(req => req.status === statusFilter);
            }
            
            // 按學生篩選
            if (studentFilter) {
                filteredRequests = filteredRequests.filter(req => req.studentId == studentFilter);
            }
            
            // 按時間排序，最新的在前面
            filteredRequests.sort((a, b) => new Date(b.requestDate) - new Date(a.requestDate));
            
            if (filteredRequests.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">📊</div>
                        <p>尚無兌換記錄</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredRequests.map(request => {
                let statusClass, statusIcon, statusText, statusBg;
                
                switch (request.status) {
                    case 'pending':
                        statusClass = 'text-yellow-700';
                        statusBg = 'bg-yellow-100';
                        statusIcon = '⏳';
                        statusText = '審核中';
                        break;
                    case 'approved':
                        statusClass = 'text-green-700';
                        statusBg = 'bg-green-100';
                        statusIcon = '✅';
                        statusText = '已同意';
                        break;
                    case 'rejected':
                        statusClass = 'text-red-700';
                        statusBg = 'bg-red-100';
                        statusIcon = '❌';
                        statusText = '已拒絕';
                        break;
                    default:
                        statusClass = 'text-gray-700';
                        statusBg = 'bg-gray-100';
                        statusIcon = '❓';
                        statusText = '未知';
                }

                return `
                    <div class="bg-white rounded-xl p-4 border border-gray-200">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="font-semibold text-gray-800">${request.studentName}</div>
                                <div class="text-sm text-gray-600">${request.groupName}</div>
                                <div class="text-xs text-gray-500">申請時間：${request.requestDate}</div>
                                ${request.approveDate ? `<div class="text-xs text-gray-500">同意時間：${request.approveDate}</div>` : ''}
                                ${request.rejectDate ? `<div class="text-xs text-gray-500">拒絕時間：${request.rejectDate}</div>` : ''}
                            </div>
                            <div class="text-right">
                                <div class="font-semibold text-blue-600 mb-1">${request.rewardName}</div>
                                <div class="text-sm text-gray-600 mb-2">${request.points} 點數</div>
                                <div class="flex items-center space-x-1 text-sm px-2 py-1 rounded-full ${statusBg} ${statusClass}">
                                    <span>${statusIcon}</span>
                                    <span>${statusText}</span>
                                </div>
                            </div>
                        </div>
                        
                        ${request.status === 'pending' ? `
                            <div class="flex space-x-2 mt-3 pt-3 border-t border-gray-200">
                                <button onclick="approveExchange('${request.id}')" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg transition-colors text-sm">
                                    同意兌換
                                </button>
                                <button onclick="rejectExchange('${request.id}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg transition-colors text-sm">
                                    拒絕兌換
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function updateExchangeRequests() {
            const container = document.getElementById('exchangeRequestsList');
            const pendingRequests = exchangeRequests.filter(req => req.status === 'pending');
            
            if (pendingRequests.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">📋</div>
                        <p>尚無待處理申請</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = pendingRequests.map(request => `
                <div class="bg-white rounded-xl p-4 border border-gray-200">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="font-semibold text-gray-800">${request.studentName}</div>
                            <div class="text-sm text-gray-600">${request.groupName}</div>
                            <div class="text-xs text-gray-500">${request.requestDate}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold text-blue-600">${request.rewardName}</div>
                            <div class="text-sm text-gray-600">${request.points} 點數</div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button onclick="approveExchange('${request.id}')" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg transition-colors">
                            同意兌換
                        </button>
                        <button onclick="rejectExchange('${request.id}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg transition-colors">
                            拒絕兌換
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function approveExchange(requestId) {
            // 根據 requestId 找申請；轉為字串比較
            const request = exchangeRequests.find(req => String(req.id) === String(requestId));
            if (!request || request.status !== 'pending') return;

            // 找學生與獎品時用字串比較 ID，避免類型不一致
            const student = students.find(s => String(s.id) === String(request.studentId));
            const reward = rewards.find(r => String(r.id) === String(request.rewardId));

            if (!student || !reward) {
                alert('找不到學生或獎品資料');
                return;
            }

            if (student.score < request.points) {
                alert('學生點數不足');
                return;
            }

            if (reward.quantity <= 0) {
                alert('獎品數量不足');
                return;
            }

            if (confirm(`確定同意 ${request.studentName} 兌換「${request.rewardName}」嗎？`)) {
                // 扣除學生點數
                student.score -= request.points;
                
                // 減少獎品數量
                reward.quantity -= 1;
                
                // 更新申請狀態
                request.status = 'approved';
                request.approveDate = new Date().toLocaleString('zh-TW');

                // 記錄分數變化
                const historyRecord = {
                    id: Date.now(),
                    type: 'exchange',
                    targetId: student.id,
                    targetName: student.name,
                    groupName: student.groupName,
                    scoreChange: -request.points,
                    reason: `兌換獎品：${request.rewardName}`,
                    date: new Date().toLocaleString('zh-TW'),
                    affectedStudents: [{
                        id: student.id,
                        name: student.name,
                        scoreChange: -request.points
                    }]
                };

                scoreHistory.unshift(historyRecord);

                // 保存資料
                google.script.run.setStorage('students', students);
                google.script.run.setStorage('rewards', rewards);
                google.script.run.setStorage('exchangeRequests', exchangeRequests);
                google.script.run.setStorage('scoreHistory', scoreHistory);

                updateExchangeRequests();
                updateRewardManageList();
                updateRankings();
                updateTeacherExchangeHistory(); // 更新老師兌換記錄
                alert('兌換申請已同意！');
            }
        }

        function rejectExchange(requestId) {
            // 以字串比較 ID 來尋找申請
            const request = exchangeRequests.find(req => String(req.id) === String(requestId));
            if (!request || request.status !== 'pending') return;

            if (confirm(`確定拒絕 ${request.studentName} 的兌換申請嗎？`)) {
                request.status = 'rejected';
                request.rejectDate = new Date().toLocaleString('zh-TW');

                google.script.run.setStorage('exchangeRequests', exchangeRequests);
                updateExchangeRequests();
                updateTeacherExchangeHistory(); // 更新老師兌換記錄
                alert('兌換申請已拒絕！');
            }
        }

        // 搶分功能相關函數
        function showStudentQuiz() {
            if (currentUser !== 'student') return;
            
            document.getElementById('studentQuizModal').classList.remove('hidden');
            updateStudentQuizList();
            checkQuizCountdown();
        }

        function closeStudentQuizModal() {
            document.getElementById('studentQuizModal').classList.add('hidden');
            if (quizCountdown) {
                clearInterval(quizCountdown);
                quizCountdown = null;
            }
        }

        function updateStudentQuizList() {
            const container = document.getElementById('studentQuizList');
            const now = new Date();
            
            // 篩選可參與的搶分活動
            const availableQuizzes = quizzes.filter(quiz => {
                if (quiz.status === 'ended') return false;
                if (quiz.startType === 'scheduled') {
                    const startTime = new Date(quiz.startDate + ' ' + quiz.startTime);
                    return startTime <= now;
                }
                return quiz.status === 'active';
            });
            
            if (availableQuizzes.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">⚡</div>
                        <p>目前沒有搶分活動</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = availableQuizzes.map(quiz => {
                // 查找學生是否作答過此題目（用字串比較 quizId 與 studentId）
                const studentAnswer = quizAnswers.find(answer => 
                    String(answer.quizId) === String(quiz.id) && String(answer.studentId) === String(currentStudent.id)
                );
                
                const typeIcon = quiz.type === 'choice' ? '📝' : '💭';
                const typeText = quiz.type === 'choice' ? '選擇題' : '問答題';
                
                return `
                    <div class="bg-white rounded-xl p-6 border border-gray-200 card-shadow">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="text-2xl">${typeIcon}</span>
                                    <h3 class="text-xl font-bold text-gray-800">${quiz.title}</h3>
                                    <span class="text-sm px-2 py-1 rounded-full bg-blue-100 text-blue-700">${typeText}</span>
                                </div>
                                <div class="text-sm text-gray-600 mb-2">前 ${quiz.winners} 名可得分</div>
                                <div class="text-sm text-gray-500">
                                    ${quiz.startType === 'immediate' ? '立即開始' : `開始時間：${quiz.startDate} ${quiz.startTime}`}
                                </div>
                            </div>
                            <div class="text-right">
                                ${studentAnswer ? `
                                    <div class="text-${studentAnswer.isCorrect ? 'green' : 'red'}-600 font-semibold">
                                        ${studentAnswer.isCorrect ? '✅ 答對了' : '❌ 答錯了'}
                                        ${studentAnswer.rank ? ` (第${studentAnswer.rank}名)` : ''}
                                    </div>
                                ` : `
                                    <div class="text-red-600 font-semibold">⚡ 搶答中</div>
                                `}
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-4 mb-4">
                            <div class="font-semibold text-gray-800 mb-2">題目：</div>
                            <p class="text-gray-700 whitespace-pre-wrap">${quiz.question}</p>
                        </div>
                        
                        ${studentAnswer ? `
                            <div class="p-4 rounded-lg ${studentAnswer.isCorrect ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="font-semibold ${studentAnswer.isCorrect ? 'text-green-800' : 'text-red-800'}">
                                        您的答案：${studentAnswer.answer}
                                    </div>
                                    <div class="text-sm text-gray-500">${new Date(studentAnswer.submitTime).toLocaleString('zh-TW')}</div>
                                </div>
                                ${studentAnswer.isCorrect ? `
                                    <div class="text-sm text-green-700">
                                        🎉 恭喜答對！${studentAnswer.rank ? `獲得第${studentAnswer.rank}名，得到 ${studentAnswer.scoreAwarded} 分！` : ''}
                                    </div>
                                ` : `
                                    <div class="text-sm text-red-700">
                                        😔 答案錯誤，正確答案是：${quiz.answer}
                                    </div>
                                `}
                            </div>
                        ` : `
                            <!-- 作答區域 -->
                            <div class="border-t pt-4">
                                ${quiz.type === 'choice' ? `
                                    <div class="space-y-2 mb-4">
                                        ${Object.entries(quiz.choices).filter(([key, value]) => value).map(([key, value]) => `
                                            <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                                <input type="radio" name="quiz-${quiz.id}" value="${key}" class="text-blue-500">
                                                <span class="font-medium text-gray-700">${key}.</span>
                                                <span class="text-gray-700">${value}</span>
                                            </label>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <div class="mb-4">
                                        <textarea id="textAnswer-${quiz.id}" placeholder="請輸入您的答案..." rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500"></textarea>
                                    </div>
                                `}
                                <button onclick="submitQuizAnswer('${quiz.id}')" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 px-6 rounded-lg transition-colors font-semibold">
                                    🚀 提交答案
                                </button>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        function checkQuizCountdown() {
            // 每次檢查時都重新獲取當前時間
            const now = new Date();
            
            // 檢查預約的搶分活動是否到時間需要啟動
            quizzes.forEach(quiz => {
                if (quiz.startType === 'scheduled' && quiz.status === 'scheduled') {
                    const startTime = new Date(quiz.startDate + ' ' + quiz.startTime);
                    if (startTime <= now) {
                        // 時間到了，啟動搶分活動
                        quiz.status = 'active';
                        google.script.run.setStorage('quizzes', quizzes);
                    }
                }
            });
            
            const scheduledQuizzes = quizzes.filter(quiz => 
                quiz.startType === 'scheduled' && 
                quiz.status === 'scheduled' &&
                new Date(quiz.startDate + ' ' + quiz.startTime) > now
            );
            
            if (scheduledQuizzes.length === 0) {
                document.getElementById('quizCountdownSection').classList.add('hidden');
                if (quizCountdown) {
                    clearInterval(quizCountdown);
                    quizCountdown = null;
                }
                return;
            }
            
            // 找到最近的搶分活動
            const nextQuiz = scheduledQuizzes.sort((a, b) => 
                new Date(a.startDate + ' ' + a.startTime) - new Date(b.startDate + ' ' + b.startTime)
            )[0];
            
            document.getElementById('countdownQuizTitle').textContent = nextQuiz.title;
            document.getElementById('quizCountdownSection').classList.remove('hidden');
            
            // 開始倒數計時
            if (quizCountdown) clearInterval(quizCountdown);
            
            quizCountdown = setInterval(() => {
                // 每秒都重新獲取當前時間，確保時間準確
                const currentTime = new Date();
                const startTime = new Date(nextQuiz.startDate + ' ' + nextQuiz.startTime);
                const timeDiff = startTime - currentTime;
                
                if (timeDiff <= 0) {
                    // 時間到了，啟動搶分活動
                    nextQuiz.status = 'active';
                    google.script.run.setStorage('quizzes', quizzes);
                    
                    clearInterval(quizCountdown);
                    quizCountdown = null;
                    document.getElementById('quizCountdownSection').classList.add('hidden');
                    updateStudentQuizList();
                    return;
                }
                
                const hours = Math.floor(timeDiff / (1000 * 60 * 60));
                const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
                
                document.getElementById('countdownDisplay').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function submitQuizAnswer(quizId) {
            // 用字串比較查找對應的 quiz
            const quiz = quizzes.find(q => String(q.id) === String(quizId));
            if (!quiz || !currentStudent) return;

            // 檢查是否已經作答
            const hasAnswered = quizAnswers.some(answer =>
                String(answer.quizId) === String(quizId) && String(answer.studentId) === String(currentStudent.id)
            );
            if (hasAnswered) {
                alert('您已經作答過此題目');
                return;
            }

            // 取得使用者答案
            let userAnswer;
            if (quiz.type === 'choice') {
                const selectedOption = document.querySelector(`input[name="quiz-${quizId}"]:checked`);
                if (!selectedOption) {
                    alert('請選擇一個答案');
                    return;
                }
                userAnswer = selectedOption.value;
            } else {
                const textArea = document.getElementById(`textAnswer-${quizId}`);
                userAnswer = textArea.value.trim();
                if (!userAnswer) {
                    alert('請輸入答案');
                    return;
                }
            }

            const isCorrect = userAnswer === quiz.answer;

            // 準備答案物件，submitTime 使用 ISO 格式
            const answer = {
                id: Date.now(),
                quizId: quizId,
                studentId: currentStudent.id,
                studentName: currentStudent.name,
                groupName: currentStudent.groupName,
                answer: userAnswer,
                submitTime: new Date().toISOString(),
                isCorrect: isCorrect
            };

            // 從伺服器取得現有作答紀錄，再根據最新資料給分
            google.script.run.withSuccessHandler(function(serverAnswers) {
                if (isCorrect) {
                    const correctAnswers = (serverAnswers || []).filter(a =>
                        String(a.quizId) === String(quizId) && a.isCorrect
                    ).sort((a, b) => {
                        // 解析提交時間，若無法解析則視為最早
                        const parseTime = (t) => {
                            const d = new Date(t);
                            return isNaN(d) ? 0 : d.getTime();
                        };
                        return parseTime(a.submitTime) - parseTime(b.submitTime);
                    });
                    const rank = correctAnswers.length + 1;
                    if (rank <= quiz.winners) {
                        const scoreAwarded = Number(quiz.scores[rank]);
                        answer.rank = rank;
                        answer.scoreAwarded = scoreAwarded;
                        const student = students.find(s => String(s.id) === String(currentStudent.id));
                        if (student) {
                            // student 和 currentStudent 指向同一對象，只需加一次分數
                            student.score += scoreAwarded;
                            const historyRecord = {
                                id: Date.now() + Math.random(),
                                type: 'quiz',
                                targetId: student.id,
                                targetName: student.name,
                                groupName: student.groupName,
                                scoreChange: scoreAwarded,
                                reason: `搶分活動第${rank}名：${quiz.title}`,
                                date: new Date().toLocaleString('zh-TW'),
                                affectedStudents: [{
                                    id: student.id,
                                    name: student.name,
                                    scoreChange: scoreAwarded
                                }]
                            };
                            scoreHistory.unshift(historyRecord);
                            google.script.run.setStorage('students', students);
                            google.script.run.setStorage('scoreHistory', scoreHistory);
                            updateRankings();
                        }
                    }
                }
                // 將答案加入本地陣列並同步到後端
                quizAnswers.push(answer);
                google.script.run.setStorage('quizAnswers', quizAnswers);
                updateStudentQuizList();
            }).getStorage('quizAnswers');
        }

        // 教師搶分管理功能
        function showCreateQuizForm() {
            document.getElementById('createQuizForm').classList.remove('hidden');
            document.getElementById('quizHistorySection').classList.add('hidden');
            
            // 設定預設日期時間為當前時間的下一個小時
            const now = new Date();
            const nextHour = new Date(now);
            nextHour.setHours(nextHour.getHours() + 1);
            nextHour.setMinutes(0);
            nextHour.setSeconds(0);
            
            // 格式化日期和時間
            const year = nextHour.getFullYear();
            const month = String(nextHour.getMonth() + 1).padStart(2, '0');
            const day = String(nextHour.getDate()).padStart(2, '0');
            const hours = String(nextHour.getHours()).padStart(2, '0');
            const minutes = String(nextHour.getMinutes()).padStart(2, '0');
            
            document.getElementById('startDate').value = `${year}-${month}-${day}`;
            document.getElementById('startTime').value = `${hours}:${minutes}`;
            
            // 監聽題型變化
            document.getElementById('quizType').addEventListener('change', function() {
                const isChoice = this.value === 'choice';
                document.getElementById('choiceOptions').style.display = isChoice ? 'block' : 'none';
                document.getElementById('textAnswer').style.display = isChoice ? 'none' : 'block';
            });
            
            // 監聽前幾名變化
            document.getElementById('quizWinners').addEventListener('input', function() {
                updateScoreSettings(parseInt(this.value) || 1);
            });
            
            // 監聽開始時間類型變化
            document.querySelectorAll('input[name="startType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('scheduledTime').style.display = 
                        this.value === 'scheduled' ? 'block' : 'none';
                });
            });
            
            // 初始化得分設定
            updateScoreSettings(1);
        }

        function hideCreateQuizForm() {
            document.getElementById('createQuizForm').classList.add('hidden');
            clearQuizForm();
        }

        function clearQuizForm() {
            document.getElementById('quizType').value = 'choice';
            document.getElementById('quizWinners').value = '';
            document.getElementById('quizQuestion').value = '';
            document.getElementById('choiceA').value = '';
            document.getElementById('choiceB').value = '';
            document.getElementById('choiceC').value = '';
            document.getElementById('choiceD').value = '';
            document.getElementById('quizAnswer').value = '';
            document.querySelector('input[name="correctChoice"]:checked').checked = false;
            document.querySelector('input[name="startType"][value="immediate"]').checked = true;
            document.getElementById('scheduledTime').style.display = 'none';
            document.getElementById('choiceOptions').style.display = 'block';
            document.getElementById('textAnswer').style.display = 'none';
        }

        function updateScoreSettings(winners) {
            const container = document.getElementById('scoreSettings');
            container.innerHTML = '';
            
            for (let i = 1; i <= winners; i++) {
                container.innerHTML += `
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-600 w-16">第${i}名：</span>
                        <input type="number" id="score${i}" placeholder="分數" min="1" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                `;
            }
        }

        function createQuiz() {
            const type = document.getElementById('quizType').value;
            const winners = parseInt(document.getElementById('quizWinners').value);
            const question = document.getElementById('quizQuestion').value.trim();
            const startType = document.querySelector('input[name="startType"]:checked').value;
            
            if (!winners || !question) {
                alert('請填寫所有必要欄位');
                return;
            }
            
            if (winners < 1 || winners > 10) {
                alert('前幾名得分必須在 1-10 之間');
                return;
            }
            
            // 收集得分設定
            const scores = {};
            for (let i = 1; i <= winners; i++) {
                const score = parseInt(document.getElementById(`score${i}`).value);
                if (!score || score < 1) {
                    alert(`請設定第${i}名的分數`);
                    return;
                }
                scores[i] = score;
            }
            
            let answer, choices;
            
            if (type === 'choice') {
                // 選擇題
                const correctChoice = document.querySelector('input[name="correctChoice"]:checked');
                if (!correctChoice) {
                    alert('請選擇正確答案');
                    return;
                }
                
                choices = {
                    A: document.getElementById('choiceA').value.trim(),
                    B: document.getElementById('choiceB').value.trim(),
                    C: document.getElementById('choiceC').value.trim(),
                    D: document.getElementById('choiceD').value.trim()
                };
                
                // 檢查至少有兩個選項
                const filledChoices = Object.values(choices).filter(choice => choice);
                if (filledChoices.length < 2) {
                    alert('至少需要填寫兩個選項');
                    return;
                }
                
                answer = correctChoice.value;
            } else {
                // 問答題
                answer = document.getElementById('quizAnswer').value.trim();
                if (!answer) {
                    alert('請輸入標準答案');
                    return;
                }
            }
            
            let startDate, startTime;
            if (startType === 'scheduled') {
                startDate = document.getElementById('startDate').value;
                startTime = document.getElementById('startTime').value;
                
                if (!startDate || !startTime) {
                    alert('請設定開始日期和時間');
                    return;
                }
                
                const scheduledDateTime = new Date(startDate + ' ' + startTime);
                if (scheduledDateTime <= new Date()) {
                    alert('開始時間必須是未來時間');
                    return;
                }
            }
            
            const quiz = {
                id: Date.now(),
                title: `${type === 'choice' ? '選擇題' : '問答題'}搶分 - ${new Date().toLocaleString('zh-TW')}`,
                type: type,
                question: question,
                answer: answer,
                choices: choices,
                choiceA: (choices && choices.A) ? choices.A : '',
                choiceB: (choices && choices.B) ? choices.B : '',
                choiceC: (choices && choices.C) ? choices.C : '',
                choiceD: (choices && choices.D) ? choices.D : '',
                correct: (answer || ''),
                winners: winners,
                scores: scores,
                startType: startType,
                startDate: startDate,
                startTime: (startType === 'immediate' ? new Date().toISOString() : startTime),
                status: startType === 'immediate' ? 'active' : 'scheduled',
                createDate: new Date().toLocaleString('zh-TW'),
                endDate: null
            };
            
            quizzes.push(quiz);
            google.script.run.setStorage('quizzes', quizzes);
            
            hideCreateQuizForm();
            updateCurrentQuizList();
            alert('搶分活動建立成功！');
        }

        function updateCurrentQuizList() {
            const container = document.getElementById('currentQuizList');
            const activeQuizzes = quizzes.filter(quiz => quiz.status !== 'ended');
            
            if (activeQuizzes.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">⚡</div>
                        <p>尚無搶分活動</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = activeQuizzes.map(quiz => {
                const typeIcon = quiz.type === 'choice' ? '📝' : '💭';
                const typeText = quiz.type === 'choice' ? '選擇題' : '問答題';
                const statusText = quiz.status === 'active' ? '進行中' : '預約中';
                const statusColor = quiz.status === 'active' ? 'text-green-600' : 'text-yellow-600';
                
                // 統計作答情況
                // 用字串比較 quizId 避免類型不一致
                const totalAnswers = quizAnswers.filter(answer => String(answer.quizId) === String(quiz.id)).length;
                
                return `
                    <div class="bg-white rounded-xl p-6 border border-gray-200 card-shadow">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="text-2xl">${typeIcon}</span>
                                    <h3 class="text-xl font-bold text-gray-800">${quiz.title}</h3>
                                    <span class="text-sm px-2 py-1 rounded-full bg-blue-100 text-blue-700">${typeText}</span>
                                    <span class="text-sm px-2 py-1 rounded-full bg-gray-100 ${statusColor}">${statusText}</span>
                                </div>
                                <div class="text-sm text-gray-600 mb-2">前 ${quiz.winners} 名可得分 | 已有 ${totalAnswers} 人作答</div>
                                <div class="text-sm text-gray-500">
                                    建立時間：${quiz.createDate}
                                    ${quiz.startType === 'scheduled' ? ` | 開始時間：${quiz.startDate} ${quiz.startTime}` : ''}
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="viewQuizAnswers('${quiz.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg transition-colors text-sm">
                                    查看作答
                                </button>
                                <button onclick="endQuiz('${quiz.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg transition-colors text-sm">
                                    結束活動
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="font-semibold text-gray-800 mb-2">題目：</div>
                            <p class="text-gray-700 whitespace-pre-wrap">${quiz.question}</p>
                            
                            ${quiz.type === 'choice' ? `
                                <div class="mt-3">
                                    <div class="font-semibold text-gray-800 mb-1">選項：</div>
                                    ${Object.entries(quiz.choices).filter(([key, value]) => value).map(([key, value]) => 
                                        `<div class="text-sm ${key === quiz.answer ? 'text-green-600 font-semibold' : 'text-gray-600'}">
                                            ${key}. ${value} ${key === quiz.answer ? '(正確答案)' : ''}
                                        </div>`
                                    ).join('')}
                                </div>
                            ` : `
                                <div class="mt-3">
                                    <div class="font-semibold text-gray-800 mb-1">標準答案：</div>
                                    <div class="text-green-600 font-semibold">${quiz.answer}</div>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewQuizAnswers(quizId) {
            const quiz = quizzes.find(q => String(q.id) === String(quizId));
            if (!quiz) return;
            
            const answers = quizAnswers.filter(answer => String(answer.quizId) === String(quizId));
            
            if (answers.length === 0) {
                alert('尚無學生作答');
                return;
            }
            
            // 建立作答結果視窗
            let resultHTML = `搶分活動：${quiz.title}\n\n`;
            
            // 統計答對和答錯的學生
            const correctAnswers = answers.filter(answer => answer.isCorrect);
            const incorrectAnswers = answers.filter(answer => !answer.isCorrect);
            
            resultHTML += `總作答人數：${answers.length}\n`;
            resultHTML += `答對人數：${correctAnswers.length}\n`;
            resultHTML += `答錯人數：${incorrectAnswers.length}\n\n`;
            
            if (correctAnswers.length > 0) {
                resultHTML += '✅ 答對學生（按作答時間排序）：\n';
                correctAnswers
                    // 按提交時間排序，使用 submitTime 欄位
                    .sort((a, b) => new Date(a.submitTime) - new Date(b.submitTime))
                    .forEach((answer, index) => {
                        const rank = index + 1;
                        const scoreAwarded = answer.scoreAwarded || 0;
                        resultHTML += `${rank}. ${answer.studentName} (${answer.groupName}) - ${answer.answer}`;
                        if (rank <= quiz.winners && scoreAwarded > 0) {
                            resultHTML += ` [已得 ${scoreAwarded} 分]`;
                        }
                        // 將 ISO 時間轉為本地格式顯示
                        resultHTML += `\n   時間：${new Date(answer.submitTime).toLocaleString('zh-TW')}\n`;
                    });
                resultHTML += '\n';
            }
            
            if (incorrectAnswers.length > 0) {
                resultHTML += '❌ 答錯學生：\n';
                incorrectAnswers.forEach((answer, index) => {
                    resultHTML += `${index + 1}. ${answer.studentName} (${answer.groupName}) - ${answer.answer}\n`;
                    // 轉換 ISO 時間為本地格式
                    resultHTML += `   時間：${new Date(answer.submitTime).toLocaleString('zh-TW')}\n`;
                });
                resultHTML += '\n';
            }
            
            resultHTML += `正確答案：${quiz.answer}\n`;
            
            if (quiz.type === 'choice') {
                resultHTML += '\n選項：\n';
                Object.entries(quiz.choices).filter(([key, value]) => value).forEach(([key, value]) => {
                    resultHTML += `${key}. ${value}${key === quiz.answer ? ' (正確答案)' : ''}\n`;
                });
            }
            
            alert(resultHTML);
        }



        function endQuiz(quizId) {
            // 用字串比較找到對應的 quiz，避免 ID 型別不一致
            const quiz = quizzes.find(q => String(q.id) === String(quizId));
            if (!quiz) return;
            
            if (confirm(`確定要結束搶分活動「${quiz.title}」嗎？`)) {
                quiz.status = 'ended';
                quiz.endDate = new Date().toLocaleString('zh-TW');
                
                google.script.run.setStorage('quizzes', quizzes);
                updateCurrentQuizList();
                alert('搶分活動已結束！');
            }
        }

        function showQuizHistory() {
            document.getElementById('createQuizForm').classList.add('hidden');
            document.getElementById('quizHistorySection').classList.remove('hidden');
            updateQuizHistory();
        }

        function hideQuizHistory() {
            document.getElementById('quizHistorySection').classList.add('hidden');
        }

        function updateQuizHistory() {
            const container = document.getElementById('quizHistoryList');
            const endedQuizzes = quizzes.filter(quiz => quiz.status === 'ended');
            
            if (endedQuizzes.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">📊</div>
                        <p>尚無活動記錄</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = endedQuizzes.map(quiz => {
                const typeIcon = quiz.type === 'choice' ? '📝' : '💭';
                const typeText = quiz.type === 'choice' ? '選擇題' : '問答題';
                // 用字串比較 quizId 避免類型不一致
                const totalAnswers = quizAnswers.filter(answer => String(answer.quizId) === String(quiz.id)).length;
                
                return `
                    <div class="bg-white rounded-xl p-4 border border-gray-200">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="flex items-center space-x-2 mb-1">
                                    <span class="text-xl">${typeIcon}</span>
                                    <h4 class="font-semibold text-gray-800">${quiz.title}</h4>
                                    <span class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600">${typeText}</span>
                                </div>
                                <div class="text-sm text-gray-600">
                                    建立：${quiz.createDate} | 結束：${quiz.endDate}
                                </div>
                                <div class="text-sm text-gray-500">
                                    共 ${totalAnswers} 人參與 | 前 ${quiz.winners} 名得分
                                </div>
                            </div>
                            <button onclick="viewQuizAnswers('${quiz.id}')" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg transition-colors text-sm">
                                查看結果
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97680b49636e8097',t:'MTc1NjQyODUyMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
